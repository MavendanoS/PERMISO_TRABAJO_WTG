{
  "version": 3,
  "sources": ["../bundle-wIpu4e/checked-fetch.js", "../bundle-wIpu4e/strip-cf-connecting-ip-header.js", "../../../src/core/webapp/styles.js", "../../../src/core/webapp/script.js", "../../../src/core/webapp/template.js", "../../../src/core/config/security.js", "../../../src/core/errors.js", "../../../src/core/utils/headers.js", "../../../src/core/services/rateLimiter.js", "../../../src/core/services/authService.js", "../../../src/core/services/auditLogger.js", "../../../src/core/utils/sanitizers.js", "../../../src/core/utils/time.js", "../../../src/core/handlers/auth.js", "../../../src/core/handlers/users.js", "../../../src/core/handlers/catalog.js", "../../../src/core/handlers/matrix.js", "../../../src/core/handlers/pdf.js", "../../../src/core/handlers/permits.js", "../../../src/core/routes/api.js", "../../../src/index.js", "../../../node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "../../../node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-wIpu4e/middleware-insertion-facade.js", "../../../node_modules/wrangler/templates/middleware/common.ts", "../bundle-wIpu4e/middleware-loader.entry.ts"],
  "sourceRoot": "C:\\Users\\CL163284391\\Documents\\GitHub_Projects\\ptwind\\PERMISO_TRABAJO_WTG\\.wrangler\\tmp\\dev-nx8dnM",
  "sourcesContent": ["const urls = new Set();\r\n\r\nfunction checkURL(request, init) {\r\n\tconst url =\r\n\t\trequest instanceof URL\r\n\t\t\t? request\r\n\t\t\t: new URL(\r\n\t\t\t\t\t(typeof request === \"string\"\r\n\t\t\t\t\t\t? new Request(request, init)\r\n\t\t\t\t\t\t: request\r\n\t\t\t\t\t).url\r\n\t\t\t\t);\r\n\tif (url.port && url.port !== \"443\" && url.protocol === \"https:\") {\r\n\t\tif (!urls.has(url.toString())) {\r\n\t\t\turls.add(url.toString());\r\n\t\t\tconsole.warn(\r\n\t\t\t\t`WARNING: known issue with \\`fetch()\\` requests to custom HTTPS ports in published Workers:\\n` +\r\n\t\t\t\t\t` - ${url.toString()} - the custom port will be ignored when the Worker is published using the \\`wrangler deploy\\` command.\\n`\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nglobalThis.fetch = new Proxy(globalThis.fetch, {\r\n\tapply(target, thisArg, argArray) {\r\n\t\tconst [request, init] = argArray;\r\n\t\tcheckURL(request, init);\r\n\t\treturn Reflect.apply(target, thisArg, argArray);\r\n\t},\r\n});\r\n", "function stripCfConnectingIPHeader(input, init) {\r\n\tconst request = new Request(input, init);\r\n\trequest.headers.delete(\"CF-Connecting-IP\");\r\n\treturn request;\r\n}\r\n\r\nglobalThis.fetch = new Proxy(globalThis.fetch, {\r\n\tapply(target, thisArg, argArray) {\r\n\t\treturn Reflect.apply(target, thisArg, [\r\n\t\t\tstripCfConnectingIPHeader.apply(null, argArray),\r\n\t\t]);\r\n\t},\r\n});\r\n", "/**\r\n * Returns the CSS styles for the PT Worker web app.\r\n *\r\n * Note: This module currently contains a placeholder. Move the original\r\n * styles from worker.js into this function to maintain existing behavior.\r\n */\r\n\r\nexport function getStyles() {\r\n  return `\r\n    * {\r\n        margin: 0;\r\n        padding: 0;\r\n        box-sizing: border-box;\r\n    }\r\n    \r\n    :root {\r\n        --primary-color: #1a1f2e;\r\n        --secondary-color: #2c3e50;\r\n        --accent-color: #3498db;\r\n        --success-color: #27ae60;\r\n        --warning-color: #f39c12;\r\n        --danger-color: #e74c3c;\r\n        --text-primary: #2c3e50;\r\n        --text-secondary: #7f8c8d;\r\n        --text-light: #95a5a6;\r\n        --bg-primary: #ffffff;\r\n        --bg-secondary: #f8f9fa;\r\n        --bg-tertiary: #ecf0f1;\r\n        --border-color: #dfe6e9;\r\n        --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);\r\n        --shadow-md: 0 4px 12px rgba(0,0,0,0.12);\r\n        --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);\r\n        --radius-sm: 4px;\r\n        --radius-md: 6px;\r\n        --radius-lg: 8px;\r\n    }\r\n    \r\n    body {\r\n        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\r\n        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\r\n        min-height: 100vh;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        color: var(--text-primary);\r\n        line-height: 1.6;\r\n    }\r\n    \r\n    .container {\r\n        width: 100%;\r\n        max-width: 1400px;\r\n        margin: 0 auto;\r\n        padding: 20px;\r\n    }\r\n    \r\n    .login-container {\r\n        background: var(--bg-primary);\r\n        border-radius: var(--radius-lg);\r\n        box-shadow: var(--shadow-lg);\r\n        padding: 48px;\r\n        max-width: 420px;\r\n        margin: 0 auto;\r\n        border-top: 4px solid var(--primary-color);\r\n    }\r\n    \r\n    .app-container {\r\n        background: var(--bg-primary);\r\n        border-radius: var(--radius-lg);\r\n        box-shadow: var(--shadow-lg);\r\n        padding: 0;\r\n        display: none;\r\n        overflow: hidden;\r\n    }\r\n    \r\n    .logo {\r\n        text-align: center;\r\n        margin-bottom: 36px;\r\n    }\r\n    \r\n    .logo h1 {\r\n        color: var(--primary-color);\r\n        font-size: 24px;\r\n        font-weight: 700;\r\n        margin-bottom: 8px;\r\n        letter-spacing: -0.5px;\r\n    }\r\n    \r\n    .logo p {\r\n        color: var(--text-secondary);\r\n        font-size: 14px;\r\n        font-weight: 400;\r\n    }\r\n    \r\n    .form-group {\r\n        margin-bottom: 20px;\r\n    }\r\n    \r\n    .form-group label {\r\n        display: block;\r\n        margin-bottom: 8px;\r\n        font-weight: 500;\r\n        color: var(--text-primary);\r\n        font-size: 13px;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n    }\r\n    \r\n    .form-group input, \r\n    .form-group select, \r\n    .form-group textarea {\r\n        width: 100%;\r\n        padding: 10px 12px;\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        font-size: 14px;\r\n        transition: all 0.2s ease;\r\n        background: var(--bg-primary);\r\n        color: var(--text-primary);\r\n    }\r\n    \r\n    .form-group input:focus, \r\n    .form-group select:focus, \r\n    .form-group textarea:focus {\r\n        outline: none;\r\n        border-color: var(--accent-color);\r\n        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);\r\n    }\r\n    \r\n    .form-group textarea {\r\n        resize: vertical;\r\n        min-height: 80px;\r\n        font-family: inherit;\r\n    }\r\n    \r\n    .btn {\r\n        background: var(--primary-color);\r\n        color: white;\r\n        border: none;\r\n        padding: 12px 24px;\r\n        border-radius: var(--radius-md);\r\n        font-size: 14px;\r\n        font-weight: 600;\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n        width: 100%;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n    }\r\n    \r\n    .btn:hover:not(:disabled) {\r\n        background: var(--secondary-color);\r\n        transform: translateY(-1px);\r\n        box-shadow: var(--shadow-md);\r\n    }\r\n    \r\n    .btn:disabled {\r\n        opacity: 0.5;\r\n        cursor: not-allowed;\r\n    }\r\n    \r\n    .btn-secondary {\r\n        background: var(--secondary-color);\r\n    }\r\n    \r\n    .btn-secondary:hover:not(:disabled) {\r\n        background: var(--primary-color);\r\n    }\r\n    \r\n    .btn-danger {\r\n        background: var(--danger-color);\r\n    }\r\n    \r\n    .btn-danger:hover:not(:disabled) {\r\n        background: #c0392b;\r\n    }\r\n    \r\n    .btn-warning {\r\n        background: var(--warning-color);\r\n        color: white;\r\n    }\r\n    \r\n    .btn-warning:hover:not(:disabled) {\r\n        background: #d68910;\r\n    }\r\n    \r\n    .btn-small {\r\n        padding: 8px 16px;\r\n        font-size: 12px;\r\n        width: auto;\r\n    }\r\n    \r\n    .header {\r\n        background: var(--primary-color);\r\n        color: white;\r\n        padding: 24px 32px;\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n    }\r\n    \r\n    .header h1 {\r\n        font-size: 20px;\r\n        font-weight: 700;\r\n        margin-bottom: 4px;\r\n    }\r\n    \r\n    .header p {\r\n        font-size: 13px;\r\n        opacity: 0.9;\r\n    }\r\n    \r\n    .tabs {\r\n        background: var(--bg-secondary);\r\n        padding: 0;\r\n        display: flex;\r\n        border-bottom: 1px solid var(--border-color);\r\n    }\r\n    \r\n    .tab {\r\n        padding: 16px 24px;\r\n        background: transparent;\r\n        border: none;\r\n        border-bottom: 3px solid transparent;\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n        font-weight: 500;\r\n        font-size: 14px;\r\n        color: var(--text-secondary);\r\n    }\r\n    \r\n    .tab:hover {\r\n        background: var(--bg-tertiary);\r\n        color: var(--text-primary);\r\n    }\r\n    \r\n    .tab.active {\r\n        background: var(--bg-primary);\r\n        color: var(--primary-color);\r\n        border-bottom-color: var(--primary-color);\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .tab-content {\r\n        display: none;\r\n        padding: 32px;\r\n        background: var(--bg-primary);\r\n    }\r\n    \r\n    .tab-content.active {\r\n        display: block;\r\n    }\r\n    \r\n    .card {\r\n        background: var(--bg-primary);\r\n        border-radius: var(--radius-lg);\r\n        padding: 24px;\r\n        border: 1px solid var(--border-color);\r\n        box-shadow: var(--shadow-sm);\r\n    }\r\n    \r\n    .card h3 {\r\n        color: var(--primary-color);\r\n        font-size: 16px;\r\n        font-weight: 600;\r\n        margin-bottom: 20px;\r\n        padding-bottom: 12px;\r\n        border-bottom: 2px solid var(--bg-secondary);\r\n    }\r\n    \r\n    .grid-three {\r\n        display: grid;\r\n        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));\r\n        gap: 24px;\r\n    }\r\n    \r\n    .error {\r\n        background: rgba(231, 76, 60, 0.1);\r\n        color: var(--danger-color);\r\n        padding: 16px 20px;\r\n        border-radius: var(--radius-md);\r\n        margin-bottom: 20px;\r\n        border: 1px solid rgba(231, 76, 60, 0.2);\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .success {\r\n        background: rgba(39, 174, 96, 0.1);\r\n        color: var(--success-color);\r\n        padding: 16px 20px;\r\n        border-radius: var(--radius-md);\r\n        margin-bottom: 20px;\r\n        border: 1px solid rgba(39, 174, 96, 0.2);\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .loading {\r\n        text-align: center;\r\n        padding: 48px 24px;\r\n        color: var(--text-secondary);\r\n        font-style: italic;\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .status-indicator {\r\n        padding: 8px 16px;\r\n        border-radius: var(--radius-md);\r\n        font-size: 12px;\r\n        font-weight: 500;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n    }\r\n    \r\n    .status-online {\r\n        background: rgba(39, 174, 96, 0.1);\r\n        color: var(--success-color);\r\n        border: 1px solid rgba(39, 174, 96, 0.2);\r\n    }\r\n    \r\n    .status-offline {\r\n        background: rgba(231, 76, 60, 0.1);\r\n        color: var(--danger-color);\r\n        border: 1px solid rgba(231, 76, 60, 0.2);\r\n    }\r\n    \r\n    .checkbox-list {\r\n        max-height: 300px;\r\n        overflow-y: auto;\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        padding: 12px;\r\n        background: var(--bg-secondary);\r\n    }\r\n    \r\n    .checkbox-item {\r\n        display: flex;\r\n        align-items: center;\r\n        padding: 8px;\r\n        margin-bottom: 4px;\r\n        border-radius: var(--radius-sm);\r\n        transition: background 0.2s ease;\r\n    }\r\n    \r\n    .checkbox-item:hover {\r\n        background: var(--bg-tertiary);\r\n    }\r\n    \r\n    .checkbox-item input[type=\"checkbox\"] {\r\n        margin-right: 12px;\r\n        width: 16px;\r\n        height: 16px;\r\n        cursor: pointer;\r\n    }\r\n    \r\n    .checkbox-item label {\r\n        cursor: pointer;\r\n        font-size: 14px;\r\n        color: var(--text-primary);\r\n        flex: 1;\r\n    }\r\n    \r\n    .selector-dual {\r\n        display: grid;\r\n        grid-template-columns: 1fr auto 1fr;\r\n        gap: 20px;\r\n        align-items: center;\r\n    }\r\n    \r\n    .selector-list {\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        height: 300px;\r\n        overflow-y: auto;\r\n        background: var(--bg-secondary);\r\n    }\r\n    \r\n    .selector-item {\r\n        padding: 12px 16px;\r\n        border-bottom: 1px solid var(--border-color);\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .selector-item:hover {\r\n        background: var(--bg-tertiary);\r\n    }\r\n    \r\n    .selector-item.selected {\r\n        background: rgba(52, 152, 219, 0.1);\r\n        border-left: 3px solid var(--accent-color);\r\n    }\r\n    \r\n    .selector-controls {\r\n        display: flex;\r\n        flex-direction: column;\r\n        gap: 8px;\r\n    }\r\n    \r\n    .search-box {\r\n        display: flex;\r\n        gap: 12px;\r\n        margin-bottom: 24px;\r\n    }\r\n    \r\n    .search-input {\r\n        flex: 1;\r\n        padding: 10px 16px;\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .search-input:focus {\r\n        outline: none;\r\n        border-color: var(--accent-color);\r\n        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);\r\n    }\r\n    \r\n    .search-box {\r\n        display: grid;\r\n        grid-template-columns: 2fr 1fr 1fr 1fr auto;\r\n        gap: 12px;\r\n        align-items: center;\r\n    }\r\n    \r\n    .search-box input[type=\"date\"] {\r\n        color: var(--text-primary);\r\n    }\r\n    \r\n    .data-table {\r\n        width: 100%;\r\n        overflow-x: auto;\r\n    }\r\n    \r\n    .data-table table {\r\n        width: 100%;\r\n        border-collapse: collapse;\r\n    }\r\n    \r\n    .data-table th {\r\n        background: var(--bg-secondary);\r\n        padding: 12px;\r\n        text-align: left;\r\n        font-weight: 600;\r\n        font-size: 13px;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n        color: var(--text-secondary);\r\n        border-bottom: 2px solid var(--border-color);\r\n    }\r\n    \r\n    .data-table td {\r\n        padding: 12px;\r\n        border-bottom: 1px solid var(--border-color);\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .data-table tr:hover {\r\n        background: var(--bg-secondary);\r\n    }\r\n    \r\n    .permiso-card-container {\r\n        perspective: 1000px;\r\n        margin-bottom: 24px;\r\n        position: relative;\r\n        width: 100%;\r\n    }\r\n    \r\n    .permiso-card {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        min-height: 300px;\r\n        transition: all 0.6s ease;\r\n        transform-style: preserve-3d;\r\n        z-index: 1;\r\n    }\r\n    \r\n    .permiso-card.flipped {\r\n        transform: rotateY(180deg);\r\n        z-index: 10;\r\n        margin-bottom: 40px;\r\n    }\r\n    \r\n    .permiso-card-container.flipped-container {\r\n        z-index: 10;\r\n        margin-bottom: 60px;\r\n    }\r\n    \r\n    .permiso-card-inner {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        transform-style: preserve-3d;\r\n    }\r\n    \r\n    .permiso-card-front,\r\n    .permiso-card-back {\r\n        position: absolute;\r\n        width: 100%;\r\n        min-height: 300px;\r\n        backface-visibility: hidden;\r\n        background: var(--bg-primary);\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-lg);\r\n        padding: 20px;\r\n        box-shadow: var(--shadow-sm);\r\n    }\r\n    \r\n    .permiso-card-back {\r\n        transform: rotateY(180deg);\r\n        overflow-y: auto;\r\n        max-height: 600px;\r\n        box-shadow: var(--shadow-lg);\r\n        border: 2px solid var(--accent-color);\r\n    }\r\n    \r\n    .btn-flip {\r\n        background: var(--accent-color);\r\n        color: white;\r\n        border: none;\r\n        padding: 6px 12px;\r\n        border-radius: var(--radius-sm);\r\n        cursor: pointer;\r\n        font-size: 12px;\r\n        transition: all 0.2s ease;\r\n    }\r\n    \r\n    .btn-flip:hover {\r\n        background: var(--primary-color);\r\n        transform: translateX(-2px);\r\n    }\r\n    \r\n    .btn-info {\r\n        background: var(--accent-color);\r\n        color: white;\r\n    }\r\n    \r\n    .btn-info:hover {\r\n        background: var(--primary-color);\r\n    }\r\n    \r\n    /* Men\u00FA desplegable de exportaci\u00F3n */\r\n    .export-dropdown {\r\n        display: inline-block;\r\n        position: relative;\r\n    }\r\n    \r\n    .dropdown-toggle:after {\r\n        content: '';\r\n        display: none;\r\n    }\r\n    \r\n    .dropdown-menu {\r\n        position: absolute;\r\n        top: 100%;\r\n        left: 0;\r\n        z-index: 1000;\r\n        min-width: 160px;\r\n        background: white;\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        box-shadow: var(--shadow-lg);\r\n        margin-top: 2px;\r\n    }\r\n    \r\n    .dropdown-menu a {\r\n        display: block;\r\n        padding: 8px 12px;\r\n        text-decoration: none;\r\n        color: var(--text-primary);\r\n        font-size: 12px;\r\n        transition: all 0.2s ease;\r\n        border-bottom: 1px solid var(--border-color);\r\n    }\r\n    \r\n    .dropdown-menu a:last-child {\r\n        border-bottom: none;\r\n        border-radius: 0 0 var(--radius-md) var(--radius-md);\r\n    }\r\n    \r\n    .dropdown-menu a:first-child {\r\n        border-radius: var(--radius-md) var(--radius-md) 0 0;\r\n    }\r\n    \r\n    .dropdown-menu a:hover {\r\n        background: var(--bg-secondary);\r\n        color: var(--primary-color);\r\n        transform: translateX(2px);\r\n    }\r\n    \r\n    /* Pesta\u00F1as dentro de las cards */\r\n    .card-tabs {\r\n        display: flex;\r\n        border-bottom: 2px solid var(--border-color);\r\n        margin: 16px 0;\r\n        gap: 2px;\r\n    }\r\n    \r\n    .card-tab {\r\n        flex: 1;\r\n        padding: 8px 12px;\r\n        background: var(--bg-secondary);\r\n        border: none;\r\n        border-radius: 4px 4px 0 0;\r\n        cursor: pointer;\r\n        font-size: 12px;\r\n        font-weight: 500;\r\n        color: var(--text-secondary);\r\n        transition: all 0.2s ease;\r\n    }\r\n    \r\n    .card-tab:hover {\r\n        background: var(--bg-tertiary);\r\n        color: var(--text-primary);\r\n    }\r\n    \r\n    .card-tab.active {\r\n        background: var(--accent-color);\r\n        color: white;\r\n        border-bottom: 2px solid var(--accent-color);\r\n    }\r\n    \r\n    .card-tab-content {\r\n        min-height: 200px;\r\n        max-height: 350px;\r\n        overflow-y: auto;\r\n        padding-bottom: 20px;\r\n    }\r\n    \r\n    .tab-pane {\r\n        animation: fadeIn 0.3s ease-in-out;\r\n    }\r\n    \r\n    @keyframes fadeIn {\r\n        from { opacity: 0; transform: translateY(10px); }\r\n        to { opacity: 1; transform: translateY(0); }\r\n    }\r\n    \r\n    @keyframes spin {\r\n        from { transform: rotate(0deg); }\r\n        to { transform: rotate(360deg); }\r\n    }\r\n    \r\n    @keyframes pulseRed {\r\n        0% { \r\n            box-shadow: 0 3px 10px rgba(211, 47, 47, 0.15), 0 0 0 0 rgba(211, 47, 47, 0.4); \r\n        }\r\n        100% { \r\n            box-shadow: 0 3px 10px rgba(211, 47, 47, 0.25), 0 0 0 6px rgba(211, 47, 47, 0); \r\n        }\r\n    }\r\n    \r\n    /* Layout para tiempos - 2 columnas */\r\n    .tiempos-grid {\r\n        display: grid;\r\n        grid-template-columns: 1fr 1fr;\r\n        gap: 16px;\r\n    }\r\n    \r\n    .tiempos-column {\r\n        display: flex;\r\n        flex-direction: column;\r\n        gap: 12px;\r\n    }\r\n    \r\n    .tiempo-item, .tiempo-item-empty {\r\n        display: flex;\r\n        align-items: center;\r\n        padding: 12px;\r\n        border-radius: var(--radius-md);\r\n        transition: all 0.2s ease;\r\n    }\r\n    \r\n    .tiempo-item.trabajo {\r\n        background: #e8f5e8;\r\n        border-left: 4px solid var(--success-color);\r\n    }\r\n    \r\n    .tiempo-item.turbina {\r\n        background: #e3f2fd;\r\n        border-left: 4px solid var(--accent-color);\r\n    }\r\n    \r\n    .tiempo-item-empty {\r\n        background: var(--bg-tertiary);\r\n        border-left: 4px solid var(--border-color);\r\n        opacity: 0.7;\r\n    }\r\n    \r\n    .tiempo-icon, .tiempo-icon-empty {\r\n        font-size: 16px;\r\n        margin-right: 12px;\r\n        width: 24px;\r\n        text-align: center;\r\n    }\r\n    \r\n    .tiempo-icon-empty {\r\n        opacity: 0.5;\r\n    }\r\n    \r\n    .tiempo-content {\r\n        flex: 1;\r\n    }\r\n    \r\n    .tiempo-label {\r\n        font-size: 10px;\r\n        color: var(--text-secondary);\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n        margin-bottom: 2px;\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .tiempo-value {\r\n        font-weight: 500;\r\n        color: var(--text-primary);\r\n        font-size: 12px;\r\n    }\r\n    \r\n    .tiempo-value-empty {\r\n        font-weight: 400;\r\n        color: var(--text-secondary);\r\n        font-size: 11px;\r\n        font-style: italic;\r\n    }\r\n    \r\n    /* Tabla de materiales */\r\n    .materials-table-container {\r\n        max-height: 300px !important;\r\n        overflow-y: scroll !important;\r\n        overflow-x: auto;\r\n        border: 1px solid var(--border-color);\r\n        border-radius: var(--radius-md);\r\n        background: white;\r\n        scrollbar-width: thin;\r\n        scrollbar-color: var(--accent-color) var(--bg-secondary);\r\n    }\r\n    \r\n    .materials-table-container::-webkit-scrollbar {\r\n        width: 8px;\r\n        height: 8px;\r\n    }\r\n    \r\n    .materials-table-container::-webkit-scrollbar-track {\r\n        background: var(--bg-secondary);\r\n        border-radius: 4px;\r\n    }\r\n    \r\n    .materials-table-container::-webkit-scrollbar-thumb {\r\n        background: var(--accent-color);\r\n        border-radius: 4px;\r\n    }\r\n    \r\n    .materials-table-container::-webkit-scrollbar-thumb:hover {\r\n        background: var(--primary-color);\r\n    }\r\n    \r\n    .materials-table {\r\n        width: 100%;\r\n        min-width: 500px;\r\n        border-collapse: collapse;\r\n        font-size: 12px;\r\n        table-layout: fixed;\r\n    }\r\n    \r\n    .materials-table thead {\r\n        background: var(--primary-color);\r\n        color: white;\r\n        position: sticky;\r\n        top: 0;\r\n        z-index: 2;\r\n    }\r\n    \r\n    .materials-table th {\r\n        padding: 10px 6px;\r\n        text-align: center;\r\n        font-weight: 600;\r\n        font-size: 10px;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.3px;\r\n        border-right: 1px solid rgba(255,255,255,0.2);\r\n        white-space: nowrap;\r\n        overflow: hidden;\r\n    }\r\n    \r\n    .materials-table th:last-child {\r\n        border-right: none;\r\n    }\r\n    \r\n    .materials-table td {\r\n        padding: 8px 6px;\r\n        border-bottom: 1px solid var(--border-color);\r\n        border-right: 1px solid var(--border-color);\r\n        text-align: center;\r\n        white-space: nowrap;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n    }\r\n    \r\n    .materials-table td:first-child {\r\n        text-align: center;\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .materials-table td:nth-child(2) {\r\n        text-align: left;\r\n        white-space: normal;\r\n        word-wrap: break-word;\r\n        max-width: 150px;\r\n    }\r\n    \r\n    .materials-table td:last-child {\r\n        border-right: none;\r\n    }\r\n    \r\n    .materials-table tbody tr:hover {\r\n        background: var(--bg-secondary) !important;\r\n    }\r\n    \r\n    .materials-table tbody tr:nth-child(even) {\r\n        background: var(--bg-tertiary);\r\n    }\r\n    \r\n    /* Layout para cierre - 2 columnas */\r\n    .cierre-grid {\r\n        display: grid;\r\n        grid-template-columns: 1fr 1fr;\r\n        gap: 16px;\r\n        height: 100%;\r\n    }\r\n    \r\n    .cierre-column {\r\n        display: flex;\r\n        flex-direction: column;\r\n        gap: 12px;\r\n    }\r\n    \r\n    .cierre-item {\r\n        display: flex;\r\n        align-items: flex-start;\r\n        padding: 12px;\r\n        border-radius: var(--radius-md);\r\n        background: var(--bg-secondary);\r\n    }\r\n    \r\n    .cierre-item.responsable {\r\n        border-left: 4px solid var(--accent-color);\r\n    }\r\n    \r\n    .cierre-item.fecha {\r\n        border-left: 4px solid var(--success-color);\r\n    }\r\n    \r\n    .cierre-item.observaciones {\r\n        border-left: 4px solid var(--warning-color);\r\n        height: fit-content;\r\n        min-height: 120px;\r\n    }\r\n    \r\n    .cierre-icon {\r\n        font-size: 16px;\r\n        margin-right: 12px;\r\n        width: 24px;\r\n        text-align: center;\r\n        margin-top: 2px;\r\n    }\r\n    \r\n    .cierre-content {\r\n        flex: 1;\r\n    }\r\n    \r\n    .cierre-content-full {\r\n        width: 100%;\r\n    }\r\n    \r\n    .cierre-label {\r\n        font-size: 10px;\r\n        color: var(--text-secondary);\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n        margin-bottom: 4px;\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .cierre-value {\r\n        font-weight: 500;\r\n        color: var(--text-primary);\r\n        font-size: 12px;\r\n    }\r\n    \r\n    .cierre-observaciones {\r\n        background: white;\r\n        padding: 10px;\r\n        border-radius: 4px;\r\n        border: 1px solid var(--border-color);\r\n        font-size: 11px;\r\n        line-height: 1.4;\r\n        color: var(--text-primary);\r\n        min-height: 80px;\r\n        max-height: 150px;\r\n        overflow-y: auto;\r\n    }\r\n    \r\n    /* Estilos para aprobaci\u00F3n de cierre */\r\n    .cierre-item.aprobacion {\r\n        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\r\n        border: 1px solid #dee2e6;\r\n    }\r\n    \r\n    .cierre-value.aprobado {\r\n        color: var(--success-color);\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .cierre-value.pendiente {\r\n        color: var(--warning-color);\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .cierre-sub-info {\r\n        font-size: 10px;\r\n        color: var(--text-secondary);\r\n        margin-top: 2px;\r\n    }\r\n    \r\n    .cierre-actions {\r\n        display: flex;\r\n        gap: 8px;\r\n        justify-content: flex-end;\r\n    }\r\n    \r\n    .permiso-header {\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: start;\r\n        margin-bottom: 16px;\r\n    }\r\n    \r\n    .permiso-numero {\r\n        font-size: 18px;\r\n        font-weight: 600;\r\n        color: var(--primary-color);\r\n    }\r\n    \r\n    .permiso-estado {\r\n        padding: 4px 12px;\r\n        border-radius: var(--radius-sm);\r\n        font-size: 12px;\r\n        font-weight: 600;\r\n        text-transform: uppercase;\r\n    }\r\n    \r\n    .estado-creado {\r\n        background: rgba(241, 196, 15, 0.1);\r\n        color: var(--warning-color);\r\n        border: 1px solid rgba(241, 196, 15, 0.2);\r\n    }\r\n    \r\n    .estado-activo {\r\n        background: rgba(39, 174, 96, 0.1);\r\n        color: var(--success-color);\r\n        border: 1px solid rgba(39, 174, 96, 0.2);\r\n    }\r\n    \r\n    .estado-cerrado_pendiente_aprobacion {\r\n        background: rgba(230, 126, 34, 0.1);\r\n        color: #e67e22;\r\n        border: 1px solid rgba(230, 126, 34, 0.3);\r\n        font-weight: 500;\r\n    }\r\n    \r\n    .estado-cerrado {\r\n        background: rgba(149, 165, 166, 0.1);\r\n        color: var(--text-secondary);\r\n        border: 1px solid rgba(149, 165, 166, 0.2);\r\n    }\r\n    \r\n    .estado-cierre_rechazado {\r\n        background: rgba(231, 76, 60, 0.1);\r\n        color: var(--danger-color);\r\n        border: 1px solid rgba(231, 76, 60, 0.2);\r\n        font-weight: 600;\r\n    }\r\n    \r\n    .permiso-info {\r\n        display: grid;\r\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\r\n        gap: 12px;\r\n        margin-bottom: 16px;\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .permiso-info-item {\r\n        display: flex;\r\n        flex-direction: column;\r\n    }\r\n    \r\n    .permiso-info-label {\r\n        font-size: 12px;\r\n        color: var(--text-secondary);\r\n        margin-bottom: 4px;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n    }\r\n    \r\n    .permiso-info-value {\r\n        color: var(--text-primary);\r\n        font-weight: 500;\r\n    }\r\n    \r\n    .permiso-actions {\r\n        display: flex;\r\n        gap: 8px;\r\n        flex-wrap: wrap;\r\n        align-items: center;\r\n        justify-content: space-between;\r\n    }\r\n    \r\n    .permiso-info-value ul {\r\n        list-style: none;\r\n        padding: 0;\r\n        margin: 4px 0;\r\n    }\r\n    \r\n    .permiso-info-value li {\r\n        margin: 4px 0;\r\n        padding-left: 16px;\r\n        position: relative;\r\n    }\r\n    \r\n    .permiso-info-value li:before {\r\n        content: \"\u2022\";\r\n        position: absolute;\r\n        left: 0;\r\n        color: var(--accent-color);\r\n    }\r\n    \r\n    .estado-pendiente {\r\n        background: rgba(243, 156, 18, 0.1);\r\n        color: var(--warning-color);\r\n        border: 1px solid rgba(243, 156, 18, 0.2);\r\n    }\r\n    \r\n    .input-others {\r\n        display: none;\r\n        margin-top: 12px;\r\n    }\r\n    \r\n    @media (max-width: 768px) {\r\n        .container {\r\n            padding: 8px;\r\n            max-width: 100%;\r\n        }\r\n        \r\n        .login-container {\r\n            padding: 24px 16px;\r\n            margin: 10px;\r\n            max-width: calc(100% - 20px);\r\n        }\r\n        \r\n        .app-container {\r\n            margin: 0;\r\n            border-radius: 0;\r\n            min-height: 100vh;\r\n        }\r\n        \r\n        .header {\r\n            padding: 16px 20px;\r\n            flex-direction: column;\r\n            gap: 12px;\r\n            text-align: center;\r\n        }\r\n        \r\n        .header h1 {\r\n            font-size: 18px;\r\n        }\r\n        \r\n        .header p {\r\n            font-size: 12px;\r\n        }\r\n        \r\n        .tabs {\r\n            overflow-x: auto;\r\n            flex-wrap: nowrap;\r\n            -webkit-overflow-scrolling: touch;\r\n        }\r\n        \r\n        .tab {\r\n            white-space: nowrap;\r\n            min-width: 120px;\r\n            padding: 12px 16px;\r\n            font-size: 13px;\r\n        }\r\n        \r\n        .tab-content {\r\n            padding: 16px 12px;\r\n        }\r\n        \r\n        .grid-three {\r\n            grid-template-columns: 1fr;\r\n            gap: 16px;\r\n        }\r\n        \r\n        .selector-dual {\r\n            grid-template-columns: 1fr;\r\n            gap: 16px;\r\n        }\r\n        \r\n        .selector-controls {\r\n            flex-direction: row;\r\n            justify-content: center;\r\n            gap: 12px;\r\n        }\r\n        \r\n        .card {\r\n            padding: 16px;\r\n            margin-bottom: 16px;\r\n        }\r\n        \r\n        .card h3 {\r\n            font-size: 14px;\r\n            margin-bottom: 16px;\r\n        }\r\n        \r\n        /* Cards de permisos - mejorar separaci\u00F3n y responsive */\r\n        .permiso-card-container {\r\n            margin-bottom: 32px;\r\n            border-bottom: 2px solid var(--border-color);\r\n            padding-bottom: 16px;\r\n        }\r\n        \r\n        .permiso-card-container:last-child {\r\n            border-bottom: none;\r\n        }\r\n        \r\n        .permiso-card {\r\n            min-height: auto;\r\n            height: auto;\r\n            transform: none !important;\r\n            transform-style: flat;\r\n        }\r\n        \r\n        .permiso-card-front,\r\n        .permiso-card-back {\r\n            min-height: 280px;\r\n            height: auto;\r\n            padding: 16px;\r\n            position: relative;\r\n            transform: none !important;\r\n        }\r\n        \r\n        .permiso-card-back {\r\n            position: relative;\r\n            transform: none !important;\r\n            backface-visibility: visible;\r\n        }\r\n        \r\n        .permiso-card.flipped .permiso-card-front {\r\n            display: none;\r\n        }\r\n        \r\n        .permiso-card:not(.flipped) .permiso-card-back {\r\n            display: none;\r\n        }\r\n        \r\n        .permiso-card.flipped {\r\n            margin-bottom: 32px;\r\n        }\r\n        \r\n        .permiso-card-container.flipped-container {\r\n            margin-bottom: 48px;\r\n        }\r\n        \r\n        .permiso-header {\r\n            flex-direction: column;\r\n            align-items: flex-start;\r\n            gap: 12px;\r\n        }\r\n        \r\n        .permiso-numero {\r\n            font-size: 16px;\r\n        }\r\n        \r\n        .permiso-info {\r\n            grid-template-columns: 1fr;\r\n            gap: 8px;\r\n            font-size: 13px;\r\n        }\r\n        \r\n        .permiso-actions {\r\n            flex-wrap: wrap;\r\n            gap: 6px;\r\n            margin-top: 12px;\r\n        }\r\n        \r\n        .btn-small {\r\n            padding: 6px 12px;\r\n            font-size: 11px;\r\n        }\r\n        \r\n        /* Formularios en m\u00F3vil */\r\n        .form-group {\r\n            margin-bottom: 16px;\r\n        }\r\n        \r\n        .form-group input,\r\n        .form-group select,\r\n        .form-group textarea {\r\n            font-size: 16px; /* Previene zoom en iOS */\r\n            padding: 12px;\r\n        }\r\n        \r\n        .form-group label {\r\n            font-size: 12px;\r\n            margin-bottom: 6px;\r\n        }\r\n        \r\n        /* Tablas responsivas */\r\n        .data-table {\r\n            font-size: 12px;\r\n        }\r\n        \r\n        .data-table th,\r\n        .data-table td {\r\n            padding: 8px 6px;\r\n        }\r\n        \r\n        .materials-table-container {\r\n            max-height: 250px;\r\n        }\r\n        \r\n        .materials-table {\r\n            font-size: 11px;\r\n        }\r\n        \r\n        .materials-table th,\r\n        .materials-table td {\r\n            padding: 6px 4px;\r\n        }\r\n        \r\n        /* Search box responsive */\r\n        .search-box {\r\n            grid-template-columns: 1fr;\r\n            gap: 12px;\r\n        }\r\n        \r\n        .search-box input[type=\\\"date\\\"] {\r\n            font-size: 16px; /* Previene zoom en iOS */\r\n        }\r\n        \r\n        .search-input {\r\n            font-size: 16px; /* Previene zoom en iOS */\r\n        }\r\n        \r\n        /* Tiempos y cierre grids */\r\n        .tiempos-grid,\r\n        .cierre-grid {\r\n            grid-template-columns: 1fr;\r\n            gap: 12px;\r\n        }\r\n        \r\n        /* Modal responsivo */\r\n        .modal {\r\n            margin: 10px;\r\n            max-width: calc(100% - 20px);\r\n            max-height: calc(100vh - 20px);\r\n            overflow-y: auto;\r\n        }\r\n        \r\n        /* Export modal responsive */\r\n        #exportModal > div {\r\n            max-width: calc(100% - 20px);\r\n            margin: 10px;\r\n            padding: 20px 16px;\r\n        }\r\n        \r\n        #exportModal h3 {\r\n            font-size: 20px;\r\n        }\r\n        \r\n        #exportModal .btn {\r\n            padding: 12px;\r\n            font-size: 14px;\r\n        }\r\n    }\r\n    \r\n    /* Pantallas muy peque\u00F1as (tel\u00E9fonos en vertical) */\r\n    @media (max-width: 480px) {\r\n        .container {\r\n            padding: 4px;\r\n        }\r\n        \r\n        .login-container {\r\n            padding: 20px 12px;\r\n            margin: 5px;\r\n            max-width: calc(100% - 10px);\r\n        }\r\n        \r\n        .header {\r\n            padding: 12px 16px;\r\n        }\r\n        \r\n        .header h1 {\r\n            font-size: 16px;\r\n        }\r\n        \r\n        .tab {\r\n            min-width: 100px;\r\n            padding: 10px 12px;\r\n            font-size: 12px;\r\n        }\r\n        \r\n        .tab-content {\r\n            padding: 12px 8px;\r\n        }\r\n        \r\n        .card {\r\n            padding: 12px;\r\n            margin-bottom: 12px;\r\n        }\r\n        \r\n        .permiso-card-container {\r\n            margin-bottom: 28px;\r\n            padding-bottom: 12px;\r\n        }\r\n        \r\n        .permiso-card-front,\r\n        .permiso-card-back {\r\n            padding: 12px;\r\n            min-height: 250px;\r\n            height: auto;\r\n            position: relative;\r\n            transform: none !important;\r\n        }\r\n        \r\n        .permiso-card-back {\r\n            position: relative;\r\n            transform: none !important;\r\n        }\r\n        \r\n        .permiso-numero {\r\n            font-size: 14px;\r\n        }\r\n        \r\n        .permiso-info {\r\n            font-size: 12px;\r\n        }\r\n        \r\n        .btn {\r\n            padding: 10px 16px;\r\n            font-size: 12px;\r\n        }\r\n        \r\n        .btn-small {\r\n            padding: 5px 10px;\r\n            font-size: 10px;\r\n        }\r\n        \r\n        .form-group input,\r\n        .form-group select,\r\n        .form-group textarea {\r\n            padding: 10px;\r\n        }\r\n        \r\n        .data-table {\r\n            font-size: 11px;\r\n        }\r\n        \r\n        .materials-table {\r\n            font-size: 10px;\r\n        }\r\n        \r\n        #exportModal > div {\r\n            padding: 16px 12px;\r\n        }\r\n        \r\n        #exportModal h3 {\r\n            font-size: 18px;\r\n        }\r\n    }\r\n    \r\n    /* Estilos para administraci\u00F3n de usuarios */\r\n    .badge {\r\n        display: inline-block;\r\n        padding: 4px 8px;\r\n        border-radius: 12px;\r\n        font-size: 11px;\r\n        font-weight: 500;\r\n        text-transform: uppercase;\r\n        letter-spacing: 0.5px;\r\n        white-space: nowrap;\r\n    }\r\n    \r\n    .badge-primary {\r\n        background: var(--primary-color);\r\n        color: white;\r\n    }\r\n    \r\n    .badge-secondary {\r\n        background: var(--text-secondary);\r\n        color: white;\r\n    }\r\n    \r\n    .badge-success {\r\n        background: var(--success-color);\r\n        color: white;\r\n    }\r\n    \r\n    .badge-warning {\r\n        background: var(--warning-color);\r\n        color: white;\r\n    }\r\n    \r\n    .badge-danger {\r\n        background: var(--danger-color);\r\n        color: white;\r\n    }\r\n    \r\n    .badge-info {\r\n        background: var(--accent-color);\r\n        color: white;\r\n    }\r\n    \r\n    .table-responsive {\r\n        overflow-x: auto;\r\n        -webkit-overflow-scrolling: touch;\r\n    }\r\n    \r\n    .btn-small {\r\n        padding: 4px 8px;\r\n        font-size: 12px;\r\n        border-radius: 4px;\r\n        min-width: auto;\r\n        display: inline-flex;\r\n        align-items: center;\r\n        justify-content: center;\r\n        text-decoration: none;\r\n        cursor: pointer;\r\n        border: none;\r\n    }\r\n    \r\n    .btn-danger {\r\n        background: var(--danger-color);\r\n        color: white;\r\n    }\r\n    \r\n    .btn-danger:hover {\r\n        background: #c0392b;\r\n        transform: translateY(-1px);\r\n    }\r\n    \r\n    .grid-two {\r\n        display: grid;\r\n        grid-template-columns: 1fr 1fr;\r\n        gap: 16px;\r\n    }\r\n    \r\n    .no-data {\r\n        text-align: center;\r\n        padding: 40px 20px;\r\n        color: var(--text-secondary);\r\n        font-style: italic;\r\n    }\r\n    \r\n    .error {\r\n        background: #fef5e7;\r\n        color: var(--danger-color);\r\n        padding: 12px 16px;\r\n        border-radius: 6px;\r\n        border: 1px solid #f5c6cb;\r\n        margin-bottom: 16px;\r\n        font-size: 14px;\r\n    }\r\n    \r\n    .success {\r\n        background: #d4edda;\r\n        color: var(--success-color);\r\n        padding: 12px 16px;\r\n        border-radius: 6px;\r\n        border: 1px solid #c3e6cb;\r\n        margin-bottom: 16px;\r\n        font-size: 14px;\r\n    }\r\n\r\n    @media print {\r\n        body {\r\n            background: white;\r\n        }\r\n        \r\n        .header, .tabs, .btn, .permiso-actions {\r\n            display: none !important;\r\n        }\r\n        \r\n        .container {\r\n            max-width: 100%;\r\n        }\r\n    }\r\n  `;\r\n}\r\n\r\nexport default getStyles;\r\n", "/**\r\n * Returns the JavaScript code for the PT Worker web app.\r\n * Note: This module currently contains a placeholder string.\r\n * Copy the actual script from worker.js into this function.\r\n */\r\nexport function getWebAppScript() {\r\n  return `\r\n    // ========================================================================\r\n    // CONFIGURACI\u00D3N Y VARIABLES GLOBALES\r\n    // ========================================================================\r\n    \r\n    // PT Wind v18.0 - D1 Database Edition\r\n    \r\n    const API_BASE = window.location.origin + '/api';\r\n    let currentUser = null;\r\n    let authToken = null;\r\n    let sessionId = null;\r\n    \r\n    // Datos cargados\r\n    let parquesData = [];\r\n    let personalData = [];\r\n    let personalByParque = {};\r\n    let supervisoresData = [];\r\n    let actividadesData = [];\r\n    let matrizRiesgosData = [];\r\n    let aerogeneradoresData = [];\r\n    let permisosData = [];\r\n    \r\n    // Estado del formulario\r\n    let personalSeleccionado = [];\r\n    let actividadesSeleccionadas = [];\r\n    let matrizRiesgosSeleccionada = [];\r\n    let materialesParaCierre = [];\r\n    \r\n    // ========================================================================\r\n    // FUNCIONES DE TIEMPO - ZONA HORARIA CHILE\r\n    // ========================================================================\r\n    \r\n    function getChileDateTime(offsetMinutes = 0) {\r\n      const now = new Date();\r\n      \r\n      // Determinar si estamos en horario de verano chileno (DST)\r\n      const year = now.getUTCFullYear();\r\n      \r\n      // Segundo domingo de septiembre (inicio DST)\r\n      const septemberSecondSunday = getSecondSunday(year, 8);\r\n      // Primer domingo de abril (fin DST)\r\n      const aprilFirstSunday = getFirstSunday(year, 3);\r\n      \r\n      const currentTime = now.getTime();\r\n      const isDST = currentTime >= septemberSecondSunday.getTime() || currentTime < aprilFirstSunday.getTime();\r\n      \r\n      // UTC-3 durante DST, UTC-4 durante horario est\u00E1ndar\r\n      const chileOffsetMinutes = isDST ? -3 * 60 : -4 * 60;\r\n      \r\n      return new Date(now.getTime() + (chileOffsetMinutes + offsetMinutes) * 60000);\r\n    }\r\n    \r\n    function getSecondSunday(year, month) {\r\n      const date = new Date(Date.UTC(year, month, 1));\r\n      const firstSunday = 7 - date.getUTCDay();\r\n      return new Date(Date.UTC(year, month, firstSunday + 7));\r\n    }\r\n    \r\n    function getFirstSunday(year, month) {\r\n      const date = new Date(Date.UTC(year, month, 1));\r\n      const firstSunday = 7 - date.getUTCDay();\r\n      return new Date(Date.UTC(year, month, firstSunday === 7 ? 7 : firstSunday));\r\n    }\r\n    \r\n    function formatChileDateTime(date) {\r\n      const pad = (n) => String(n).padStart(2, '0');\r\n      return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) + ' ' +\r\n             pad(date.getHours()) + ':' + pad(date.getMinutes()) + ':' + pad(date.getSeconds());\r\n    }\r\n    \r\n    // ========================================================================\r\n    // FUNCIONES DE SEGURIDAD\r\n    // ========================================================================\r\n    \r\n    // Funci\u00F3n para validar la fortaleza de contrase\u00F1as\r\n    function validatePasswordStrength(password) {\r\n      const minLength = 8;\r\n      const hasUppercase = /[A-Z]/.test(password);\r\n      const hasLowercase = /[a-z]/.test(password);\r\n      const hasNumbers = /[0-9]/.test(password);\r\n      const hasSpecialChar = /[^a-zA-Z0-9]/.test(password);\r\n      \r\n      if (!password || password.length < minLength) {\r\n        return { \r\n          valid: false, \r\n          message: 'La contrase\u00F1a debe tener al menos 8 caracteres' \r\n        };\r\n      }\r\n      \r\n      if (!hasUppercase) {\r\n        return { \r\n          valid: false, \r\n          message: 'La contrase\u00F1a debe contener al menos una letra may\u00FAscula' \r\n        };\r\n      }\r\n      \r\n      if (!hasLowercase) {\r\n        return { \r\n          valid: false, \r\n          message: 'La contrase\u00F1a debe contener al menos una letra min\u00FAscula' \r\n        };\r\n      }\r\n      \r\n      if (!hasNumbers) {\r\n        return { \r\n          valid: false, \r\n          message: 'La contrase\u00F1a debe contener al menos un n\u00FAmero' \r\n        };\r\n      }\r\n      \r\n      if (!hasSpecialChar) {\r\n        return { \r\n          valid: false, \r\n          message: 'La contrase\u00F1a debe contener al menos un car\u00E1cter especial' \r\n        };\r\n      }\r\n      \r\n      return { valid: true };\r\n    }\r\n    \r\n    class ClientSecurity {\r\n      static sanitizeInput(input) {\r\n        if (typeof input !== 'string') return input;\r\n        return input\r\n          .replace(/[<>]/g, '')\r\n          .replace(/javascript:/gi, '')\r\n          .replace(/on\\w+\\s*=/gi, '')\r\n          .trim();\r\n      }\r\n      \r\n      static encodeHTML(str) {\r\n        const div = document.createElement('div');\r\n        div.textContent = str;\r\n        return div.innerHTML;\r\n      }\r\n      \r\n      static async makeSecureRequest(endpoint, options = {}) {\r\n        const defaultOptions = {\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            ...options.headers\r\n          }\r\n        };\r\n        \r\n        if (authToken) {\r\n          defaultOptions.headers['Authorization'] = 'Bearer ' + authToken;\r\n        }\r\n        \r\n        if (sessionId) {\r\n          defaultOptions.headers['X-Session-Id'] = sessionId;\r\n        }\r\n        \r\n        try {\r\n          const response = await fetch(API_BASE + endpoint, {\r\n            ...defaultOptions,\r\n            ...options\r\n          });\r\n          \r\n          if (response.status === 401) {\r\n            handleLogout();\r\n            throw new Error('Sesi\u00F3n expirada');\r\n          }\r\n          \r\n          const data = await response.json();\r\n          \r\n          if (!response.ok) {\r\n            throw new Error(data.error || 'Error en la solicitud');\r\n          }\r\n          \r\n          return data;\r\n        } catch (error) {\r\n          console.error('Request error:', error);\r\n          throw error;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // INICIALIZACI\u00D3N (sin cambios)\r\n    // ========================================================================\r\n    \r\n    document.addEventListener('DOMContentLoaded', async function() {\r\n        // Inicializando aplicaci\u00F3n...\r\n        \r\n        const storedToken = sessionStorage.getItem('authToken');\r\n        const storedSessionId = sessionStorage.getItem('sessionId');  // \u2190 AGREGAR\r\n        if (storedSessionId) sessionId = storedSessionId;  // \u2190 AGREGAR\r\n        if (storedToken) {\r\n            authToken = storedToken;\r\n            await verifyAndLoadApp();\r\n        } else {\r\n            showLoginScreen();\r\n        }\r\n        \r\n        setupEventListeners();\r\n        checkConnectionStatus();\r\n    });\r\n    \r\n    // ========================================================================\r\n    // MANEJO DE AUTENTICACI\u00D3N (sin cambios)\r\n    // ========================================================================\r\n    \r\n    function setupEventListeners() {\r\n        // helper seguro para no romper si falta un elemento\r\n        const on = (id, ev, fn, opts) => { \r\n            const el = document.getElementById(id); \r\n            if (el) el.addEventListener(ev, fn, opts); \r\n        };\r\n        \r\n        // Login\r\n        on('loginForm', 'submit', handleLogin);\r\n        on('logoutBtn', 'click', handleLogout);\r\n        \r\n        // Tabs\r\n        document.querySelectorAll('.tab').forEach(tab => {\r\n            tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));\r\n        });\r\n        \r\n        // Formulario de permiso\r\n        on('permisoForm', 'submit', handleCreatePermiso);\r\n        \r\n        // Selectores\r\n        on('planta', 'change', handlePlantaChange);\r\n        on('tipoMantenimiento', 'change', handleTipoMantenimientoChange);\r\n        \r\n        // Personal\r\n        on('addPersonalBtn', 'click', addSelectedPersonal);\r\n        on('removePersonalBtn', 'click', removeSelectedPersonal);\r\n        \r\n        // Botones\r\n        on('generateRegisterBtn', 'click', generateRegister);\r\n        on('refreshPermisosBtn', 'click', loadPermisos);\r\n        on('clearSearchBtn', 'click', clearSearch);\r\n        const search = document.getElementById('searchPermiso'); \r\n        if (search) search.addEventListener('input', filterPermisos);\r\n        const filterEstado = document.getElementById('filterEstado');\r\n        if (filterEstado) filterEstado.addEventListener('change', filterPermisos);\r\n        const fechaDesde = document.getElementById('fechaDesde');\r\n        if (fechaDesde) fechaDesde.addEventListener('change', filterPermisos);\r\n        const fechaHasta = document.getElementById('fechaHasta');\r\n        if (fechaHasta) fechaHasta.addEventListener('change', filterPermisos);\r\n        \r\n        // Modal de cierre\r\n        on('cancelarCierreBtn', 'click', closeCerrarModal);\r\n        on('confirmarCierreBtn', 'click', handleConfirmarCierre);\r\n        on('addMaterialBtn', 'click', addMaterial);\r\n        \r\n        // Administraci\u00F3n de usuarios\r\n        on('btnNuevoUsuario', 'click', openNuevoUsuarioModal);\r\n        on('btnRefreshUsuarios', 'click', loadUsuarios);\r\n        on('usuarioForm', 'submit', handleGuardarUsuario);\r\n        on('cancelarUsuarioBtn', 'click', closeUsuarioModal);\r\n        on('cancelarEliminarUsuarioBtn', 'click', closeConfirmarEliminarModal);\r\n        on('confirmarEliminarUsuarioBtn', 'click', handleEliminarUsuario);\r\n    }\r\n    \r\n    async function handleLogin(e) {\r\n        e.preventDefault();\r\n        \r\n        const usuario = ClientSecurity.sanitizeInput(document.getElementById('usuario').value);\r\n        const password = document.getElementById('password').value;\r\n        \r\n        const loginBtn = document.getElementById('loginBtn');\r\n        const errorDiv = document.getElementById('loginError');\r\n        \r\n        errorDiv.style.display = 'none';\r\n        loginBtn.disabled = true;\r\n        loginBtn.textContent = 'Iniciando sesi\u00F3n...';\r\n        \r\n        try {\r\n            const response = await fetch(API_BASE + '/login', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ usuario, password })\r\n            });\r\n            \r\n            const result = await response.json();\r\n            \r\n            if (result.success) {\r\n                authToken = result.token;\r\n                sessionId = result.sessionId;\r\n                currentUser = result.user;\r\n                \r\n                sessionStorage.setItem('authToken', authToken);\r\n                if (sessionId) {\r\n                    sessionStorage.setItem('sessionId', sessionId);\r\n                }\r\n                if (result.requirePasswordChange) {\r\n                    showChangePasswordModal(result.changeReason);\r\n                } else {\r\n                    await loadAppData();\r\n                    showApp();\r\n                    // Iniciar timer de inactividad despu\u00E9s del login exitoso\r\n                    resetInactivityTimer();\r\n                }\r\n            } else {\r\n                showLoginError(result.message || 'Error al iniciar sesi\u00F3n');\r\n            }\r\n        } catch (error) {\r\n            showLoginError('Error de conexi\u00F3n: ' + error.message);\r\n        } finally {\r\n            loginBtn.disabled = false;\r\n            loginBtn.textContent = 'Iniciar Sesi\u00F3n';\r\n        }\r\n    }\r\n\r\n    // Nueva funci\u00F3n para mostrar modal de cambio obligatorio\r\n    function showChangePasswordModal(reason) {\r\n        const modal = document.getElementById('changePasswordModal');\r\n        modal.style.display = 'flex';\r\n        \r\n        // Mostrar el motivo del cambio requerido\r\n        const reasonDiv = document.getElementById('passwordChangeReason');\r\n        if (reasonDiv) {\r\n            reasonDiv.textContent = reason || 'Por razones de seguridad, debe cambiar su contrase\u00F1a.';\r\n            reasonDiv.style.display = 'block';\r\n        }\r\n        \r\n        // Mostrar requisitos de contrase\u00F1a\r\n        const requirementsDiv = document.getElementById('passwordRequirements');\r\n        if (requirementsDiv) {\r\n            requirementsDiv.innerHTML = '<strong>La nueva contrase\u00F1a debe cumplir con:</strong>' +\r\n                '<ul style=\"text-align: left; margin: 10px 0;\">' +\r\n                    '<li>M\u00EDnimo 8 caracteres</li>' +\r\n                    '<li>Al menos una letra may\u00FAscula</li>' +\r\n                    '<li>Al menos una letra min\u00FAscula</li>' +\r\n                    '<li>Al menos un n\u00FAmero</li>' +\r\n                    '<li>Al menos un car\u00E1cter especial (!@#$%^&*()_+-=[]{};\\\\':\\\\\"|,.<>/?)</li>' +\r\n                '</ul>';\r\n            requirementsDiv.style.display = 'block';\r\n        }\r\n        \r\n        document.getElementById('submitPasswordChangeBtn')\r\n            .addEventListener('click', handleMandatoryPasswordChange, { once: true });\r\n    }\r\n    \r\n    async function handleMandatoryPasswordChange() {\r\n    const newPassword = document.getElementById('mandatoryNewPassword').value;\r\n    const confirmPassword = document.getElementById('mandatoryConfirmPassword').value;\r\n    const errorDiv = document.getElementById('changePasswordError');\r\n    const submitBtn = document.getElementById('submitPasswordChangeBtn');\r\n    \r\n    // Validaciones\r\n    if (!newPassword || !confirmPassword) {\r\n        errorDiv.textContent = 'Ambos campos son requeridos';\r\n        errorDiv.style.display = 'block';\r\n        return;\r\n    }\r\n    \r\n    if (newPassword !== confirmPassword) {\r\n        errorDiv.textContent = 'Las contrase\u00F1as no coinciden';\r\n        errorDiv.style.display = 'block';\r\n        return;\r\n    }\r\n    \r\n    // Validaci\u00F3n completa de contrase\u00F1a segura\r\n    const passwordValidation = validatePasswordStrength(newPassword);\r\n    if (!passwordValidation.valid) {\r\n        errorDiv.textContent = passwordValidation.message;\r\n        errorDiv.style.display = 'block';\r\n        return;\r\n    }\r\n    \r\n    submitBtn.disabled = true;\r\n    submitBtn.textContent = 'Cambiando contrase\u00F1a...';\r\n    \r\n    try {\r\n        const response = await fetch(API_BASE + '/change-password', {\r\n            method: 'POST',\r\n            headers: { \r\n                'Content-Type': 'application/json',\r\n                'Authorization': 'Bearer ' + authToken\r\n            },\r\n            body: JSON.stringify({ newPassword })\r\n        });\r\n        \r\n        const result = await response.json();\r\n        \r\n        if (result.success) {\r\n            // Ocultar modal\r\n            document.getElementById('changePasswordModal').style.display = 'none';\r\n            \r\n            // Cargar la aplicaci\u00F3n\r\n            await loadAppData();\r\n            showApp();\r\n            \r\n            // Mostrar mensaje de \u00E9xito\r\n            alert('Contrase\u00F1a actualizada exitosamente');\r\n        } else {\r\n            errorDiv.textContent = result.error || 'Error al cambiar la contrase\u00F1a';\r\n            errorDiv.style.display = 'block';\r\n        }\r\n    } catch (error) {\r\n        errorDiv.textContent = 'Error de conexi\u00F3n';\r\n        errorDiv.style.display = 'block';\r\n    } finally {\r\n        submitBtn.disabled = false;\r\n        submitBtn.textContent = 'Cambiar Contrase\u00F1a y Continuar';\r\n    }\r\n    }\r\n    async function verifyAndLoadApp() {\r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/health');\r\n            if (response.status === 'OK') {\r\n                await loadAppData();\r\n                showApp();\r\n            } else {\r\n                handleLogout();\r\n            }\r\n        } catch (error) {\r\n            console.error('Error verificando token:', error);\r\n            handleLogout();\r\n        }\r\n    }\r\n    \r\n    // Auto-logout por inactividad (30 minutos)\r\n    let inactivityTimer = null;\r\n    const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutos en milisegundos\r\n    \r\n    function resetInactivityTimer() {\r\n        if (inactivityTimer) {\r\n            clearTimeout(inactivityTimer);\r\n        }\r\n        \r\n        // Solo configurar timer si hay usuario logueado\r\n        if (authToken) {\r\n            inactivityTimer = setTimeout(() => {\r\n                alert('Sesi\u00F3n expirada por inactividad. Debe iniciar sesi\u00F3n nuevamente.');\r\n                handleLogout();\r\n            }, INACTIVITY_TIMEOUT);\r\n        }\r\n    }\r\n    \r\n    function handleLogout() {\r\n        authToken = null;\r\n        sessionId = null;\r\n        currentUser = null;\r\n        sessionStorage.clear();\r\n        \r\n        // Limpiar timer de inactividad\r\n        if (inactivityTimer) {\r\n            clearTimeout(inactivityTimer);\r\n            inactivityTimer = null;\r\n        }\r\n        \r\n        showLoginScreen();\r\n    }\r\n    \r\n    function showLoginScreen() {\r\n        document.getElementById('loginScreen').style.display = 'block';\r\n        document.getElementById('appScreen').style.display = 'none';\r\n    }\r\n    \r\n    function showApp() {\r\n        document.getElementById('loginScreen').style.display = 'none';\r\n        document.getElementById('appScreen').style.display = 'block';\r\n        \r\n        if (currentUser) {\r\n            document.getElementById('userDisplay').textContent = \r\n                ClientSecurity.encodeHTML(currentUser.usuario + ' (' + currentUser.rol + ')');\r\n            \r\n            if (currentUser.rol === 'ADMIN') {\r\n                document.getElementById('tabDatos').style.display = 'block';\r\n                document.getElementById('tabAdminUsuarios').style.display = 'block';\r\n            }\r\n        }\r\n    }\r\n    \r\n    function showLoginError(message) {\r\n        const errorDiv = document.getElementById('loginError');\r\n        errorDiv.textContent = message;\r\n        errorDiv.style.display = 'block';\r\n        \r\n        setTimeout(() => {\r\n            errorDiv.style.display = 'none';\r\n        }, 5000);\r\n    }\r\n    \r\n    // ========================================================================\r\n    // CARGA DE DATOS - ACTUALIZADO PARA D1\r\n    // ========================================================================\r\n    \r\n    async function loadAppData() {\r\n        // Cargando datos de la aplicaci\u00F3n...\r\n        \r\n        try {\r\n            const [parques, personal, actividades] = await Promise.all([\r\n                ClientSecurity.makeSecureRequest('/parques'),\r\n                ClientSecurity.makeSecureRequest('/personal'),\r\n                ClientSecurity.makeSecureRequest('/actividades')\r\n            ]);\r\n            \r\n            // Los datos ahora vienen directamente como arrays sin properties\r\n            parquesData = parques.results || [];\r\n            personalData = personal.results || [];\r\n            actividadesData = actividades.results || [];\r\n            // supervisoresData se cargar\u00E1 cuando se seleccione una planta\r\n            supervisoresData = [];\r\n            \r\n            populateParques();\r\n            // populateSupervisores se llamar\u00E1 cuando se seleccione una planta\r\n            populateActividades();\r\n            \r\n            await loadPermisos();\r\n            \r\n            // Datos cargados exitosamente\r\n        } catch (error) {\r\n            console.error('Error cargando datos:', error);\r\n            alert('Error al cargar los datos del sistema');\r\n        }\r\n    }\r\n    \r\n    function populateParques() {\r\n        const select = document.getElementById('planta');\r\n        select.innerHTML = '<option value=\"\">Seleccionar planta...</option>';\r\n        \r\n        // Filtrar parques seg\u00FAn los autorizados del usuario\r\n        const parquesAutorizados = currentUser?.parques || [];\r\n        const esEnel = currentUser?.esEnel || false;\r\n        \r\n        parquesData.forEach(parque => {\r\n            // Si es Enel, puede ver todos los parques\r\n            // Si no, solo los parques autorizados\r\n            if (esEnel || parquesAutorizados.includes(parque.nombre)) {\r\n                const option = document.createElement('option');\r\n                option.value = parque.nombre;\r\n                option.textContent = parque.nombre;\r\n                option.dataset.id = parque.id;\r\n                option.dataset.codigo = parque.codigo || '';\r\n                select.appendChild(option);\r\n            }\r\n        });\r\n    }\r\n    \r\n    async function populateSupervisores(plantaNombre) {\r\n        const supervisorParqueSelect = document.getElementById('supervisorParque');\r\n        \r\n        supervisorParqueSelect.innerHTML = '<option value=\"\">Seleccionar supervisor Enel...</option>';\r\n        \r\n        if (!plantaNombre) {\r\n            supervisoresData = [];\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            // Cargar supervisores filtrados por parque\r\n            const response = await ClientSecurity.makeSecureRequest(\r\n                '/supervisores?parque=' + encodeURIComponent(plantaNombre)\r\n            );\r\n            supervisoresData = response.results || [];\r\n            \r\n            if (supervisoresData.length === 0) {\r\n                const option = document.createElement('option');\r\n                option.value = \"\";\r\n                option.textContent = \"No hay supervisores Enel asignados a este parque\";\r\n                option.disabled = true;\r\n                supervisorParqueSelect.appendChild(option);\r\n            } else {\r\n                supervisoresData.forEach(supervisor => {\r\n                    const option = document.createElement('option');\r\n                    option.value = supervisor.nombre;\r\n                    option.textContent = supervisor.nombre;\r\n                    option.dataset.id = supervisor.id;\r\n                    option.dataset.cargo = supervisor.cargo || '';\r\n                    option.dataset.telefono = supervisor.telefono || '';\r\n                    option.dataset.rut = supervisor.rut || '';\r\n                    \r\n                    supervisorParqueSelect.appendChild(option);\r\n                });\r\n            }\r\n        } catch (error) {\r\n            console.error('Error cargando supervisores:', error);\r\n            const option = document.createElement('option');\r\n            option.value = \"\";\r\n            option.textContent = \"Error al cargar supervisores\";\r\n            option.disabled = true;\r\n            supervisorParqueSelect.appendChild(option);\r\n        }\r\n    }\r\n    \r\n    function populateActividades() {\r\n        const container = document.getElementById('actividadesChecklist');\r\n        container.innerHTML = '';\r\n        \r\n        actividadesData.forEach(actividad => {\r\n            const item = document.createElement('div');\r\n            item.className = 'checkbox-item';\r\n            item.innerHTML = \\`\r\n                <input type=\"checkbox\" id=\"act_\\${actividad.id}\" value=\"\\${actividad.nombre}\" \r\n                       data-id=\"\\${actividad.id}\" data-tipo=\"\\${actividad.tipo || 'RUTINARIA'}\">\r\n                <label for=\"act_\\${actividad.id}\">\\${actividad.nombre}</label>\r\n            \\`;\r\n            \r\n            item.querySelector('input').addEventListener('change', handleActividadChange);\r\n            container.appendChild(item);\r\n        });\r\n    }\r\n    \r\n    // ========================================================================\r\n    // MANEJO DE FORMULARIO - ACTUALIZADO PARA D1\r\n    // ========================================================================\r\n    \r\n    async function handlePlantaChange(e) {\r\n        const plantaNombre = e.target.value;\r\n        const plantaId = e.target.selectedOptions[0]?.dataset.id;\r\n        const codigoParque = e.target.selectedOptions[0]?.dataset.codigo;\r\n        \r\n        const jefeFaenaSelect = document.getElementById('jefeFaena');  // \u2190 IMPORTANTE\r\n        \r\n        if (!plantaNombre) {\r\n            document.getElementById('aerogenerador').innerHTML = '<option value=\"\">Seleccionar aerogenerador...</option>';\r\n            document.getElementById('personalDisponible').innerHTML = '<div class=\"loading\">Seleccione una planta primero</div>';\r\n            jefeFaenaSelect.innerHTML = '<option value=\"\">Seleccionar jefe de faena...</option>';  // \u2190 IMPORTANTE\r\n            document.getElementById('supervisorParque').innerHTML = '<option value=\"\">Seleccionar supervisor Enel...</option>';\r\n            supervisoresData = [];\r\n            return;\r\n        }\r\n        \r\n        // Cargar aerogeneradores\r\n        await loadAerogeneradores(plantaNombre);\r\n        \r\n        // Cargar supervisores Enel del parque\r\n        await populateSupervisores(plantaNombre);\r\n        \r\n        // Limpiar personal seleccionado al cambiar de planta\r\n        personalSeleccionado = [];\r\n        const personalSeleccionadoContainer = document.getElementById('personalSeleccionado');\r\n        personalSeleccionadoContainer.innerHTML = '<div style=\"padding: 20px; text-align: center; color: var(--text-secondary);\">No hay personal seleccionado</div>';\r\n        \r\n        // Cargar personal del parque\r\n        await loadPersonalByParque(plantaNombre);\r\n        \r\n        // \u2B50 ESTA ES LA PARTE NUEVA QUE DEBES AGREGAR \u2B50\r\n        // Poblar Jefe de Faena con el personal del parque\r\n        jefeFaenaSelect.innerHTML = '<option value=\"\">Seleccionar jefe de faena...</option>';\r\n        \r\n        if (personalByParque[plantaNombre] && personalByParque[plantaNombre].length > 0) {\r\n            personalByParque[plantaNombre].forEach(persona => {\r\n                const option = document.createElement('option');\r\n                option.value = persona.nombre;\r\n                option.textContent = \\`\\${persona.nombre} - \\${persona.empresa || ''}\\`;\r\n                option.dataset.id = persona.id;\r\n                option.dataset.empresa = persona.empresa || '';\r\n                option.dataset.rol = persona.rol || '';\r\n                jefeFaenaSelect.appendChild(option);\r\n            });\r\n        } else {\r\n            // Si no hay personal en el parque, mostrar mensaje\r\n            const option = document.createElement('option');\r\n            option.value = \"\";\r\n            option.textContent = \"No hay personal asignado a este parque\";\r\n            option.disabled = true;\r\n            jefeFaenaSelect.appendChild(option);\r\n        }\r\n    }\r\n    \r\n    async function loadAerogeneradores(plantaNombre) {\r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest(\\`/aerogeneradores?parque=\\${encodeURIComponent(plantaNombre)}\\`);\r\n            aerogeneradoresData = response.results || [];\r\n            \r\n            const select = document.getElementById('aerogenerador');\r\n            select.innerHTML = '<option value=\"\">Seleccionar aerogenerador...</option>';\r\n            \r\n            aerogeneradoresData.forEach(aero => {\r\n                const option = document.createElement('option');\r\n                option.value = aero.nombre || aero.WTG_Name;\r\n                option.textContent = aero.nombre || aero.WTG_Name;\r\n                option.dataset.codigo = aero.codigo || aero.WTG_Name;\r\n                select.appendChild(option);\r\n            });\r\n        } catch (error) {\r\n            console.error('Error cargando aerogeneradores:', error);\r\n        }\r\n    }\r\n    \r\n    async function loadPersonalByParque(plantaNombre) {\r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/personal-by-parque?parque=' + encodeURIComponent(plantaNombre));\r\n            personalByParque[plantaNombre] = response.results || [];\r\n            \r\n            const container = document.getElementById('personalDisponible');\r\n            container.innerHTML = '';\r\n            \r\n            if (personalByParque[plantaNombre].length === 0) {\r\n                container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: var(--text-secondary);\">No hay personal asignado a este parque</div>';\r\n                return;\r\n            }\r\n            \r\n            personalByParque[plantaNombre].forEach(persona => {\r\n                // Los datos vienen directamente, no en properties\r\n                const item = document.createElement('div');\r\n                item.className = 'selector-item';\r\n                item.innerHTML = \\`\r\n                    <strong>\\${persona.nombre}</strong><br>\r\n                    <small>\\${persona.empresa || 'Sin empresa'} - \\${persona.rol || 'Sin rol'}</small>\r\n                \\`;\r\n                item.dataset.id = persona.id;\r\n                item.dataset.nombre = persona.nombre;\r\n                item.dataset.empresa = persona.empresa || '';\r\n                item.dataset.rol = persona.rol || '';\r\n                item.dataset.rut = persona.rut || '';\r\n                \r\n                item.addEventListener('click', () => togglePersonalSelection(item));\r\n                container.appendChild(item);\r\n            });\r\n        } catch (error) {\r\n            console.error('Error cargando personal del parque:', error);\r\n        }\r\n    }\r\n    \r\n    function togglePersonalSelection(item) {\r\n        item.classList.toggle('selected');\r\n    }\r\n    \r\n    function addSelectedPersonal() {\r\n        const disponibleContainer = document.getElementById('personalDisponible');\r\n        const seleccionadoContainer = document.getElementById('personalSeleccionado');\r\n        \r\n        const selectedItems = disponibleContainer.querySelectorAll('.selected');\r\n        \r\n        if (selectedItems.length === 0) {\r\n            alert('Seleccione al menos una persona');\r\n            return;\r\n        }\r\n        \r\n        if (personalSeleccionado.length === 0) {\r\n            seleccionadoContainer.innerHTML = '';\r\n        }\r\n        \r\n        selectedItems.forEach(item => {\r\n            const persona = {\r\n                id: item.dataset.id,\r\n                nombre: item.dataset.nombre,\r\n                empresa: item.dataset.empresa,\r\n                rol: item.dataset.rol,\r\n                rut: item.dataset.rut\r\n            };\r\n            \r\n            if (!personalSeleccionado.find(p => p.id === persona.id)) {\r\n                personalSeleccionado.push(persona);\r\n                \r\n                const newItem = item.cloneNode(true);\r\n                newItem.classList.remove('selected');\r\n                newItem.addEventListener('click', () => togglePersonalSelection(newItem));\r\n                seleccionadoContainer.appendChild(newItem);\r\n            }\r\n            \r\n            item.classList.remove('selected');\r\n            item.style.display = 'none';\r\n        });\r\n    }\r\n    \r\n    function removeSelectedPersonal() {\r\n        const seleccionadoContainer = document.getElementById('personalSeleccionado');\r\n        const disponibleContainer = document.getElementById('personalDisponible');\r\n        \r\n        const selectedItems = seleccionadoContainer.querySelectorAll('.selected');\r\n        \r\n        if (selectedItems.length === 0) {\r\n            alert('Seleccione al menos una persona para remover');\r\n            return;\r\n        }\r\n        \r\n        selectedItems.forEach(item => {\r\n            const id = item.dataset.id;\r\n            \r\n            personalSeleccionado = personalSeleccionado.filter(p => p.id !== id);\r\n            \r\n            const originalItem = disponibleContainer.querySelector(\\`[data-id=\"\\${id}\"]\\`);\r\n            \r\n            if (originalItem) {\r\n                originalItem.style.display = 'block';\r\n            }\r\n            \r\n            item.remove();\r\n        });\r\n        \r\n        if (personalSeleccionado.length === 0) {\r\n            seleccionadoContainer.innerHTML = '<div style=\"padding: 20px; text-align: center; color: var(--text-secondary);\">No hay personal seleccionado</div>';\r\n        }\r\n    }\r\n    \r\n    function handleTipoMantenimientoChange(e) {\r\n        const tipoOtrosContainer = document.getElementById('tipoOtrosContainer');\r\n        if (e.target.value === 'OTROS') {\r\n            tipoOtrosContainer.style.display = 'block';\r\n            document.getElementById('tipoOtros').required = true;\r\n        } else {\r\n            tipoOtrosContainer.style.display = 'none';\r\n            document.getElementById('tipoOtros').required = false;\r\n            document.getElementById('tipoOtros').value = '';\r\n        }\r\n    }\r\n    \r\n    async function handleActividadChange() {\r\n        actividadesSeleccionadas = [];\r\n        document.querySelectorAll('#actividadesChecklist input:checked').forEach(checkbox => {\r\n            actividadesSeleccionadas.push({\r\n                id: checkbox.dataset.id,\r\n                nombre: checkbox.value,\r\n                tipo: checkbox.dataset.tipo\r\n            });\r\n        });\r\n        \r\n        if (actividadesSeleccionadas.length > 0) {\r\n            await loadMatrizRiesgos();\r\n        } else {\r\n            matrizRiesgosSeleccionada = [];\r\n            updateMatrizDisplay();\r\n        }\r\n    }\r\n    \r\n    async function loadMatrizRiesgos() {\r\n        try {\r\n            const actividadesNombres = actividadesSeleccionadas.map(a => a.nombre).join(',');\r\n            const response = await ClientSecurity.makeSecureRequest('/matriz-riesgos?actividades=' + encodeURIComponent(actividadesNombres));\r\n            \r\n            // Los datos vienen directamente de D1, no en properties\r\n            const results = Array.isArray(response?.results) ? response.results : [];\r\n            matrizRiesgosSeleccionada = results.map(item => ({\r\n                id: item.id,\r\n                codigo: item.codigo || 0,\r\n                actividad: item.actividad || '',\r\n                peligro: item.peligro || '',\r\n                riesgo: item.riesgo || '',\r\n                medidas: item.medidas_preventivas || ''\r\n            }));\r\n            \r\n            updateMatrizDisplay();\r\n        } catch (error) {\r\n            console.error('Error cargando matriz de riesgos:', error);\r\n        }\r\n    }\r\n    \r\n    function updateMatrizDisplay() {\r\n        const tableBody = document.getElementById('matrizTableBody');\r\n        const table = document.getElementById('matrizTable');\r\n        const emptyState = document.getElementById('matrizEmptyState');\r\n        \r\n        if (matrizRiesgosSeleccionada.length === 0) {\r\n            table.style.display = 'none';\r\n            emptyState.style.display = 'block';\r\n            return;\r\n        }\r\n        \r\n        table.style.display = 'block';\r\n        emptyState.style.display = 'none';\r\n        \r\n        tableBody.innerHTML = '';\r\n        matrizRiesgosSeleccionada.forEach(item => {\r\n            const row = document.createElement('tr');\r\n            row.innerHTML = \\`\r\n                <td>\\${item.codigo}</td>\r\n                <td>\\${item.actividad}</td>\r\n                <td>\\${item.peligro}</td>\r\n                <td>\\${item.riesgo}</td>\r\n                <td>\\${item.medidas}</td>\r\n            \\`;\r\n            tableBody.appendChild(row);\r\n        });\r\n    }\r\n    \r\n    // ========================================================================\r\n    // CREAR PERMISO (sin cambios significativos)\r\n    // ========================================================================\r\n    \r\n    async function handleCreatePermiso(e) {\r\n        e.preventDefault();\r\n        \r\n        // Determinar si estamos editando o creando\r\n        const isEditing = window.permisoEditando !== undefined;\r\n        \r\n        // Deshabilitar el bot\u00F3n de submit para evitar m\u00FAltiples env\u00EDos\r\n        const submitButton = e.target.querySelector('button[type=\"submit\"]');\r\n        const originalText = submitButton.textContent;\r\n        submitButton.disabled = true;\r\n        submitButton.textContent = isEditing ? 'ACTUALIZANDO PERMISO...' : 'CREANDO PERMISO...';\r\n        \r\n        const plantaSelect = document.getElementById('planta');\r\n        const aerogeneradorSelect = document.getElementById('aerogenerador');\r\n        const jefeFaenaSelect = document.getElementById('jefeFaena');\r\n        const supervisorParqueSelect = document.getElementById('supervisorParque');\r\n        \r\n        const permisoData = {\r\n            planta: plantaSelect.value,\r\n            plantaId: plantaSelect.selectedOptions[0]?.dataset.id,\r\n            codigoParque: plantaSelect.selectedOptions[0]?.dataset.codigo,\r\n            aerogenerador: aerogeneradorSelect.value,\r\n            aerogeneradorCodigo: aerogeneradorSelect.selectedOptions[0]?.dataset.codigo,\r\n            descripcion: ClientSecurity.sanitizeInput(document.getElementById('descripcion').value),\r\n            jefeFaena: jefeFaenaSelect.value,\r\n            jefeFaenaId: jefeFaenaSelect.selectedOptions[0]?.dataset.id,\r\n            supervisorParque: supervisorParqueSelect.value,\r\n            supervisorParqueId: supervisorParqueSelect.selectedOptions[0]?.dataset.id,\r\n            tipoMantenimiento: document.getElementById('tipoMantenimiento').value,\r\n            tipoMantenimientoOtros: ClientSecurity.sanitizeInput(document.getElementById('tipoOtros').value),\r\n            personal: personalSeleccionado,\r\n            actividades: actividadesSeleccionadas,\r\n            matrizRiesgos: matrizRiesgosSeleccionada,\r\n            usuarioCreador: currentUser?.email || 'unknown',\r\n            fechaInicio: formatChileDateTime(getChileDateTime())\r\n        };\r\n        \r\n        if (!permisoData.planta || !permisoData.descripcion || !permisoData.jefeFaena) {\r\n            alert('Por favor complete los campos obligatorios');\r\n            // Re-habilitar el bot\u00F3n si hay error de validaci\u00F3n\r\n            submitButton.disabled = false;\r\n            submitButton.textContent = originalText;\r\n            return;\r\n        }\r\n        \r\n        if (personalSeleccionado.length === 0) {\r\n            alert('Debe seleccionar al menos una persona');\r\n            // Re-habilitar el bot\u00F3n si hay error de validaci\u00F3n\r\n            submitButton.disabled = false;\r\n            submitButton.textContent = originalText;\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            let response;\r\n            \r\n            if (isEditing) {\r\n                // Agregar ID del permiso para edici\u00F3n\r\n                permisoData.permisoId = window.permisoEditando;\r\n                console.log('EDITANDO PERMISO - ID:', window.permisoEditando, 'Datos:', permisoData);\r\n                \r\n                response = await ClientSecurity.makeSecureRequest('/permisos', {\r\n                    method: 'PUT',\r\n                    body: JSON.stringify(permisoData)\r\n                });\r\n            } else {\r\n                response = await ClientSecurity.makeSecureRequest('/permisos', {\r\n                    method: 'POST',\r\n                    body: JSON.stringify(permisoData)\r\n                });\r\n            }\r\n            \r\n            if (response.success) {\r\n                const mensaje = isEditing ? \r\n                    'Permiso actualizado exitosamente' : \r\n                    'Permiso creado exitosamente\\\\n\\\\nN\u00FAmero: ' + response.numeroPT;\r\n                    \r\n                alert(mensaje);\r\n                \r\n                document.getElementById('permisoForm').reset();\r\n                personalSeleccionado = [];\r\n                actividadesSeleccionadas = [];\r\n                matrizRiesgosSeleccionada = [];\r\n                document.getElementById('personalSeleccionado').innerHTML = '<div style=\"padding: 20px; text-align: center; color: var(--text-secondary);\">No hay personal seleccionado</div>';\r\n                updateMatrizDisplay();\r\n                \r\n                // Resetear estado de edici\u00F3n\r\n                if (isEditing) {\r\n                    window.permisoEditando = undefined;\r\n                    submitButton.textContent = 'CREAR PERMISO DE TRABAJO';\r\n                }\r\n                \r\n                await loadPermisos();\r\n                switchTab('consultar');\r\n                \r\n                // Re-habilitar el bot\u00F3n despu\u00E9s del \u00E9xito\r\n                submitButton.disabled = false;\r\n                submitButton.textContent = isEditing ? 'CREAR PERMISO DE TRABAJO' : originalText;\r\n            } else {\r\n                const accion = isEditing ? 'actualizar' : 'crear';\r\n                alert(\\`Error al \\${accion} el permiso: \\` + (response.error || 'Error desconocido'));\r\n                // Re-habilitar el bot\u00F3n si hay error\r\n                submitButton.disabled = false;\r\n                submitButton.textContent = originalText;\r\n            }\r\n        } catch (error) {\r\n            const accion = isEditing ? 'actualizando' : 'creando';\r\n            console.error(\\`Error \\${accion} permiso:\\`, error);\r\n            alert(\\`Error al \\${accion} el permiso: \\` + error.message);\r\n            // Re-habilitar el bot\u00F3n si hay error\r\n            submitButton.disabled = false;\r\n            submitButton.textContent = originalText;\r\n        }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // CONSULTAR PERMISOS (actualizado para D1)\r\n    // ========================================================================\r\n    \r\n    async function loadPermisos() {\r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/permisos');\r\n            permisosData = response.permisos || [];\r\n            \r\n            // Configurar l\u00EDmites de fechas basados en los permisos cargados\r\n            setupDateLimits();\r\n            \r\n            displayPermisos();\r\n        } catch (error) {\r\n            console.error('Error cargando permisos:', error);\r\n            document.getElementById('permisosContainer').innerHTML = '<div class=\"error\">Error al cargar los permisos</div>';\r\n        }\r\n    }\r\n    \r\n    function displayPermisos() {\r\n        const container = document.getElementById('permisosContainer');\r\n        \r\n        // Filtrar permisos seg\u00FAn plantas autorizadas\r\n        const parquesAutorizados = currentUser?.parques || [];\r\n        const esEnel = currentUser?.esEnel || false;\r\n        \r\n        const permisosFiltrados = permisosData.filter(permiso => {\r\n            // Si es Enel, puede ver todos los permisos\r\n            // Si no, solo los de sus parques autorizados\r\n            return esEnel || parquesAutorizados.includes(permiso.planta_nombre);\r\n        });\r\n        \r\n        if (permisosFiltrados.length === 0) {\r\n            container.innerHTML = '<div class=\"loading\">No hay permisos registrados para sus plantas autorizadas</div>';\r\n            return;\r\n        }\r\n        \r\n        container.innerHTML = '';\r\n        permisosFiltrados.forEach(permiso => {\r\n            const card = createPermisoCard(permiso);\r\n            container.appendChild(card);\r\n        });\r\n    }\r\n    \r\n    function createPermisoCard(permiso) {\r\n        const cardContainer = document.createElement('div');\r\n        cardContainer.className = 'permiso-card-container';\r\n        \r\n        const card = document.createElement('div');\r\n        card.className = 'permiso-card';\r\n        card.dataset.permisoId = permiso.id;\r\n        \r\n        const estadoClass = 'estado-' + (permiso.estado || 'CREADO').toLowerCase();\r\n        const esEnel = currentUser?.esEnel || currentUser?.rol === 'Supervisor Enel';\r\n        \r\n        // Verificar si el usuario es el creador del permiso\r\n        const esCreador = currentUser?.id && permiso.usuario_creador_id && \r\n                         currentUser.id.toString() === permiso.usuario_creador_id.toString();\r\n        \r\n        // Verificar si el usuario puede cerrar el permiso\r\n        // Ahora todos los IDs son de la misma tabla usuarios\r\n        const userId = currentUser?.id ? currentUser.id.toString() : null;\r\n        const jefeFaenaId = permiso.jefe_faena_id ? permiso.jefe_faena_id.toString() : null;\r\n        const personalIds = permiso.personal_ids ? \r\n            permiso.personal_ids.split(',').map(id => id.trim()) : [];\r\n        \r\n        const esJefeFaena = userId && userId === jefeFaenaId;\r\n        const estaEnPersonalAsignado = userId && personalIds.includes(userId);\r\n        \r\n        const puedeCerrarPermiso = esEnel || esJefeFaena || estaEnPersonalAsignado;\r\n        \r\n        // Determinar texto de estado para usuarios no aprobadores\r\n        let estadoTexto = permiso.estado;\r\n        if (permiso.estado === 'CREADO' && !esEnel) {\r\n            estadoTexto = 'PENDIENTE DE APROBACI\u00D3N';\r\n        } else if (permiso.estado === 'CERRADO_PENDIENTE_APROBACION') {\r\n            estadoTexto = 'CERRADO - PENDIENTE APROBACI\u00D3N';\r\n        } else if (permiso.estado === 'CIERRE_RECHAZADO') {\r\n            estadoTexto = 'CIERRE RECHAZADO';\r\n        }\r\n        \r\n        // Crear estructura de tarjeta con frente y reverso\r\n        card.innerHTML = \\`\r\n            <div class=\"permiso-card-inner\">\r\n                <!-- Frente de la tarjeta -->\r\n                <div class=\"permiso-card-front\">\r\n                    <div class=\"permiso-header\">\r\n                        <div class=\"permiso-numero\">\\${permiso.numero_pt}</div>\r\n                        <div class=\"permiso-estado \\${estadoClass}\">\\${estadoTexto}</div>\r\n                    </div>\r\n                    \r\n                    <div class=\"permiso-info\">\r\n                        <div class=\"permiso-info-item\">\r\n                            <div class=\"permiso-info-label\">Planta</div>\r\n                            <div class=\"permiso-info-value\">\\${permiso.planta_nombre}</div>\r\n                        </div>\r\n                        <div class=\"permiso-info-item\">\r\n                            <div class=\"permiso-info-label\">Aerogenerador</div>\r\n                            <div class=\"permiso-info-value\">\\${permiso.aerogenerador_nombre || 'N/A'}</div>\r\n                        </div>\r\n                        <div class=\"permiso-info-item\">\r\n                            <div class=\"permiso-info-label\">Jefe de Faena</div>\r\n                            <div class=\"permiso-info-value\">\\${permiso.jefe_faena_nombre}</div>\r\n                        </div>\r\n                        \\${permiso.supervisor_parque_nombre ? \\`\r\n                        <div class=\"permiso-info-item\">\r\n                            <div class=\"permiso-info-label\">Supervisor Responsable</div>\r\n                            <div class=\"permiso-info-value\">\\${permiso.supervisor_parque_nombre}</div>\r\n                        </div>\r\n                        \\` : ''}\r\n                        <div class=\"permiso-info-item\">\r\n                            <div class=\"permiso-info-label\">Fecha Creaci\u00F3n</div>\r\n                            <div class=\"permiso-info-value\">\\${formatDate(permiso.fecha_creacion)}</div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <div class=\"permiso-info\">\r\n                        <div class=\"permiso-info-item\" style=\"grid-column: 1 / -1;\">\r\n                            <div class=\"permiso-info-label\">Descripci\u00F3n</div>\r\n                            <div class=\"permiso-info-value\">\\${permiso.descripcion}</div>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    \\${permiso.personal_asignado ? \\`\r\n                        <div class=\"permiso-info\">\r\n                            <div class=\"permiso-info-item\" style=\"grid-column: 1 / -1;\">\r\n                                <div class=\"permiso-info-label\">Personal Asignado</div>\r\n                                <div class=\"permiso-info-value\">\\${permiso.personal_asignado}</div>\r\n                            </div>\r\n                        </div>\r\n                    \\` : ''}\r\n                    \r\n                    <div class=\"permiso-actions\">\r\n                        \\${permiso.estado === 'CREADO' && esCreador ? \r\n                            \\`<button class=\"btn btn-warning btn-small\" onclick=\"editarPermiso(\\${permiso.id})\" style=\"margin-right: 8px;\">\u270F\uFE0F EDITAR</button>\\` : ''}\r\n                        \r\n                        \\${permiso.estado === 'CREADO' && esEnel ? \r\n                            \\`<button class=\"btn btn-secondary btn-small\" onclick=\"aprobarPermiso(\\${permiso.id})\">APROBAR</button>\\` : ''}\r\n                        \r\n                        \\${permiso.estado === 'ACTIVO' && puedeCerrarPermiso ? \r\n                            \\`<button class=\"btn btn-danger btn-small\" onclick=\"openCerrarModal(\\${permiso.id}, '\\${permiso.numero_pt}', '\\${permiso.planta_nombre}', '\\${permiso.aerogenerador_nombre || \\\"N/A\\\"}')\">CERRAR PERMISO</button>\\` : ''}\r\n                        \r\n                        \\${permiso.estado === 'CIERRE_RECHAZADO' ? \\`\r\n                            <button class=\"btn btn-warning btn-small\" \r\n                                    onclick=\"openReenviarCierreModal(\\${permiso.id}, '\\${(permiso.numero_pt || '').replace(/'/g, \"\\\\\\'\")}', '\\${(permiso.planta_nombre || '').replace(/'/g, \"\\\\\\'\")}', '\\${(permiso.aerogenerador_nombre || '').replace(/'/g, \"\\\\\\'\")}')\"\r\n                                    style=\"margin-right: 8px;\">\r\n                                \uD83D\uDD04 REENVIAR CIERRE\r\n                            </button>\r\n                        \\` : ''}\r\n                        \r\n                        \\${(permiso.estado === 'CERRADO' || permiso.estado === 'CERRADO_PENDIENTE_APROBACION' || permiso.estado === 'CIERRE_RECHAZADO' || permiso.actividades_detalle?.length > 0 || permiso.materiales_detalle?.length > 0 || permiso.matriz_riesgos_detalle?.length > 0) ? \r\n                            \\`<button class=\"btn btn-info btn-small\" onclick=\"flipCard(\\${permiso.id})\">VER DETALLES</button>\\` : ''}\r\n                        \r\n                        \\${(permiso.estado === 'CERRADO' || permiso.estado === 'CERRADO_PENDIENTE_APROBACION' || permiso.estado === 'CIERRE_RECHAZADO') ? \r\n                            \\`<button class=\"btn btn-success btn-small\" onclick=\"openExportModal(\\${permiso.id}, '\\${permiso.numero_pt}')\"\" style=\"margin-left: 8px;\">\r\n                                \uD83D\uDCC1 EXPORTAR\r\n                            </button>\\` : ''}\r\n                        \r\n                        \\${(permiso.estado === 'CERRADO' || permiso.estado === 'CERRADO_PENDIENTE_APROBACION' || permiso.estado === 'CIERRE_RECHAZADO') ? \r\n                            \\`<span style=\"color: var(--text-secondary); font-size: 12px;\">Cerrado por: \\${permiso.usuario_cierre || 'N/A'}</span>\\` : \r\n                            (permiso.estado === 'CREADO' && !esEnel ? \r\n                                \\`<span style=\"color: var(--warning); font-size: 12px; font-weight: 500;\">\u23F3 Pendiente de aprobaci\u00F3n</span>\\` : '')\r\n                        }\r\n                    </div>\r\n                </div>\r\n                \r\n                <!-- Reverso de la tarjeta -->\r\n                <div class=\"permiso-card-back\">\r\n                    <div class=\"permiso-header\">\r\n                        <div class=\"permiso-numero\">\\${permiso.numero_pt} - Detalles</div>\r\n                        <button class=\"btn-flip\" onclick=\"flipCard(\\${permiso.id})\">\u2190 Volver</button>\r\n                    </div>\r\n                    \r\n                    <!-- Pesta\u00F1as internas -->\r\n                    <div class=\"card-tabs\">\r\n                        <button class=\"card-tab active\" onclick=\"showCardTab(\\${permiso.id}, 'actividades')\">Actividades</button>\r\n                        <button class=\"card-tab\" onclick=\"showCardTab(\\${permiso.id}, 'tiempos')\">Tiempos</button>\r\n                        <button class=\"card-tab\" onclick=\"showCardTab(\\${permiso.id}, 'materiales')\">Materiales</button>\r\n                        <button class=\"card-tab\" onclick=\"showCardTab(\\${permiso.id}, 'cierre')\">Cierre</button>\r\n                    </div>\r\n                    \r\n                    <!-- Contenido de las pesta\u00F1as -->\r\n                    <div class=\"card-tab-content\" data-permiso-id=\"\\${permiso.id}\">\r\n                        \r\n                        <!-- Tab: Actividades -->\r\n                        <div class=\"tab-pane active\" data-tab=\"actividades\">\r\n                            \\${permiso.actividades_detalle && permiso.actividades_detalle.length > 0 ? \\`\r\n                                <div class=\"permiso-info\">\r\n                                    <div class=\"permiso-info-item\" style=\"grid-column: 1 / -1;\">\r\n                                        <div class=\"permiso-info-label\">Actividades Realizadas</div>\r\n                                        <div class=\"permiso-info-value\" style=\"font-size: 13px;\">\r\n                                            \\${permiso.actividades_detalle.map(act => \\`\r\n                                                <div style=\"margin: 6px 0; padding: 8px; background: var(--bg-secondary); border-radius: 4px;\">\r\n                                                    <strong>\u2022 \\${act.actividad_nombre}</strong>\r\n                                                    \\${act.tipo_actividad ? \\`<span style=\"color: var(--accent-color); font-size: 11px; margin-left: 8px;\">(\\${act.tipo_actividad})</span>\\` : ''}\r\n                                                </div>\r\n                                            \\`).join('')}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                                \\${permiso.matriz_riesgos_detalle && permiso.matriz_riesgos_detalle.length > 0 ? \\`\r\n                                    <div class=\"permiso-info\" style=\"margin-top: 12px;\">\r\n                                        <div class=\"permiso-info-item\" style=\"grid-column: 1 / -1;\">\r\n                                            <div class=\"permiso-info-label\">Matriz de Riesgos</div>\r\n                                            <div class=\"permiso-info-value\" style=\"font-size: 12px;\">\r\n                                                \\${permiso.matriz_riesgos_detalle.map(riesgo => \\`\r\n                                                    <div style=\"margin: 6px 0; padding: 8px; background: #fff3cd; border-left: 3px solid var(--warning-color); border-radius: 4px;\">\r\n                                                        <div style=\"color: var(--danger-color); font-weight: 500;\">\u26A0 \\${riesgo.riesgo_descripcion || 'Riesgo'}</div>\r\n                                                        \\${riesgo.medida_control ? \\`<div style=\"color: var(--success-color); margin-top: 4px;\">\u2713 \\${riesgo.medida_control}</div>\\` : ''}\r\n                                                    </div>\r\n                                                \\`).join('')}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                \\` : ''}\r\n                            \\` : \\`\r\n                                <div style=\"text-align: center; padding: 40px; color: var(--text-secondary);\">\r\n                                    <p>No hay actividades registradas</p>\r\n                                </div>\r\n                            \\`}\r\n                        </div>\r\n                        \r\n                        <!-- Tab: Tiempos -->\r\n                        <div class=\"tab-pane\" data-tab=\"tiempos\" style=\"display: none;\">\r\n                            <div class=\"tiempos-grid\">\r\n                                <!-- Columna Izquierda: Trabajos -->\r\n                                <div class=\"tiempos-column\">\r\n                                    \\${permiso.fecha_inicio_trabajos ? \\`\r\n                                        <div class=\"tiempo-item trabajo\">\r\n                                            <div class=\"tiempo-icon\">\uD83D\uDEE0\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Inicio de Trabajos</div>\r\n                                                <div class=\"tiempo-value\">\\${formatDate(permiso.fecha_inicio_trabajos)}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\` : \\`\r\n                                        <div class=\"tiempo-item-empty\">\r\n                                            <div class=\"tiempo-icon-empty\">\uD83D\uDEE0\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Inicio de Trabajos</div>\r\n                                                <div class=\"tiempo-value-empty\">No registrado</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\`}\r\n                                    \r\n                                    \\${permiso.fecha_fin_trabajos ? \\`\r\n                                        <div class=\"tiempo-item trabajo\">\r\n                                            <div class=\"tiempo-icon\">\u2705</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Fin de Trabajos</div>\r\n                                                <div class=\"tiempo-value\">\\${formatDate(permiso.fecha_fin_trabajos)}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\` : \\`\r\n                                        <div class=\"tiempo-item-empty\">\r\n                                            <div class=\"tiempo-icon-empty\">\u2705</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Fin de Trabajos</div>\r\n                                                <div class=\"tiempo-value-empty\">No registrado</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\`}\r\n                                </div>\r\n                                \r\n                                <!-- Columna Derecha: Turbina -->\r\n                                <div class=\"tiempos-column\">\r\n                                    \\${permiso.fecha_parada_turbina ? \\`\r\n                                        <div class=\"tiempo-item turbina\">\r\n                                            <div class=\"tiempo-icon\">\u23F8\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Parada de Turbina</div>\r\n                                                <div class=\"tiempo-value\">\\${formatDate(permiso.fecha_parada_turbina)}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\` : \\`\r\n                                        <div class=\"tiempo-item-empty\">\r\n                                            <div class=\"tiempo-icon-empty\">\u23F8\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Parada de Turbina</div>\r\n                                                <div class=\"tiempo-value-empty\">No registrado</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\`}\r\n                                    \r\n                                    \\${permiso.fecha_puesta_marcha_turbina ? \\`\r\n                                        <div class=\"tiempo-item turbina\">\r\n                                            <div class=\"tiempo-icon\">\u25B6\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Puesta en Marcha</div>\r\n                                                <div class=\"tiempo-value\">\\${formatDate(permiso.fecha_puesta_marcha_turbina)}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\` : \\`\r\n                                        <div class=\"tiempo-item-empty\">\r\n                                            <div class=\"tiempo-icon-empty\">\u25B6\uFE0F</div>\r\n                                            <div class=\"tiempo-content\">\r\n                                                <div class=\"tiempo-label\">Puesta en Marcha</div>\r\n                                                <div class=\"tiempo-value-empty\">No registrado</div>\r\n                                            </div>\r\n                                        </div>\r\n                                    \\`}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        \r\n                        <!-- Tab: Materiales -->\r\n                        <div class=\"tab-pane\" data-tab=\"materiales\" style=\"display: none;\">\r\n                            \\${permiso.materiales_detalle && permiso.materiales_detalle.length > 0 ? \\`\r\n                                <div class=\"materials-table-container\">\r\n                                    <table class=\"materials-table\">\r\n                                        <thead>\r\n                                            <tr>\r\n                                                <th style=\"width: 40px;\">#</th>\r\n                                                <th>Material/Herramienta</th>\r\n                                                <th style=\"width: 60px;\">Cant.</th>\r\n                                                <th style=\"width: 80px;\">Propietario</th>\r\n                                                <th style=\"width: 70px;\">Almac\u00E9n</th>\r\n                                                <th style=\"width: 70px;\">N\u00B0 Item</th>\r\n                                            </tr>\r\n                                        </thead>\r\n                                        <tbody>\r\n                                            \\${permiso.materiales_detalle.map((mat, index) => \\`\r\n                                                <tr>\r\n                                                    <td>\\${index + 1}</td>\r\n                                                    <td>\\${mat.material_nombre || 'Sin descripci\u00F3n'}</td>\r\n                                                    <td>\\${mat.material_cantidad || 1}</td>\r\n                                                    <td style=\"font-size: 11px;\">\\${mat.material_propietario || 'N/A'}</td>\r\n                                                    <td style=\"font-size: 11px;\">\\${mat.material_almacen || 'N/A'}</td>\r\n                                                    <td style=\"font-size: 11px;\">\\${mat.numero_item || 'N/A'}</td>\r\n                                                </tr>\r\n                                            \\`).join('')}\r\n                                        </tbody>\r\n                                    </table>\r\n                                </div>\r\n                            \\` : \\`\r\n                                <div style=\"text-align: center; padding: 40px; color: var(--text-secondary);\">\r\n                                    <p>\uD83D\uDCE6 No hay materiales registrados</p>\r\n                                    <p style=\"font-size: 12px; margin-top: 8px;\">Los materiales utilizados aparecer\u00E1n aqu\u00ED cuando se registren</p>\r\n                                </div>\r\n                            \\`}\r\n                        </div>\r\n                        \r\n                        <!-- Tab: Cierre -->\r\n                        <div class=\"tab-pane\" data-tab=\"cierre\" style=\"display: none;\">\r\n                            \\${(permiso.estado === 'CERRADO' || permiso.estado === 'CERRADO_PENDIENTE_APROBACION' || permiso.estado === 'CIERRE_RECHAZADO') ? \\`\r\n                                <div class=\"cierre-grid\">\r\n                                    <!-- Columna Izquierda: Responsable -->\r\n                                    <div class=\"cierre-column\">\r\n                                        <div class=\"cierre-item responsable\">\r\n                                            <div class=\"cierre-icon\">\uD83D\uDC64</div>\r\n                                            <div class=\"cierre-content\">\r\n                                                <div class=\"cierre-label\">Responsable del Cierre</div>\r\n                                                <div class=\"cierre-value\">\\${permiso.usuario_cierre || 'No especificado'}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        \r\n                                        <div class=\"cierre-item fecha\">\r\n                                            <div class=\"cierre-icon\">\uD83D\uDCC5</div>\r\n                                            <div class=\"cierre-content\">\r\n                                                <div class=\"cierre-label\">Fecha de Cierre</div>\r\n                                                <div class=\"cierre-value\">\\${formatDate(permiso.fecha_cierre)}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        \r\n                                        <!-- Estado de Aprobaci\u00F3n del Cierre -->\r\n                                        <div class=\"cierre-item aprobacion\">\r\n                                            <div class=\"cierre-icon\">\\${permiso.estado_aprobacion_cierre === 'APROBADO' ? '\u2705' : (permiso.estado_aprobacion_cierre === 'RECHAZADO' ? '\u274C' : '\u23F3')}</div>\r\n                                            <div class=\"cierre-content\">\r\n                                                <div class=\"cierre-label\">Estado Aprobaci\u00F3n</div>\r\n                                                <div class=\"cierre-value \\${permiso.estado_aprobacion_cierre === 'APROBADO' ? 'aprobado' : (permiso.estado_aprobacion_cierre === 'RECHAZADO' ? 'rechazado' : 'pendiente')}\">\r\n                                                    \\${permiso.estado_aprobacion_cierre === 'APROBADO' ? 'APROBADO' : (permiso.estado_aprobacion_cierre === 'RECHAZADO' ? 'RECHAZADO' : 'PENDIENTE')}\r\n                                                </div>\r\n                                                \\${permiso.usuario_aprobador_cierre_nombre ? \\`\r\n                                                    <div class=\"cierre-sub-info\">Por: \\${permiso.usuario_aprobador_cierre_nombre}</div>\r\n                                                    <div class=\"cierre-sub-info\">\\${formatDate(permiso.fecha_aprobacion_cierre)}</div>\r\n                                                \\` : ''}\r\n                                                \\${permiso.estado_aprobacion_cierre === 'RECHAZADO' && permiso.motivo_rechazo ? \\`\r\n                                                    <div class=\"motivo-rechazo\" style=\"\r\n                                                        margin-top: 12px;\r\n                                                        padding: 15px;\r\n                                                        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);\r\n                                                        border: 2px solid #e57373;\r\n                                                        border-radius: 8px;\r\n                                                        border-left: 5px solid #d32f2f;\r\n                                                        box-shadow: 0 3px 10px rgba(211, 47, 47, 0.15);\r\n                                                        animation: pulseRed 2s ease-in-out infinite alternate;\r\n                                                    \">\r\n                                                        <div style=\"\r\n                                                            color: #d32f2f;\r\n                                                            font-weight: 700;\r\n                                                            font-size: 14px;\r\n                                                            margin-bottom: 8px;\r\n                                                            display: flex;\r\n                                                            align-items: center;\r\n                                                            gap: 8px;\r\n                                                            text-transform: uppercase;\r\n                                                            letter-spacing: 0.5px;\r\n                                                        \">\r\n                                                            \uD83D\uDEAB MOTIVO DEL RECHAZO\r\n                                                        </div>\r\n                                                        <div style=\"\r\n                                                            color: #424242;\r\n                                                            font-size: 14px;\r\n                                                            line-height: 1.5;\r\n                                                            font-weight: 600;\r\n                                                            background: rgba(255, 255, 255, 0.8);\r\n                                                            padding: 10px;\r\n                                                            border-radius: 4px;\r\n                                                            border-left: 3px solid #ff5722;\r\n                                                        \">\r\n                                                            \"\\${permiso.motivo_rechazo}\"\r\n                                                        </div>\r\n                                                        <div style=\"\r\n                                                            margin-top: 12px;\r\n                                                            padding: 8px 12px;\r\n                                                            background: rgba(255, 152, 0, 0.1);\r\n                                                            border-radius: 4px;\r\n                                                            border: 1px solid #ff9800;\r\n                                                            color: #e65100;\r\n                                                            font-size: 12px;\r\n                                                            font-weight: 600;\r\n                                                            text-align: center;\r\n                                                        \">\r\n                                                            \uD83D\uDCA1 Use el bot\u00F3n \"REENVIAR CIERRE\" para corregir y reenviar\r\n                                                        </div>\r\n                                                    </div>\r\n                                                \\` : ''}\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                    \r\n                                    <!-- Columna Derecha: Observaciones -->\r\n                                    <div class=\"cierre-column\">\r\n                                        <div class=\"cierre-item observaciones\">\r\n                                            <div class=\"cierre-content-full\">\r\n                                                <div class=\"cierre-label\">Observaciones</div>\r\n                                                <div class=\"cierre-observaciones\">\\${permiso.observaciones_cierre || 'Sin observaciones registradas'}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        \r\n                                        <!-- Bot\u00F3n de Aprobaci\u00F3n si es necesario -->\r\n                                        \\${permiso.estado === 'CERRADO_PENDIENTE_APROBACION' && (currentUser.rol === 'Admin' || currentUser.rol === 'Supervisor') ? \\`\r\n                                            <div class=\"cierre-actions\" style=\"margin-top: 15px;\">\r\n                                                <button class=\"btn btn-success btn-small\" onclick=\"openAprobarCierreModal(\\${permiso.id}, '\\${(permiso.numero_pt || '').replace(/'/g, \"\\\\'\")}')\" >\r\n                                                    \u2705 APROBAR CIERRE\r\n                                                </button>\r\n                                            </div>\r\n                                        \\` : ''}\r\n                                    </div>\r\n                                </div>\r\n                            \\` : \\`\r\n                                <div style=\"text-align: center; padding: 40px; color: var(--text-secondary);\">\r\n                                    <p>\uD83D\uDD13 Permiso a\u00FAn activo</p>\r\n                                    <p style=\"font-size: 12px; margin-top: 8px;\">La informaci\u00F3n de cierre estar\u00E1 disponible cuando se complete el permiso</p>\r\n                                </div>\r\n                            \\`}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        \\`;\r\n        \r\n        cardContainer.appendChild(card);\r\n        return cardContainer;\r\n    }\r\n    \r\n    function filterPermisos() {\r\n        const searchTerm = document.getElementById('searchPermiso').value.toLowerCase();\r\n        const estadoFilter = document.getElementById('filterEstado').value;\r\n        const fechaDesde = document.getElementById('fechaDesde').value;\r\n        const fechaHasta = document.getElementById('fechaHasta').value;\r\n        const txt = v => String(v ?? '').toLowerCase();\r\n        \r\n        // Filtrar primero por parques autorizados\r\n        const parquesAutorizados = currentUser?.parques || [];\r\n        const esEnel = currentUser?.esEnel || false;\r\n        \r\n        const permisosAutorizados = permisosData.filter(permiso => {\r\n            return esEnel || parquesAutorizados.includes(permiso.planta_nombre);\r\n        });\r\n        \r\n        // Filtrar por estado si se seleccion\u00F3 uno\r\n        let filtered = permisosAutorizados;\r\n        if (estadoFilter) {\r\n            filtered = filtered.filter(p => p.estado === estadoFilter);\r\n        }\r\n        \r\n        // Filtrar por rango de fechas\r\n        if (fechaDesde || fechaHasta) {\r\n            filtered = filtered.filter(p => {\r\n                if (!p.fecha_creacion) return false;\r\n                \r\n                const fechaPermiso = new Date(p.fecha_creacion);\r\n                if (isNaN(fechaPermiso.getTime())) return false;\r\n                \r\n                const fechaPermisoStr = fechaPermiso.toISOString().split('T')[0];\r\n                \r\n                let cumpleFechaDesde = true;\r\n                let cumpleFechaHasta = true;\r\n                \r\n                if (fechaDesde) {\r\n                    cumpleFechaDesde = fechaPermisoStr >= fechaDesde;\r\n                }\r\n                \r\n                if (fechaHasta) {\r\n                    cumpleFechaHasta = fechaPermisoStr <= fechaHasta;\r\n                }\r\n                \r\n                return cumpleFechaDesde && cumpleFechaHasta;\r\n            });\r\n        }\r\n        \r\n        // Filtrar por t\u00E9rmino de b\u00FAsqueda si hay uno\r\n        if (searchTerm) {\r\n            filtered = filtered.filter(p =>\r\n                txt(p.numero_pt).includes(searchTerm) ||\r\n                txt(p.planta_nombre).includes(searchTerm) ||\r\n                txt(p.descripcion).includes(searchTerm) ||\r\n                txt(p.jefe_faena_nombre).includes(searchTerm)\r\n            );\r\n        }\r\n        \r\n        // Si no hay filtros aplicados, mostrar todos\r\n        if (!searchTerm && !estadoFilter && !fechaDesde && !fechaHasta) {\r\n            displayPermisos();\r\n            return;\r\n        }\r\n        \r\n        const container = document.getElementById('permisosContainer');\r\n        if (filtered.length === 0) {\r\n            container.innerHTML = '<div class=\"loading\">No se encontraron permisos con ese criterio</div>';\r\n            return;\r\n        }\r\n        \r\n        container.innerHTML = '';\r\n        filtered.forEach(permiso => {\r\n            const card = createPermisoCard(permiso);\r\n            container.appendChild(card);\r\n        });\r\n    }\r\n    \r\n    // Funci\u00F3n para voltear las tarjetas\r\n    window.flipCard = function(permisoId) {\r\n        const card = document.querySelector(\\`.permiso-card[data-permiso-id=\"\\${permisoId}\"]\\`);\r\n        const container = card?.closest('.permiso-card-container');\r\n        \r\n        if (card && container) {\r\n            const isFlipped = card.classList.contains('flipped');\r\n            \r\n            // Toggle flip\r\n            card.classList.toggle('flipped');\r\n            container.classList.toggle('flipped-container');\r\n            \r\n            // Resetear a la primera pesta\u00F1a cuando se voltea hacia atr\u00E1s\r\n            if (!isFlipped) {\r\n                const tabs = card.querySelectorAll('.card-tab');\r\n                const panes = card.querySelectorAll('.tab-pane');\r\n                tabs.forEach(t => t.classList.remove('active'));\r\n                panes.forEach(p => p.style.display = 'none');\r\n                if (tabs[0]) tabs[0].classList.add('active');\r\n                if (panes[0]) {\r\n                    panes[0].style.display = 'block';\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // Funci\u00F3n para cambiar pesta\u00F1as dentro de la card\r\n    window.showCardTab = function(permisoId, tabName) {\r\n        const card = document.querySelector(\\`.permiso-card[data-permiso-id=\"\\${permisoId}\"]\\`);\r\n        if (!card) return;\r\n        \r\n        // Actualizar botones de pesta\u00F1as\r\n        const tabs = card.querySelectorAll('.card-tab');\r\n        tabs.forEach(tab => {\r\n            tab.classList.remove('active');\r\n        });\r\n        event.target.classList.add('active');\r\n        \r\n        // Mostrar/ocultar contenido\r\n        const panes = card.querySelectorAll('.tab-pane');\r\n        panes.forEach(pane => {\r\n            if (pane.dataset.tab === tabName) {\r\n                pane.style.display = 'block';\r\n            } else {\r\n                pane.style.display = 'none';\r\n            }\r\n        });\r\n    }\r\n    \r\n    // ========================================================================\r\n    // FUNCIONES DE EXPORTACI\u00D3N\r\n    // ========================================================================\r\n    \r\n    // Funci\u00F3n para mostrar/ocultar men\u00FA de exportaci\u00F3n\r\n    window.toggleExportMenu = function(permisoId) {\r\n        // Cerrar otros men\u00FAs abiertos\r\n        document.querySelectorAll('.dropdown-menu').forEach(menu => {\r\n            if (menu.id !== \\`exportMenu_\\${permisoId}\\`) {\r\n                menu.style.display = 'none';\r\n            }\r\n        });\r\n        \r\n        const menu = document.getElementById(\\`exportMenu_\\${permisoId}\\`);\r\n        if (menu) {\r\n            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';\r\n        }\r\n    }\r\n    \r\n    // Funci\u00F3n para exportar archivo (Excel o PDF)\r\n    window.exportarArchivo = async function(permisoId, numeroPT, tipo) {\r\n        // Cerrar men\u00FA\r\n        const menu = document.getElementById(\\`exportMenu_\\${permisoId}\\`);\r\n        if (menu) menu.style.display = 'none';\r\n        \r\n        try {\r\n            const endpoint = tipo === 'excel' ? '/exportar-permiso-excel' : '/exportar-permiso-pdf';\r\n            const extension = tipo === 'excel' ? 'xlsx' : 'pdf';\r\n            const fechaActual = new Date().toISOString().split('T')[0].replace(/-/g, '');\r\n            const descripcion = '_' + fechaActual;\r\n            \r\n            // Realizar petici\u00F3n\r\n            const response = await fetch(\\`\\${API_BASE}\\${endpoint}?id=\\${permisoId}\\`, {\r\n                headers: {\r\n                    'Authorization': 'Bearer ' + authToken,\r\n                    'X-Session-Id': sessionId\r\n                }\r\n            });\r\n            \r\n            if (!response.ok) {\r\n                throw new Error('Error al generar el archivo');\r\n            }\r\n            \r\n            // Descargar archivo\r\n            const blob = await response.blob();\r\n            const url = window.URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            a.href = url;\r\n            a.download = \\`\\${numeroPT}\\${descripcion}.\\${extension}\\`;\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            window.URL.revokeObjectURL(url);\r\n            document.body.removeChild(a);\r\n            \r\n        } catch (error) {\r\n            console.error('Error exportando archivo:', error);\r\n            alert('Error al exportar archivo: ' + error.message);\r\n        }\r\n    }\r\n    \r\n    // Cerrar men\u00FAs al hacer click fuera\r\n    document.addEventListener('click', function(event) {\r\n        if (!event.target.closest('.export-dropdown')) {\r\n            document.querySelectorAll('.dropdown-menu').forEach(menu => {\r\n                menu.style.display = 'none';\r\n            });\r\n        }\r\n    });\r\n    \r\n    function setupDateLimits() {\r\n        if (!permisosData || permisosData.length === 0) return;\r\n        \r\n        // Obtener todas las fechas de creaci\u00F3n de los permisos\r\n        const fechas = permisosData\r\n            .map(p => p.fecha_creacion)\r\n            .filter(f => f) // Filtrar fechas v\u00E1lidas\r\n            .map(f => new Date(f))\r\n            .filter(d => !isNaN(d.getTime())); // Filtrar fechas v\u00E1lidas\r\n        \r\n        if (fechas.length === 0) return;\r\n        \r\n        // Encontrar fecha m\u00EDnima y m\u00E1xima\r\n        const fechaMin = new Date(Math.min(...fechas));\r\n        const fechaMax = new Date(Math.max(...fechas));\r\n        \r\n        // Formatear para input type=\"date\" (YYYY-MM-DD)\r\n        const formatDate = (date) => {\r\n            return date.toISOString().split('T')[0];\r\n        };\r\n        \r\n        // Configurar l\u00EDmites en los inputs\r\n        const fechaDesde = document.getElementById('fechaDesde');\r\n        const fechaHasta = document.getElementById('fechaHasta');\r\n        \r\n        if (fechaDesde) {\r\n            fechaDesde.min = formatDate(fechaMin);\r\n            fechaDesde.max = formatDate(fechaMax);\r\n        }\r\n        \r\n        if (fechaHasta) {\r\n            fechaHasta.min = formatDate(fechaMin);\r\n            fechaHasta.max = formatDate(fechaMax);\r\n        }\r\n    }\r\n\r\n    function clearSearch() {\r\n        document.getElementById('searchPermiso').value = '';\r\n        document.getElementById('filterEstado').value = '';\r\n        document.getElementById('fechaDesde').value = '';\r\n        document.getElementById('fechaHasta').value = '';\r\n        displayPermisos();\r\n    }\r\n    \r\n    // ========================================================================\r\n    // APROBAR Y CERRAR PERMISOS\r\n    // ========================================================================\r\n    \r\n    window.aprobarPermiso = async function(permisoId) {\r\n        if (!confirm('\u00BFEst\u00E1 seguro de aprobar este permiso?')) return;\r\n        \r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/aprobar-permiso', {\r\n                method: 'POST',\r\n                body: JSON.stringify({\r\n                    permisoId: permisoId,\r\n                    usuarioAprobador: currentUser?.email || 'unknown'\r\n                })\r\n            });\r\n            \r\n            if (response.success) {\r\n                alert('Permiso aprobado exitosamente');\r\n                await loadPermisos();\r\n            } else {\r\n                alert('Error al aprobar el permiso: ' + (response.error || 'Error desconocido'));\r\n            }\r\n        } catch (error) {\r\n            console.error('Error aprobando permiso:', error);\r\n            alert('Error al aprobar el permiso');\r\n        }\r\n    };\r\n    \r\n    // Funci\u00F3n para abrir modal b\u00E1sico de aprobaci\u00F3n de cierre\r\n    window.openAprobarCierreModal = async function(permisoId, numeroPT) {\r\n        const decision = confirm('Desea APROBAR el cierre de este permiso?\\\\n\\\\nPermiso: ' + numeroPT + '\\\\n\\\\nOK = Aprobar\\\\nCancelar = Rechazar');\r\n        const accion = decision ? 'aprobar' : 'rechazar';\r\n        const observaciones = prompt('Observaciones del supervisor (opcional):') || '';\r\n        \r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/aprobar-cierre-permiso', {\r\n                method: 'POST',\r\n                body: JSON.stringify({\r\n                    permisoId: permisoId,\r\n                    accion: accion,\r\n                    observaciones: observaciones\r\n                })\r\n            });\r\n            \r\n            if (response.success) {\r\n                alert('Decisi\u00F3n registrada exitosamente');\r\n                await loadPermisos();\r\n            } else {\r\n                alert('Error: ' + (response.error || 'Error desconocido'));\r\n            }\r\n        } catch (error) {\r\n            console.error('Error en aprobaci\u00F3n:', error);\r\n            alert('Error de conexi\u00F3n');\r\n        }\r\n    };\r\n    \r\n    window.openCerrarModal = function(permisoId, numeroPT, planta, aerogenerador) {\r\n        document.getElementById('permisoInfoNumero').textContent = numeroPT;\r\n        document.getElementById('permisoInfoPlanta').textContent = planta;\r\n        document.getElementById('permisoInfoAerogenerador').textContent = aerogenerador;\r\n        \r\n        document.getElementById('fechaInicioTrabajos').value = '';\r\n        document.getElementById('fechaFinTrabajos').value = '';\r\n        document.getElementById('fechaParadaTurbina').value = '';\r\n        document.getElementById('fechaPuestaMarcha').value = '';\r\n        document.getElementById('observacionesCierre').value = 'Trabajo completado seg\u00FAn programaci\u00F3n';\r\n        materialesParaCierre = [];\r\n        updateMaterialesList();\r\n        \r\n        document.getElementById('confirmarCierreBtn').dataset.permisoId = permisoId;\r\n        document.getElementById('cerrarPermisoModal').style.display = 'flex';\r\n    };\r\n    \r\n    // Funci\u00F3n auxiliar para escapar comillas en strings de JavaScript\r\n    function escapeJsString(str) {\r\n        return (str || '').replace(/'/g, '\\\\'');\r\n    }\r\n    \r\n    // Funci\u00F3n para reenviar cierre rechazado\r\n    window.openReenviarCierreModal = async function(permisoId, numeroPT, planta, aerogenerador) {\r\n        try {\r\n            // Obtener detalles del permiso rechazado\r\n            const response = await ClientSecurity.makeSecureRequest('/permiso-detalle?id=' + permisoId);\r\n            if (!response.success) {\r\n                throw new Error('Error al obtener detalles del permiso: ' + (response.error || 'Error desconocido'));\r\n            }\r\n            const permiso = response.permiso;\r\n            \r\n            // Mostrar alerta informativa con el motivo de rechazo\r\n            if (permiso.motivo_rechazo) {\r\n                const confirmReenvio = confirm(\r\n                    'ATENCION: Este permiso fue RECHAZADO\\\\n\\\\n' +\r\n                    'MOTIVO DEL RECHAZO:\\\\n' + permiso.motivo_rechazo + '\\\\n\\\\n' +\r\n                    'Desea corregir los errores y reenviar el cierre?'\r\n                );\r\n                if (!confirmReenvio) return;\r\n            }\r\n            \r\n            // Pre-cargar el modal con datos anteriores\r\n            document.querySelector('#cerrarPermisoModal h3').textContent = '\uD83D\uDD04 REENVIAR CIERRE - ' + numeroPT;\r\n            document.getElementById('permisoInfoNumero').textContent = numeroPT;\r\n            document.getElementById('permisoInfoPlanta').textContent = planta;\r\n            document.getElementById('permisoInfoAerogenerador').textContent = aerogenerador;\r\n            \r\n            // Funci\u00F3n auxiliar para convertir fecha de forma segura\r\n            const safeDateToISOString = (dateString) => {\r\n                if (!dateString || dateString === null) return '';\r\n                try {\r\n                    const date = new Date(dateString + 'T00:00:00');\r\n                    if (isNaN(date.getTime())) return '';\r\n                    return date.toISOString().split('T')[0];\r\n                } catch (e) {\r\n                    return '';\r\n                }\r\n            };\r\n            \r\n            // Pre-poblar campos con datos existentes (verificando que existan)\r\n            const fechaInicioEl = document.getElementById('fechaInicioTrabajos');\r\n            if (fechaInicioEl) fechaInicioEl.value = safeDateToISOString(permiso.fecha_inicio_trabajos);\r\n            \r\n            const fechaFinEl = document.getElementById('fechaFinTrabajos');\r\n            if (fechaFinEl) fechaFinEl.value = safeDateToISOString(permiso.fecha_fin_trabajos);\r\n            \r\n            const fechaParadaEl = document.getElementById('fechaParadaTurbina');\r\n            if (fechaParadaEl) fechaParadaEl.value = safeDateToISOString(permiso.fecha_parada_turbina);\r\n            \r\n            const fechaPuestaEl = document.getElementById('fechaPuestaMarcha');\r\n            if (fechaPuestaEl) fechaPuestaEl.value = safeDateToISOString(permiso.fecha_puesta_marcha_turbina);\r\n            \r\n            // Agregar contexto de reenv\u00EDo a las observaciones\r\n            const observacionesEl = document.getElementById('observacionesCierre');\r\n            if (observacionesEl) {\r\n                const observacionesActuales = permiso.observaciones_cierre || 'Trabajo completado seg\u00FAn programaci\u00F3n';\r\n                const contextoReenvio = 'REENVIO - Correccion aplicada tras rechazo:\\\\n\"' + (permiso.motivo_rechazo || 'Sin motivo especifico') + '\"\\\\n\\\\n' + observacionesActuales;\r\n                observacionesEl.value = contextoReenvio;\r\n            }\r\n            \r\n            // Pre-cargar materiales existentes\r\n            materialesParaCierre = [];\r\n            if (permiso.materiales_detalle && permiso.materiales_detalle.length > 0) {\r\n                permiso.materiales_detalle.forEach(mat => {\r\n                    materialesParaCierre.push({\r\n                        descripcion: mat.material_nombre || '',\r\n                        cantidad: mat.material_cantidad || 1,\r\n                        propietario: mat.material_propietario || 'ENEL',\r\n                        almacen: mat.material_almacen || 'PRINCIPAL',\r\n                        numeroItem: mat.numero_item || '',\r\n                        numeroSerie: mat.numero_serie || ''\r\n                    });\r\n                });\r\n            }\r\n            updateMaterialesList();\r\n            \r\n            // Agregar banner informativo\r\n            const modal = document.getElementById('cerrarPermisoModal');\r\n            if (!modal) {\r\n                throw new Error('Modal de cierre no encontrado');\r\n            }\r\n            let banner = modal.querySelector('.reenvio-banner');\r\n            if (!banner) {\r\n                banner = document.createElement('div');\r\n                banner.className = 'reenvio-banner';\r\n                banner.style.cssText = \r\n                    'background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); ' +\r\n                    'border: 2px solid #ffc107; ' +\r\n                    'border-radius: 8px; ' +\r\n                    'padding: 15px; ' +\r\n                    'margin: 0 0 20px 0; ' +\r\n                    'color: #856404; ' +\r\n                    'font-weight: 600; ' +\r\n                    'box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);';\r\n                banner.innerHTML = \r\n                    '<div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 8px;\">' +\r\n                        '<span style=\"font-size: 20px;\">\uD83D\uDD04</span>' +\r\n                        '<span style=\"font-size: 16px;\">MODO REENV\u00CDO - CIERRE RECHAZADO</span>' +\r\n                    '</div>' +\r\n                    '<div style=\"font-size: 13px; font-weight: 500; line-height: 1.4;\">' +\r\n                        '\u26A0\uFE0F Este permiso fue rechazado previamente. Revise y corrija los datos antes de reenviar.' +\r\n                    '</div>';\r\n                const modalContent = modal.querySelector('.modal-content');\r\n                if (modalContent && modalContent.firstElementChild) {\r\n                    const firstChild = modalContent.firstElementChild;\r\n                    firstChild.parentNode.insertBefore(banner, firstChild.nextSibling);\r\n                } else {\r\n                    // Si no encuentra .modal-content, insertarlo al inicio del modal\r\n                    modal.insertBefore(banner, modal.firstChild);\r\n                }\r\n            }\r\n            \r\n            const confirmarBtn = document.getElementById('confirmarCierreBtn');\r\n            if (confirmarBtn) confirmarBtn.dataset.permisoId = permisoId;\r\n            \r\n            if (modal) modal.style.display = 'flex';\r\n            \r\n        } catch (error) {\r\n            console.error('Error al abrir modal de reenv\u00EDo:', error);\r\n            alert('Error al cargar los datos del permiso. Intente nuevamente.');\r\n        }\r\n    };\r\n    \r\n    function closeCerrarModal() {\r\n        // Limpiar banner de reenv\u00EDo al cerrar\r\n        const modal = document.getElementById('cerrarPermisoModal');\r\n        const banner = modal.querySelector('.reenvio-banner');\r\n        if (banner) {\r\n            banner.remove();\r\n        }\r\n        \r\n        // Restaurar t\u00EDtulo original\r\n        document.querySelector('#cerrarPermisoModal h3').textContent = 'CERRAR PERMISO DE TRABAJO';\r\n        document.getElementById('permisoInfoNumero').textContent = '';\r\n        document.getElementById('permisoInfoPlanta').textContent = '';\r\n        document.getElementById('permisoInfoAerogenerador').textContent = '';\r\n        \r\n        document.getElementById('cerrarPermisoModal').style.display = 'none';\r\n    }\r\n    \r\n    function addMaterial() {\r\n        const descripcion = ClientSecurity.sanitizeInput(document.getElementById('materialDescripcion').value);\r\n        const cantidad = parseInt(document.getElementById('materialCantidad').value) || 1;\r\n        const propietario = document.getElementById('materialPropietario').value;\r\n        const almacen = document.getElementById('materialAlmacen').value;\r\n        const numeroItem = ClientSecurity.sanitizeInput(document.getElementById('materialNumeroItem').value);\r\n        const numeroSerie = ClientSecurity.sanitizeInput(document.getElementById('materialNumeroSerie').value);\r\n        \r\n        if (!descripcion) {\r\n            alert('Ingrese la descripci\u00F3n del material');\r\n            return;\r\n        }\r\n        \r\n        materialesParaCierre.push({\r\n            descripcion,\r\n            cantidad,\r\n            propietario,\r\n            almacen,\r\n            numeroItem,\r\n            numeroSerie\r\n        });\r\n        \r\n        document.getElementById('materialDescripcion').value = '';\r\n        document.getElementById('materialCantidad').value = '1';\r\n        document.getElementById('materialNumeroItem').value = '';\r\n        document.getElementById('materialNumeroSerie').value = '';\r\n        \r\n        updateMaterialesList();\r\n    }\r\n    \r\n    function updateMaterialesList() {\r\n        const container = document.getElementById('materialesLista');\r\n        \r\n        if (materialesParaCierre.length === 0) {\r\n            container.innerHTML = '<div style=\"padding: 20px; text-align: center; color: var(--text-secondary);\">No hay materiales agregados</div>';\r\n            return;\r\n        }\r\n        \r\n        container.innerHTML = '';\r\n        materialesParaCierre.forEach((material, index) => {\r\n            const item = document.createElement('div');\r\n            item.style.cssText = 'padding: 12px; border-bottom: 1px solid var(--border-color);';\r\n            item.innerHTML = \\`\r\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\r\n                    <div>\r\n                        <strong>\\${material.descripcion}</strong><br>\r\n                        <small>Cantidad: \\${material.cantidad} | Propietario: \\${material.propietario} | Almac\u00E9n: \\${material.almacen}</small>\r\n                        \\${material.numeroItem ? \\`<br><small>Item: \\${material.numeroItem}</small>\\` : ''}\r\n                        \\${material.numeroSerie ? \\`<br><small>Serie: \\${material.numeroSerie}</small>\\` : ''}\r\n                    </div>\r\n                    <button onclick=\"removeMaterial(\\${index})\" class=\"btn btn-danger btn-small\">X</button>\r\n                </div>\r\n            \\`;\r\n            container.appendChild(item);\r\n        });\r\n    }\r\n    \r\n    window.removeMaterial = function(index) {\r\n        materialesParaCierre.splice(index, 1);\r\n        updateMaterialesList();\r\n    };\r\n    \r\n    async function handleConfirmarCierre() {\r\n        const permisoId = parseInt(document.getElementById('confirmarCierreBtn').dataset.permisoId);\r\n        const fechaFinTrabajos = document.getElementById('fechaFinTrabajos').value;\r\n        \r\n        if (!fechaFinTrabajos) {\r\n            alert('La fecha de fin de trabajos es obligatoria');\r\n            return;\r\n        }\r\n        \r\n        if (!confirm('\u00BFEst\u00E1 seguro de cerrar este permiso?')) return;\r\n        \r\n        const cierreData = {\r\n            permisoId: permisoId,\r\n            usuarioCierre: currentUser?.email || 'unknown',\r\n            fechaInicioTrabajos: document.getElementById('fechaInicioTrabajos').value,\r\n            fechaFinTrabajos: fechaFinTrabajos,\r\n            fechaParadaTurbina: document.getElementById('fechaParadaTurbina').value,\r\n            fechaPuestaMarcha: document.getElementById('fechaPuestaMarcha').value,\r\n            observacionesCierre: ClientSecurity.sanitizeInput(document.getElementById('observacionesCierre').value),\r\n            materiales: materialesParaCierre\r\n        };\r\n        \r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/cerrar-permiso', {\r\n                method: 'POST',\r\n                body: JSON.stringify(cierreData)\r\n            });\r\n            \r\n            if (response.success) {\r\n                alert('Permiso cerrado exitosamente');\r\n                closeCerrarModal();\r\n                await loadPermisos();\r\n            } else {\r\n                alert('Error al cerrar el permiso: ' + (response.error || 'Error desconocido'));\r\n            }\r\n        } catch (error) {\r\n            console.error('Error cerrando permiso:', error);\r\n            alert('Error al cerrar el permiso');\r\n        }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // GENERAR REGISTRO PDF (sin cambios)\r\n    // ========================================================================\r\n    \r\n    async function generateRegister() {\r\n        const plantaSelect = document.getElementById('planta');\r\n        const aerogeneradorSelect = document.getElementById('aerogenerador');\r\n        const jefeFaenaSelect = document.getElementById('jefeFaena');\r\n        \r\n        const data = {\r\n            planta: plantaSelect.value,\r\n            aerogenerador: aerogeneradorSelect.value,\r\n            descripcion: document.getElementById('descripcion').value,\r\n            jefeFaena: jefeFaenaSelect.value,\r\n            tipoMantenimiento: document.getElementById('tipoMantenimiento').value,\r\n            tipoMantenimientoOtros: document.getElementById('tipoOtros').value,\r\n            personal: personalSeleccionado,\r\n            actividadesRutinarias: actividadesSeleccionadas.filter(a => a.tipo === 'RUTINARIA').map(a => a.nombre)\r\n        };\r\n        \r\n        if (!data.planta || !data.descripcion || !data.jefeFaena) {\r\n            alert('Complete los campos obligatorios antes de generar el registro');\r\n            return;\r\n        }\r\n        \r\n        try {\r\n            const response = await fetch(API_BASE + '/generate-register', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': authToken ? 'Bearer ' + authToken : ''\r\n                },\r\n                body: JSON.stringify(data)\r\n            });\r\n            \r\n            if (response.ok) {\r\n                const html = await response.text();\r\n                const newWindow = window.open('', '_blank');\r\n                newWindow.document.write(html);\r\n                newWindow.document.close();\r\n            } else {\r\n                alert('Error al generar el registro');\r\n            }\r\n        } catch (error) {\r\n            console.error('Error generando registro:', error);\r\n            alert('Error al generar el registro');\r\n        }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // FUNCIONES AUXILIARES\r\n    // ========================================================================\r\n    \r\n    function switchTab(tabName) {\r\n        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));\r\n        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));\r\n        \r\n        document.querySelector('[data-tab=\"' + tabName + '\"]').classList.add('active');\r\n        document.getElementById('tab-' + tabName).classList.add('active');\r\n        \r\n        if (tabName === 'datos' && currentUser?.rol === 'ADMIN') {\r\n            loadDatosTab();\r\n        } else if (tabName === 'admin-usuarios' && currentUser?.rol === 'ADMIN') {\r\n            loadUsuarios();\r\n        }\r\n    }\r\n    \r\n    async function loadDatosTab() {\r\n        const parquesContainer = document.getElementById('parquesContainer');\r\n        if (parquesContainer && parquesData) {\r\n            parquesContainer.innerHTML = '<p>Total: ' + parquesData.length + ' parques</p>';\r\n            parquesData.forEach(parque => {\r\n                parquesContainer.innerHTML += '<div>\u2022 ' + parque.nombre + '</div>';\r\n            });\r\n        }\r\n        \r\n        const personalContainer = document.getElementById('personalContainer');\r\n        if (personalContainer && personalData) {\r\n            personalContainer.innerHTML = '<p>Total: ' + personalData.length + ' personas</p>';\r\n        }\r\n        \r\n        const supervisoresContainer = document.getElementById('supervisoresContainer');\r\n        if (supervisoresContainer && supervisoresData) {\r\n            supervisoresContainer.innerHTML = '<p>Total: ' + supervisoresData.length + ' supervisores</p>';\r\n        }\r\n        \r\n        const actividadesContainer = document.getElementById('actividadesContainer');\r\n        if (actividadesContainer && actividadesData) {\r\n            actividadesContainer.innerHTML = '<p>Total: ' + actividadesData.length + ' actividades</p>';\r\n        }\r\n    }\r\n    \r\n    function formatDate(dateString) {\r\n        if (!dateString) return 'N/A';\r\n        \r\n        try {\r\n            const date = new Date(dateString);\r\n            return date.toLocaleDateString('es-CL', {\r\n                year: 'numeric',\r\n                month: '2-digit',\r\n                day: '2-digit',\r\n                hour: '2-digit',\r\n                minute: '2-digit'\r\n            });\r\n        } catch (error) {\r\n            return 'Fecha inv\u00E1lida';\r\n        }\r\n    }\r\n    \r\n    async function checkConnectionStatus() {\r\n        const statusDiv = document.getElementById('connectionStatus');\r\n        \r\n        try {\r\n            const response = await fetch(API_BASE + '/health');\r\n            const data = await response.json();\r\n            \r\n            if (data.status === 'OK') {\r\n                statusDiv.textContent = 'Sistema conectado y operativo';\r\n                statusDiv.className = 'status-indicator status-online';\r\n            } else {\r\n                statusDiv.textContent = 'Sistema con problemas de conexi\u00F3n';\r\n                statusDiv.className = 'status-indicator status-offline';\r\n            }\r\n        } catch (error) {\r\n            statusDiv.textContent = 'Sin conexi\u00F3n al servidor';\r\n            statusDiv.className = 'status-indicator status-offline';\r\n        }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // AUTO-LOGOUT POR INACTIVIDAD\r\n    // ========================================================================\r\n    \r\n    function resetInactivityTimer() {\r\n        clearTimeout(inactivityTimer);\r\n        inactivityTimer = setTimeout(() => {\r\n            alert('Su sesi\u00F3n ha expirado por inactividad');\r\n            handleLogout();\r\n        }, INACTIVITY_TIMEOUT);\r\n    }\r\n    \r\n    ['mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {\r\n        document.addEventListener(event, resetInactivityTimer);\r\n    });\r\n    \r\n    resetInactivityTimer();\r\n    \r\n    // ========================================================================\r\n    // FUNCIONES DE EXPORTACI\u00D3N CON MODAL\r\n    // ========================================================================\r\n    \r\n    let currentExportPermisoId = null;\r\n    let currentExportPermisoInfo = null;\r\n    \r\n    window.openExportModal = function(permisoId, permisoInfo) {\r\n        currentExportPermisoId = permisoId;\r\n        currentExportPermisoInfo = permisoInfo;\r\n        \r\n        document.getElementById('exportPermisoInfo').textContent = permisoInfo || \\`ID: \\${permisoId}\\`;\r\n        document.getElementById('exportModal').style.display = 'flex';\r\n        \r\n        // Reset status\r\n        document.getElementById('exportStatus').style.display = 'none';\r\n        document.getElementById('exportExcelBtn').disabled = false;\r\n        document.getElementById('exportPdfBtn').disabled = false;\r\n    };\r\n    \r\n    window.closeExportModal = function() {\r\n        document.getElementById('exportModal').style.display = 'none';\r\n        currentExportPermisoId = null;\r\n        currentExportPermisoInfo = null;\r\n    };\r\n    \r\n    async function executeExport(formato) {\r\n        if (!currentExportPermisoId) return;\r\n        \r\n        try {\r\n            // Mostrar estado de carga\r\n            document.getElementById('exportStatus').style.display = 'block';\r\n            document.getElementById('exportStatusText').textContent = \\`Generando \\${formato.toUpperCase()}...\\`;\r\n            document.getElementById('exportExcelBtn').disabled = true;\r\n            document.getElementById('exportPdfBtn').disabled = true;\r\n            \r\n            const fechaActual = new Date().toISOString().split('T')[0].replace(/-/g, '');\r\n            let endpoint, filename;\r\n            if (formato === 'excel') {\r\n                endpoint = \\`\\${API_BASE}/exportar-permiso-excel?id=\\${currentExportPermisoId}\\`;\r\n                filename = \\`\\${currentExportPermisoInfo}_\\${fechaActual}.csv\\`;\r\n            } else {\r\n                endpoint = \\`\\${API_BASE}/exportar-permiso-pdf?id=\\${currentExportPermisoId}\\`;\r\n                filename = \\`\\${currentExportPermisoInfo}_\\${fechaActual}.html\\`;\r\n            }\r\n            \r\n            const response = await fetch(endpoint, {\r\n                headers: {\r\n                    'Authorization': 'Bearer ' + authToken\r\n                }\r\n            });\r\n            \r\n            if (!response.ok) {\r\n                const errorData = await response.json().catch(() => ({ error: 'Error desconocido' }));\r\n                throw new Error(errorData.error || \\`Error HTTP: \\${response.status}\\`);\r\n            }\r\n            \r\n            // DIFERENCIACI\u00D3N: PDF vs Excel\r\n            if (formato === 'pdf') {\r\n                // Para PDF (HTML): Abrir en nueva ventana como generateRegister\r\n                document.getElementById('exportStatusText').textContent = 'Abriendo vista para imprimir...';\r\n                \r\n                const html = await response.text();\r\n                const newWindow = window.open('', '_blank');\r\n                newWindow.document.write(html);\r\n                newWindow.document.close();\r\n                \r\n                // Reset UI y cerrar modal inmediatamente\r\n                document.getElementById('exportStatus').style.display = 'none';\r\n                document.getElementById('exportExcelBtn').disabled = false;\r\n                document.getElementById('exportPdfBtn').disabled = false;\r\n                showMessage('PDF abierto para imprimir', 'success');\r\n                closeExportModal();\r\n                \r\n            } else {\r\n                // Para Excel: Descargar archivo como antes\r\n                document.getElementById('exportStatusText').textContent = 'Descargando archivo...';\r\n                \r\n                const blob = await response.blob();\r\n                \r\n                // Verificar que el blob tiene contenido\r\n                if (blob.size === 0) {\r\n                    throw new Error('El archivo generado est\u00E1 vac\u00EDo');\r\n                }\r\n                \r\n                const url = window.URL.createObjectURL(blob);\r\n                const a = document.createElement('a');\r\n                a.href = url;\r\n                a.download = filename;\r\n                a.style.display = 'none';\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                \r\n                // Cleanup\r\n                setTimeout(() => {\r\n                    window.URL.revokeObjectURL(url);\r\n                    document.body.removeChild(a);\r\n                }, 100);\r\n                \r\n                // Reset UI y cerrar modal despu\u00E9s de la descarga\r\n                document.getElementById('exportStatusText').textContent = 'Descarga completada';\r\n                setTimeout(() => {\r\n                    document.getElementById('exportStatus').style.display = 'none';\r\n                    document.getElementById('exportExcelBtn').disabled = false;\r\n                    document.getElementById('exportPdfBtn').disabled = false;\r\n                    showMessage(\\`Archivo \\${formato.toUpperCase()} descargado exitosamente\\`, 'success');\r\n                    closeExportModal();\r\n                }, 1500);\r\n            }\r\n            \r\n        } catch (error) {\r\n            console.error('Error exportando:', error);\r\n            showMessage(\\`Error al generar archivo \\${formato.toUpperCase()}: \\${error.message}\\`, 'error');\r\n            \r\n            // Reset UI\r\n            document.getElementById('exportStatus').style.display = 'none';\r\n            document.getElementById('exportExcelBtn').disabled = false;\r\n            document.getElementById('exportPdfBtn').disabled = false;\r\n        }\r\n    }\r\n    \r\n    // Funci\u00F3n auxiliar para mostrar mensajes\r\n    function showMessage(message, type = 'info') {\r\n        // Usar alert simple por ahora\r\n        alert(message);\r\n    }\r\n    \r\n    // Event listeners para el modal de exportaci\u00F3n\r\n    document.addEventListener('DOMContentLoaded', function() {\r\n        const exportExcelBtn = document.getElementById('exportExcelBtn');\r\n        const exportPdfBtn = document.getElementById('exportPdfBtn');\r\n        const cancelExportBtn = document.getElementById('cancelExportBtn');\r\n        \r\n        if (exportExcelBtn) {\r\n            exportExcelBtn.addEventListener('click', () => executeExport('excel'));\r\n        }\r\n        \r\n        if (exportPdfBtn) {\r\n            exportPdfBtn.addEventListener('click', () => executeExport('pdf'));\r\n        }\r\n        \r\n        if (cancelExportBtn) {\r\n            cancelExportBtn.addEventListener('click', closeExportModal);\r\n        }\r\n        \r\n        // Cerrar modal al hacer clic fuera\r\n        const exportModal = document.getElementById('exportModal');\r\n        if (exportModal) {\r\n            exportModal.addEventListener('click', function(event) {\r\n                if (event.target === exportModal) {\r\n                    closeExportModal();\r\n                }\r\n            });\r\n        }\r\n    });\r\n    \r\n    // Funci\u00F3n para editar un permiso existente\r\n    window.editarPermiso = async function(permisoId) {\r\n        console.log('Iniciando edici\u00F3n de permiso ID:', permisoId);\r\n        try {\r\n            // Obtener los datos completos del permiso\r\n            const response = await ClientSecurity.makeSecureRequest(\\`/permiso-detalle?id=\\${permisoId}\\`);\r\n            \r\n            if (!response.success) {\r\n                alert('Error al cargar los datos del permiso: ' + (response.error || 'Error desconocido'));\r\n                return;\r\n            }\r\n            \r\n            const permiso = response.permiso;\r\n            \r\n            // Verificar que el permiso est\u00E9 en estado CREADO\r\n            if (permiso.estado !== 'CREADO') {\r\n                alert('Solo se pueden editar permisos en estado CREADO');\r\n                return;\r\n            }\r\n            \r\n            // Cambiar a la pesta\u00F1a de nuevo permiso\r\n            const nuevoTab = document.querySelector('[data-tab=\"nuevo\"]');\r\n            const tabs = document.querySelectorAll('.tab');\r\n            const contents = document.querySelectorAll('.tab-content');\r\n            \r\n            tabs.forEach(tab => tab.classList.remove('active'));\r\n            contents.forEach(content => content.classList.remove('active'));\r\n            \r\n            nuevoTab.classList.add('active');\r\n            document.getElementById('tab-nuevo').classList.add('active');\r\n            \r\n            // Rellenar el formulario con los datos del permiso\r\n            await llenarFormularioEdicion(permiso);\r\n            \r\n            // Indicar que se est\u00E1 editando\r\n            window.permisoEditando = permisoId;\r\n            const submitBtn = document.querySelector('#permisoForm button[type=\"submit\"]');\r\n            console.log('Bot\u00F3n encontrado:', submitBtn);\r\n            if (submitBtn) {\r\n                submitBtn.textContent = 'ACTUALIZAR PERMISO DE TRABAJO';\r\n                console.log('Texto del bot\u00F3n cambiado a:', submitBtn.textContent);\r\n            } else {\r\n                console.error('No se encontr\u00F3 el bot\u00F3n de submit');\r\n            }\r\n            \r\n            alert('Permiso cargado para edici\u00F3n');\r\n            \r\n        } catch (error) {\r\n            console.error('Error editando permiso:', error);\r\n            alert('Error al cargar el permiso para edici\u00F3n: ' + error.message);\r\n        }\r\n    };\r\n    \r\n    async function llenarFormularioEdicion(permiso) {\r\n        console.log('Llenando formulario para edici\u00F3n con permiso:', permiso);\r\n        // Llenar campos b\u00E1sicos\r\n        document.getElementById('planta').value = permiso.planta_id || '';\r\n        document.getElementById('descripcion').value = permiso.descripcion || '';\r\n        document.getElementById('tipoMantenimiento').value = permiso.tipo_mantenimiento || '';\r\n        \r\n        if (permiso.tipo_mantenimiento === 'OTROS' && permiso.tipo_otros) {\r\n            document.getElementById('tipoOtros').value = permiso.tipo_otros;\r\n            document.getElementById('tipoOtrosContainer').style.display = 'block';\r\n        }\r\n        \r\n        // Disparar eventos para cargar datos dependientes\r\n        if (permiso.planta_id) {\r\n            // Simular evento de cambio de planta para cargar aerogeneradores y personal\r\n            const plantaSelect = document.getElementById('planta');\r\n            const fakeEvent = { target: plantaSelect };\r\n            await handlePlantaChange(fakeEvent);\r\n            \r\n            // Seleccionar aerogenerador\r\n            if (permiso.aerogenerador_id) {\r\n                document.getElementById('aerogenerador').value = permiso.aerogenerador_id;\r\n            }\r\n            \r\n            // Seleccionar jefe de faena\r\n            if (permiso.jefe_faena_id) {\r\n                document.getElementById('jefeFaena').value = permiso.jefe_faena_id;\r\n            }\r\n            \r\n            // Seleccionar supervisor\r\n            if (permiso.supervisor_parque_id) {\r\n                document.getElementById('supervisorParque').value = permiso.supervisor_parque_id;\r\n            }\r\n        }\r\n        \r\n        // Marcar actividades seleccionadas\r\n        if (permiso.actividades_ids) {\r\n            const actividadIds = permiso.actividades_ids.split(',').map(id => id.trim());\r\n            actividadIds.forEach(actividadId => {\r\n                const checkbox = document.querySelector(\\`input[name=\"actividades\"][value=\"\\${actividadId}\"]\\`);\r\n                if (checkbox) {\r\n                    checkbox.checked = true;\r\n                }\r\n            });\r\n            \r\n            // Actualizar matriz de riesgos\r\n            updateMatrizDisplay();\r\n        }\r\n        \r\n        // Cargar personal seleccionado\r\n        if (permiso.personal_ids) {\r\n            personalSeleccionado = [];\r\n            const personalIds = permiso.personal_ids.split(',').map(id => id.trim());\r\n            \r\n            // Buscar el personal en los datos cargados\r\n            const plantaNombre = document.querySelector('#planta option:checked')?.textContent;\r\n            if (plantaNombre && personalByParque[plantaNombre]) {\r\n                personalIds.forEach(personalId => {\r\n                    const persona = personalByParque[plantaNombre].find(p => p.id.toString() === personalId);\r\n                    if (persona) {\r\n                        personalSeleccionado.push(persona);\r\n                    }\r\n                });\r\n                \r\n                // Actualizar la vista del personal seleccionado\r\n                const seleccionadoContainer = document.getElementById('personalSeleccionado');\r\n                if (seleccionadoContainer && personalSeleccionado.length > 0) {\r\n                    seleccionadoContainer.innerHTML = '';\r\n                    personalSeleccionado.forEach(persona => {\r\n                        const item = document.createElement('div');\r\n                        item.className = 'selector-item';\r\n                        item.innerHTML = '<strong>' + persona.nombre + '</strong><br><small>' + (persona.empresa || 'Sin empresa') + ' - ' + (persona.rol || 'Sin rol') + '</small>';\r\n                        item.dataset.id = persona.id;\r\n                        item.dataset.nombre = persona.nombre;\r\n                        item.dataset.empresa = persona.empresa || '';\r\n                        item.dataset.rol = persona.rol || '';\r\n                        item.dataset.rut = persona.rut || '';\r\n                        item.addEventListener('click', () => togglePersonalSelection(item));\r\n                        seleccionadoContainer.appendChild(item);\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    // ========================================================================\r\n    // DETECCI\u00D3N DE ACTIVIDAD PARA AUTO-LOGOUT\r\n    // ========================================================================\r\n    \r\n    // Eventos que indican actividad del usuario\r\n    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];\r\n    \r\n    function setupActivityListeners() {\r\n        activityEvents.forEach(event => {\r\n            document.addEventListener(event, resetInactivityTimer, true);\r\n        });\r\n    }\r\n    \r\n    // Configurar listeners cuando se cargue la aplicaci\u00F3n\r\n    if (typeof window !== 'undefined') {\r\n        setupActivityListeners();\r\n    }\r\n    \r\n    // ========================================================================\r\n    // ADMINISTRACI\u00D3N DE USUARIOS\r\n    // ========================================================================\r\n    \r\n    let usuarioEditando = null;\r\n    \r\n    async function loadUsuarios() {\r\n        const container = document.getElementById('usuariosContainer');\r\n        if (!container) return;\r\n        \r\n        try {\r\n            container.innerHTML = '<div class=\"loading\">Cargando usuarios...</div>';\r\n            \r\n            const response = await ClientSecurity.makeSecureRequest('/admin-users');\r\n            \r\n            if (!response.success) {\r\n                container.innerHTML = '<div class=\"error\">Error al cargar usuarios: ' + (response.error || 'Error desconocido') + '</div>';\r\n                return;\r\n            }\r\n            \r\n            const usuarios = response.users || [];\r\n            \r\n            if (usuarios.length === 0) {\r\n                container.innerHTML = '<div class=\"no-data\">No hay usuarios registrados</div>';\r\n                return;\r\n            }\r\n            \r\n            // Crear tabla de usuarios\r\n            let html = '';\r\n            html += '<div class=\"table-responsive\">';\r\n            html += '<table class=\"data-table\">';\r\n            html += '<thead>';\r\n            html += '<tr>';\r\n            html += '<th>Usuario</th>';\r\n            html += '<th>Email</th>';\r\n            html += '<th>Rol</th>';\r\n            html += '<th>Empresa</th>';\r\n            html += '<th>Parques Autorizados</th>';\r\n            html += '<th>Estado</th>';\r\n            html += '<th>Password Temporal</th>';\r\n            html += '<th>Acciones</th>';\r\n            html += '</tr>';\r\n            html += '</thead>';\r\n            html += '<tbody>';\r\n            \r\n            usuarios.forEach(usuario => {\r\n                html += '<tr>';\r\n                html += '<td>' + ClientSecurity.encodeHTML(usuario.usuario || '') + '</td>';\r\n                html += '<td>' + ClientSecurity.encodeHTML(usuario.email || '') + '</td>';\r\n                html += '<td><span class=\"badge badge-' + getRoleBadgeClass(usuario.rol) + '\">' + ClientSecurity.encodeHTML(usuario.rol || '') + '</span></td>';\r\n                html += '<td>' + ClientSecurity.encodeHTML(usuario.empresa || '') + '</td>';\r\n                html += '<td>' + ClientSecurity.encodeHTML(usuario.parques_autorizados || '') + '</td>';\r\n                html += '<td><span class=\"badge badge-' + (usuario.estado === 'Activo' ? 'success' : 'danger') + '\">' + ClientSecurity.encodeHTML(usuario.estado || '') + '</span></td>';\r\n                html += '<td><span class=\"badge badge-' + (usuario.password_temporal ? 'warning' : 'success') + '\">' + (usuario.password_temporal ? 'S\u00ED' : 'No') + '</span></td>';\r\n                html += '<td>';\r\n                html += '<button class=\"btn btn-small btn-secondary\" onclick=\"editarUsuario(' + usuario.id + ')\" title=\"Editar\">\u270F\uFE0F</button>';\r\n                html += '<button class=\"btn btn-small btn-danger\" onclick=\"confirmarEliminarUsuario(' + usuario.id + ', &#39;' + ClientSecurity.encodeHTML(usuario.usuario) + '&#39;)\" title=\"Eliminar\" style=\"margin-left: 4px;\">\uD83D\uDDD1\uFE0F</button>';\r\n                html += '</td>';\r\n                html += '</tr>';\r\n            });\r\n            \r\n            html += '</tbody></table></div>';\r\n            container.innerHTML = html;\r\n            \r\n        } catch (error) {\r\n            console.error('Error cargando usuarios:', error);\r\n            container.innerHTML = '<div class=\"error\">Error de conexi\u00F3n al cargar usuarios</div>';\r\n        }\r\n    }\r\n    \r\n    function getRoleBadgeClass(rol) {\r\n        switch(rol?.toLowerCase()) {\r\n            case 'admin': return 'primary';\r\n            case 'supervisor': return 'warning';\r\n            case 'operador': return 'info';\r\n            default: return 'secondary';\r\n        }\r\n    }\r\n    \r\n    function openNuevoUsuarioModal() {\r\n        usuarioEditando = null;\r\n        document.getElementById('usuarioModalTitle').textContent = 'Nuevo Usuario';\r\n        document.getElementById('usuarioForm').reset();\r\n        document.getElementById('modalPassword').placeholder = 'Contrase\u00F1a requerida';\r\n        document.getElementById('modalPassword').required = true;\r\n        document.getElementById('usuarioError').style.display = 'none';\r\n        document.getElementById('usuarioModal').style.display = 'flex';\r\n    }\r\n    \r\n    async function editarUsuario(userId) {\r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/admin-users/' + userId);\r\n            \r\n            if (!response.success) {\r\n                alert('Error al cargar datos del usuario: ' + (response.error || 'Error desconocido'));\r\n                return;\r\n            }\r\n            \r\n            const usuario = response.user;\r\n            usuarioEditando = userId;\r\n            \r\n            document.getElementById('usuarioModalTitle').textContent = 'Editar Usuario';\r\n            document.getElementById('modalUsuario').value = usuario.usuario || '';\r\n            document.getElementById('modalEmail').value = usuario.email || '';\r\n            document.getElementById('modalPassword').value = '';\r\n            document.getElementById('modalPassword').placeholder = 'Dejar vac\u00EDo para mantener actual';\r\n            document.getElementById('modalPassword').required = false;\r\n            document.getElementById('modalRol').value = usuario.rol || '';\r\n            document.getElementById('modalEmpresa').value = usuario.empresa || '';\r\n            document.getElementById('modalParquesAutorizados').value = usuario.parques_autorizados || '';\r\n            document.getElementById('modalEstado').value = usuario.estado || 'Activo';\r\n            document.getElementById('modalPasswordTemporal').checked = usuario.password_temporal || false;\r\n            document.getElementById('usuarioError').style.display = 'none';\r\n            document.getElementById('usuarioModal').style.display = 'flex';\r\n            \r\n        } catch (error) {\r\n            console.error('Error cargando usuario:', error);\r\n            alert('Error de conexi\u00F3n al cargar usuario');\r\n        }\r\n    }\r\n    \r\n    async function handleGuardarUsuario(e) {\r\n        e.preventDefault();\r\n        \r\n        const errorDiv = document.getElementById('usuarioError');\r\n        const submitBtn = document.getElementById('guardarUsuarioBtn');\r\n        \r\n        errorDiv.style.display = 'none';\r\n        submitBtn.disabled = true;\r\n        submitBtn.textContent = 'Guardando...';\r\n        \r\n        try {\r\n            const formData = {\r\n                usuario: ClientSecurity.sanitizeInput(document.getElementById('modalUsuario').value),\r\n                email: ClientSecurity.sanitizeInput(document.getElementById('modalEmail').value),\r\n                rol: document.getElementById('modalRol').value,\r\n                empresa: ClientSecurity.sanitizeInput(document.getElementById('modalEmpresa').value) || null,\r\n                parques_autorizados: ClientSecurity.sanitizeInput(document.getElementById('modalParquesAutorizados').value) || null,\r\n                estado: document.getElementById('modalEstado').value,\r\n                password_temporal: document.getElementById('modalPasswordTemporal').checked\r\n            };\r\n            \r\n            const password = document.getElementById('modalPassword').value;\r\n            if (password) {\r\n                formData.password = password;\r\n            }\r\n            \r\n            // Validaciones\r\n            if (!formData.usuario || !formData.email || !formData.rol) {\r\n                errorDiv.textContent = 'Los campos Usuario, Email y Rol son requeridos';\r\n                errorDiv.style.display = 'block';\r\n                return;\r\n            }\r\n            \r\n            if (!usuarioEditando && !password) {\r\n                errorDiv.textContent = 'La contrase\u00F1a es requerida para nuevos usuarios';\r\n                errorDiv.style.display = 'block';\r\n                return;\r\n            }\r\n            \r\n            const url = usuarioEditando ? '/admin-users/' + usuarioEditando : '/admin-users';\r\n            const method = usuarioEditando ? 'PUT' : 'POST';\r\n            \r\n            const response = await ClientSecurity.makeSecureRequest(url, {\r\n                method,\r\n                body: JSON.stringify(formData)\r\n            });\r\n            \r\n            if (!response.success) {\r\n                errorDiv.textContent = response.error || 'Error desconocido';\r\n                errorDiv.style.display = 'block';\r\n                return;\r\n            }\r\n            \r\n            closeUsuarioModal();\r\n            await loadUsuarios();\r\n            showSuccessMessage(usuarioEditando ? 'Usuario actualizado correctamente' : 'Usuario creado correctamente');\r\n            \r\n        } catch (error) {\r\n            console.error('Error guardando usuario:', error);\r\n            errorDiv.textContent = 'Error de conexi\u00F3n';\r\n            errorDiv.style.display = 'block';\r\n        } finally {\r\n            submitBtn.disabled = false;\r\n            submitBtn.textContent = 'Guardar Usuario';\r\n        }\r\n    }\r\n    \r\n    function closeUsuarioModal() {\r\n        document.getElementById('usuarioModal').style.display = 'none';\r\n        usuarioEditando = null;\r\n    }\r\n    \r\n    let usuarioIdEliminar = null;\r\n    \r\n    function confirmarEliminarUsuario(userId, userName) {\r\n        usuarioIdEliminar = userId;\r\n        document.getElementById('usuarioEliminarInfo').textContent = 'Usuario: ' + userName;\r\n        document.getElementById('confirmarEliminarUsuarioModal').style.display = 'flex';\r\n    }\r\n    \r\n    async function handleEliminarUsuario() {\r\n        if (!usuarioIdEliminar) return;\r\n        \r\n        const confirmarBtn = document.getElementById('confirmarEliminarUsuarioBtn');\r\n        confirmarBtn.disabled = true;\r\n        confirmarBtn.textContent = 'Eliminando...';\r\n        \r\n        try {\r\n            const response = await ClientSecurity.makeSecureRequest('/admin-users/' + usuarioIdEliminar, {\r\n                method: 'DELETE'\r\n            });\r\n            \r\n            if (!response.success) {\r\n                alert('Error al eliminar usuario: ' + (response.error || 'Error desconocido'));\r\n                return;\r\n            }\r\n            \r\n            closeConfirmarEliminarModal();\r\n            await loadUsuarios();\r\n            showSuccessMessage('Usuario eliminado correctamente');\r\n            \r\n        } catch (error) {\r\n            console.error('Error eliminando usuario:', error);\r\n            alert('Error de conexi\u00F3n al eliminar usuario');\r\n        } finally {\r\n            confirmarBtn.disabled = false;\r\n            confirmarBtn.textContent = 'Eliminar Usuario';\r\n        }\r\n    }\r\n    \r\n    function closeConfirmarEliminarModal() {\r\n        document.getElementById('confirmarEliminarUsuarioModal').style.display = 'none';\r\n        usuarioIdEliminar = null;\r\n    }\r\n    \r\n    function showSuccessMessage(message) {\r\n        // Crear y mostrar mensaje de \u00E9xito temporal\r\n        const successDiv = document.createElement('div');\r\n        successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--success-color); color: white; padding: 16px 24px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; font-weight: 500;';\r\n        successDiv.textContent = message;\r\n        document.body.appendChild(successDiv);\r\n        \r\n        setTimeout(() => {\r\n            successDiv.remove();\r\n        }, 3000);\r\n    }\r\n    \r\n    // Hacer funciones globales para usar en onclick\r\n    window.editarUsuario = editarUsuario;\r\n    window.confirmarEliminarUsuario = confirmarEliminarUsuario;\r\n    \r\n    // Sistema de seguridad activo - D1 Database Edition\r\n  `;\r\n}\r\n\r\nexport default getWebAppScript;\r\n", "import getStyles from './styles.js';\r\nimport getWebAppScript from './script.js';\r\n\r\nexport function getWebApp() {\r\n  return '<!DOCTYPE html>' +\r\n'<html lang=\\\"es\\\">' +\r\n'<head>' +\r\n    '<meta charset=\\\"UTF-8\\\">' +\r\n    '<meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0\\\">' +\r\n    '<title>PT Wind - Sistema de Gesti\u00F3n de Permisos</title>' +\r\n    '<link rel=\\\"manifest\\\" href=\\\"data:application/json;base64,eyJuYW1lIjoiUFQgV2luZCAtIFBlcm1pc29zIGRlIFRyYWJham8iLCJzaG9ydF9uYW1lIjoiUFQgV2luZCIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMWExZjJlIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeE1qZ2lJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEpsWTNRZ2VEMGlOQ0lnZVQwaU5DSWdkMmxrZEdnOUlqRXlNQ0lnYUdWcFoyaDBQU0l4TWpBaUlHWnBiR3c5SWlNeFlURm1NbVVpTHo0OEwzTjJaejQ9IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJzaXplcyI6IjEyOHgxMjgifV19\\\">' +\r\n    '<link rel=\\\"preconnect\\\" href=\\\"https://fonts.googleapis.com\\\">' +\r\n    '<link rel=\\\"preconnect\\\" href=\\\"https://fonts.gstatic.com\\\" crossorigin>' +\r\n    '<link href=\\\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap\\\" rel=\\\"stylesheet\\\">' +\r\n    '<style>' + getStyles() + '</style>' +\r\n'</head>' +\r\n'<body>' +\r\n    '<div class=\\\"container\\\">' +\r\n        '<!-- Pantalla de Login -->' +\r\n        '<div id=\\\"loginScreen\\\" class=\\\"login-container\\\">' +\r\n            '<div class=\\\"logo\\\">' +\r\n                '<h1>PT WIND</h1>' +\r\n                '<p>Sistema de Gesti\u00F3n de Permisos de Trabajo</p>' +\r\n            '</div>' +\r\n            \r\n            '<form id=\\\"loginForm\\\">' +\r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"usuario\\\">Usuario / Email</label>' +\r\n                    '<input type=\\\"text\\\" id=\\\"usuario\\\" required placeholder=\\\"Ingrese su usuario o email\\\" autocomplete=\\\"username\\\">' +\r\n                '</div>' +\r\n                \r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"password\\\">Contrase\u00F1a</label>' +\r\n                    '<input type=\\\"password\\\" id=\\\"password\\\" required placeholder=\\\"Ingrese su contrase\u00F1a\\\" autocomplete=\\\"current-password\\\">' +\r\n                '</div>' +\r\n                \r\n                '<button type=\\\"submit\\\" class=\\\"btn\\\" id=\\\"loginBtn\\\">Iniciar Sesi\u00F3n</button>' +\r\n                \r\n                '<div id=\\\"loginError\\\" class=\\\"error\\\" style=\\\"display: none; margin-top: 16px;\\\"></div>' +\r\n            '</form>' +\r\n            \r\n            '<div id=\\\"connectionStatus\\\" class=\\\"status-indicator status-offline\\\" style=\\\"margin-top: 24px; text-align: center;\\\">' +\r\n                'Verificando conexi\u00F3n...' +\r\n            '</div>' +\r\n        '</div>' +\r\n        \r\n        '<!-- Aplicaci\u00F3n Principal -->' +\r\n        '<div id=\\\"appScreen\\\" class=\\\"app-container\\\">' +\r\n            '<div class=\\\"header\\\">' +\r\n                '<div>' +\r\n                    '<h1>PT WIND</h1>' +\r\n                    '<p>Sistema de Gesti\u00F3n de Permisos de Trabajo</p>' +\r\n                '</div>' +\r\n                \r\n                '<div style=\\\"display: flex; align-items: center; gap: 16px;\\\">' +\r\n                    '<span id=\\\"userDisplay\\\"></span>' +\r\n                    '<button id=\\\"logoutBtn\\\" class=\\\"btn btn-secondary btn-small\\\">CERRAR SESI\u00D3N</button>' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<div class=\\\"tabs\\\">' +\r\n                '<button class=\\\"tab active\\\" data-tab=\\\"nuevo\\\">Nuevo Permiso</button>' +\r\n                '<button class=\\\"tab\\\" data-tab=\\\"consultar\\\">Consultar Permisos</button>' +\r\n                '<button class=\\\"tab\\\" data-tab=\\\"matriz\\\">Matriz de Riesgos</button>' +\r\n                '<button class=\\\"tab\\\" data-tab=\\\"datos\\\" id=\\\"tabDatos\\\" style=\\\"display: none;\\\">Datos del Sistema</button>' +\r\n                '<button class=\\\"tab\\\" data-tab=\\\"admin-usuarios\\\" id=\\\"tabAdminUsuarios\\\" style=\\\"display: none;\\\">Administraci\u00F3n de Usuarios</button>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Tab: Nuevo Permiso -->' +\r\n            '<div id=\\\"tab-nuevo\\\" class=\\\"tab-content active\\\">' +\r\n                '<form id=\\\"permisoForm\\\">' +\r\n                    '<div class=\\\"grid-three\\\">' +\r\n                        '<!-- Columna 1: Antecedentes Generales -->' +\r\n                        '<div class=\\\"card\\\">' +\r\n                            '<h3>Antecedentes Generales</h3>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"planta\\\">Planta *</label>' +\r\n                                '<select id=\\\"planta\\\" required>' +\r\n                                    '<option value=\\\"\\\">Seleccionar planta...</option>' +\r\n                                '</select>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"aerogenerador\\\">Aerogenerador *</label>' +\r\n                                '<select id=\\\"aerogenerador\\\" required>' +\r\n                                    '<option value=\\\"\\\">Seleccionar aerogenerador...</option>' +\r\n                                '</select>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"descripcion\\\">Descripci\u00F3n de Actividades *</label>' +\r\n                                '<textarea id=\\\"descripcion\\\" rows=\\\"4\\\" required placeholder=\\\"Describa las actividades a realizar...\\\"></textarea>' +\r\n                            '</div>' +\r\n                        '</div>' +\r\n                        \r\n                        '<!-- Columna 2: Responsables -->' +\r\n                        '<div class=\\\"card\\\">' +\r\n                            '<h3>Responsables</h3>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"jefeFaena\\\">Jefe de Faena *</label>' +\r\n                                '<select id=\\\"jefeFaena\\\" required>' +\r\n                                    '<option value=\\\"\\\">Seleccionar jefe de faena...</option>' +\r\n                                '</select>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"supervisorParque\\\">Supervisor de Parque</label>' +\r\n                                '<select id=\\\"supervisorParque\\\">' +\r\n                                    '<option value=\\\"\\\">Seleccionar supervisor de parque...</option>' +\r\n                                '</select>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label for=\\\"tipoMantenimiento\\\">Tipo de Mantenimiento *</label>' +\r\n                                '<select id=\\\"tipoMantenimiento\\\" required>' +\r\n                                    '<option value=\\\"\\\">Seleccionar tipo...</option>' +\r\n                                    '<option value=\\\"PREVENTIVO\\\">Mantenimiento Preventivo</option>' +\r\n                                    '<option value=\\\"CORRECTIVO\\\">Peque\u00F1o Correctivo</option>' +\r\n                                    '<option value=\\\"GRAN_CORRECTIVO\\\">Gran Correctivo</option>' +\r\n                                    '<option value=\\\"PREDICTIVO\\\">Mantenimiento Predictivo</option>' +\r\n                                    '<option value=\\\"INSPECCION\\\">Inspecci\u00F3n T\u00E9cnica</option>' +\r\n                                    '<option value=\\\"OTROS\\\">Otros</option>' +\r\n                                '</select>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"form-group input-others\\\" id=\\\"tipoOtrosContainer\\\">' +\r\n                                '<label for=\\\"tipoOtros\\\">Especificar Tipo *</label>' +\r\n                                '<input type=\\\"text\\\" id=\\\"tipoOtros\\\" placeholder=\\\"Especifique el tipo de mantenimiento...\\\">' +\r\n                            '</div>' +\r\n                        '</div>' +\r\n                        \r\n                        '<!-- Columna 3: Actividades -->' +\r\n                        '<div class=\\\"card\\\">' +\r\n                            '<h3>Actividades Rutinarias</h3>' +\r\n                            \r\n                            '<div class=\\\"form-group\\\">' +\r\n                                '<label>Seleccione las Actividades</label>' +\r\n                                '<div id=\\\"actividadesChecklist\\\" class=\\\"checkbox-list\\\">' +\r\n                                    '<div class=\\\"loading\\\">Cargando actividades...</div>' +\r\n                                '</div>' +\r\n                            '</div>' +\r\n                        '</div>' +\r\n                    '</div>' +\r\n                    \r\n                    '<!-- Personal Asignado - Fila completa -->' +\r\n                    '<div class=\\\"card\\\" style=\\\"margin-top: 24px;\\\">' +\r\n                        '<h3>Personal Asignado</h3>' +\r\n                        \r\n                        '<div class=\\\"selector-dual\\\">' +\r\n                            '<div>' +\r\n                                '<label style=\\\"display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-primary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\\\">Personal Disponible</label>' +\r\n                                '<div id=\\\"personalDisponible\\\" class=\\\"selector-list\\\">' +\r\n                                    '<div class=\\\"loading\\\">Seleccione una planta primero</div>' +\r\n                                '</div>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div class=\\\"selector-controls\\\">' +\r\n                                '<button type=\\\"button\\\" class=\\\"btn btn-secondary btn-small\\\" id=\\\"addPersonalBtn\\\">\u2192</button>' +\r\n                                '<button type=\\\"button\\\" class=\\\"btn btn-secondary btn-small\\\" id=\\\"removePersonalBtn\\\">\u2190</button>' +\r\n                            '</div>' +\r\n                            \r\n                            '<div>' +\r\n                                '<label style=\\\"display: block; margin-bottom: 12px; font-weight: 600; color: var(--text-primary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;\\\">Personal Seleccionado</label>' +\r\n                                '<div id=\\\"personalSeleccionado\\\" class=\\\"selector-list\\\">' +\r\n                                    '<div style=\\\"padding: 20px; text-align: center; color: var(--text-secondary);\\\">No hay personal seleccionado</div>' +\r\n                                '</div>' +\r\n                            '</div>' +\r\n                        '</div>' +\r\n                    '</div>' +\r\n                    \r\n                    '<div style=\\\"margin-top: 32px; display: flex; gap: 16px; flex-wrap: wrap;\\\">' +\r\n                        '<button type=\\\"submit\\\" class=\\\"btn\\\" style=\\\"flex: 1; min-width: 200px;\\\">CREAR PERMISO DE TRABAJO</button>' +\r\n                        '<button type=\\\"button\\\" id=\\\"generateRegisterBtn\\\" class=\\\"btn btn-secondary\\\" style=\\\"flex: 1; min-width: 200px;\\\">GENERAR REGISTRO PDF</button>' +\r\n                    '</div>' +\r\n                '</form>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Tab: Consultar -->' +\r\n            '<div id=\\\"tab-consultar\\\" class=\\\"tab-content\\\">' +\r\n                '<div style=\\\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;\\\">' +\r\n                    '<h3 style=\\\"color: var(--primary-color); font-size: 18px; font-weight: 600;\\\">Consultar Permisos de Trabajo</h3>' +\r\n                    '<button id=\\\"refreshPermisosBtn\\\" class=\\\"btn btn-secondary btn-small\\\">ACTUALIZAR</button>' +\r\n                '</div>' +\r\n                '<div class=\\\"search-box\\\">' +\r\n                    '<input type=\\\"text\\\" id=\\\"searchPermiso\\\" class=\\\"search-input\\\" placeholder=\\\"Buscar por n\u00FAmero de permiso, planta, descripci\u00F3n...\\\">' +\r\n                    '<select id=\\\"filterEstado\\\" class=\\\"search-input\\\" style=\\\"max-width: 200px;\\\">' +\r\n                        '<option value=\\\"\\\">Todos los estados</option>' +\r\n                        '<option value=\\\"CREADO\\\">Creados</option>' +\r\n                        '<option value=\\\"ACTIVO\\\">Activos</option>' +\r\n                        '<option value=\\\"CERRADO_PENDIENTE_APROBACION\\\">Cerrados - Pendiente Aprobaci\u00F3n</option>' +\r\n                        '<option value=\\\"CERRADO\\\">Cerrados - Aprobados</option>' +\r\n                        '<option value=\\\"CIERRE_RECHAZADO\\\">Cierre Rechazado</option>' +\r\n                    '</select>' +\r\n                    '<input type=\\\"date\\\" id=\\\"fechaDesde\\\" class=\\\"search-input\\\" style=\\\"max-width: 150px;\\\" title=\\\"Fecha desde - Filtra permisos creados desde esta fecha\\\" placeholder=\\\"Fecha desde permiso\\\">' +\r\n                    '<input type=\\\"date\\\" id=\\\"fechaHasta\\\" class=\\\"search-input\\\" style=\\\"max-width: 150px;\\\" title=\\\"Fecha hasta - Filtra permisos creados hasta esta fecha\\\" placeholder=\\\"Fecha hasta permiso\\\">' +\r\n                    '<button id=\\\"clearSearchBtn\\\" class=\\\"btn btn-secondary btn-small\\\">LIMPIAR</button>' +\r\n                '</div>' +\r\n                '<div id=\\\"permisosContainer\\\" class=\\\"loading\\\">' +\r\n                    'Cargando permisos...' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Tab: Matriz de Riesgos -->' +\r\n            '<div id=\\\"tab-matriz\\\" class=\\\"tab-content\\\">' +\r\n                '<h3 style=\\\"color: var(--primary-color); font-size: 18px; font-weight: 600; margin-bottom: 16px;\\\">Matriz de Riesgos</h3>' +\r\n                '<p style=\\\"margin-bottom: 24px; color: var(--text-secondary); font-size: 14px;\\\">Seleccione actividades en la pesta\u00F1a \\\"Nuevo Permiso\\\" para ver la matriz de riesgos aplicable.</p>' +\r\n                '<div id=\\\"matrizContainer\\\">' +\r\n                    '<div id=\\\"matrizTable\\\" class=\\\"data-table\\\" style=\\\"display: none;\\\">' +\r\n                        '<table>' +\r\n                            '<thead>' +\r\n                                '<tr>' +\r\n                                    '<th>C\u00F3digo</th>' +\r\n                                    '<th>Actividad</th>' +\r\n                                    '<th>Peligro</th>' +\r\n                                    '<th>Riesgo</th>' +\r\n                                    '<th>Medidas Preventivas</th>' +\r\n                                '</tr>' +\r\n                            '</thead>' +\r\n                            '<tbody id=\\\"matrizTableBody\\\">' +\r\n                            '</tbody>' +\r\n                        '</table>' +\r\n                    '</div>' +\r\n                    '<div id=\\\"matrizEmptyState\\\" class=\\\"loading\\\">' +\r\n                        'Seleccione actividades para ver la matriz de riesgos...' +\r\n                    '</div>' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Tab: Datos del Sistema -->' +\r\n            '<div id=\\\"tab-datos\\\" class=\\\"tab-content\\\">' +\r\n                '<div style=\\\"display: flex; flex-direction: column; gap: 24px;\\\">' +\r\n                    '<div class=\\\"card\\\">' +\r\n                        '<h3>Parques E\u00F3licos</h3>' +\r\n                        '<div id=\\\"parquesContainer\\\" class=\\\"loading\\\">Cargando parques...</div>' +\r\n                    '</div>' +\r\n                    \r\n                    '<div class=\\\"card\\\">' +\r\n                        '<h3>Personal</h3>' +\r\n                        '<div id=\\\"personalContainer\\\" class=\\\"loading\\\">Cargando personal...</div>' +\r\n                    '</div>' +\r\n                    \r\n                    '<div class=\\\"card\\\">' +\r\n                        '<h3>Supervisores</h3>' +\r\n                        '<div id=\\\"supervisoresContainer\\\" class=\\\"loading\\\">Cargando supervisores...</div>' +\r\n                    '</div>' +\r\n                    \r\n                    '<div class=\\\"card\\\">' +\r\n                        '<h3>Actividades</h3>' +\r\n                        '<div id=\\\"actividadesContainer\\\" class=\\\"loading\\\">Cargando actividades...</div>' +\r\n                    '</div>' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Tab: Administraci\u00F3n de Usuarios -->' +\r\n            '<div id=\"tab-admin-usuarios\" class=\"tab-content\">' +\r\n                '<div class=\"card\">' +\r\n                    '<h3>Administraci\u00F3n de Usuarios</h3>' +\r\n                    \r\n                    '<!-- Botones de acci\u00F3n -->' +\r\n                    '<div style=\"margin-bottom: 24px;\">' +\r\n                        '<button id=\"btnNuevoUsuario\" class=\"btn btn-primary\">Nuevo Usuario</button>' +\r\n                        '<button id=\"btnRefreshUsuarios\" class=\"btn btn-secondary\" style=\"margin-left: 12px;\">Actualizar Lista</button>' +\r\n                    '</div>' +\r\n                    \r\n                    '<!-- Lista de usuarios -->' +\r\n                    '<div id=\"usuariosContainer\" class=\"loading\">Cargando usuarios...</div>' +\r\n                '</div>' +\r\n            '</div>' +\r\n        '</div>' +\r\n    '</div>' +\r\n\r\n    '<!-- MODAL PARA CERRAR PERMISO -->' +\r\n    '<div id=\\\"cerrarPermisoModal\\\" style=\\\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;\\\">' +\r\n        '<div style=\\\"background: white; border-radius: 8px; padding: 32px; max-width: 720px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px;\\\">' +\r\n            '<h3 style=\\\"margin-bottom: 24px; color: var(--primary-color); font-size: 20px; font-weight: 600;\\\">CERRAR PERMISO DE TRABAJO</h3>' +\r\n            \r\n            '<!-- Informaci\u00F3n del permiso -->' +\r\n            '<div style=\\\"background: var(--bg-secondary); padding: 16px; border-radius: 6px; margin-bottom: 24px; border: 1px solid var(--border-color);\\\">' +\r\n                '<p style=\\\"margin-bottom: 8px;\\\"><strong>Permiso:</strong> <span id=\\\"permisoInfoNumero\\\"></span></p>' +\r\n                '<p style=\\\"margin-bottom: 8px;\\\"><strong>Planta:</strong> <span id=\\\"permisoInfoPlanta\\\"></span></p>' +\r\n                '<p style=\\\"margin-bottom: 0;\\\"><strong>Aerogenerador:</strong> <span id=\\\"permisoInfoAerogenerador\\\"></span></p>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Fechas y Tiempos -->' +\r\n            '<div style=\\\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;\\\">' +\r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"fechaInicioTrabajos\\\">Fecha/Hora Inicio Trabajos</label>' +\r\n                    '<input type=\\\"datetime-local\\\" id=\\\"fechaInicioTrabajos\\\">' +\r\n                '</div>' +\r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"fechaFinTrabajos\\\">Fecha/Hora Fin Trabajos *</label>' +\r\n                    '<input type=\\\"datetime-local\\\" id=\\\"fechaFinTrabajos\\\" required>' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\\\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;\\\" id=\\\"turbinaContainer\\\">' +\r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"fechaParadaTurbina\\\">Fecha/Hora Parada Turbina</label>' +\r\n                    '<input type=\\\"datetime-local\\\" id=\\\"fechaParadaTurbina\\\">' +\r\n                '</div>' +\r\n                '<div class=\\\"form-group\\\">' +\r\n                    '<label for=\\\"fechaPuestaMarcha\\\">Fecha/Hora Puesta en Marcha</label>' +\r\n                    '<input type=\\\"datetime-local\\\" id=\\\"fechaPuestaMarcha\\\">' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Secci\u00F3n de Materiales -->' +\r\n            '<div style=\\\"margin-bottom: 24px; background: var(--bg-secondary); padding: 20px; border-radius: 6px; border: 1px solid var(--border-color);\\\">' +\r\n                '<h4 style=\\\"margin-bottom: 16px; color: var(--primary-color); font-size: 16px; font-weight: 600;\\\">MATERIALES/REPUESTOS UTILIZADOS</h4>' +\r\n                \r\n                '<div style=\\\"display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: end;\\\">' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialDescripcion\\\">Descripci\u00F3n</label>' +\r\n                        '<input type=\\\"text\\\" id=\\\"materialDescripcion\\\" placeholder=\\\"Descripci\u00F3n del material\\\">' +\r\n                    '</div>' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialCantidad\\\">Cantidad</label>' +\r\n                        '<input type=\\\"number\\\" id=\\\"materialCantidad\\\" min=\\\"1\\\" value=\\\"1\\\">' +\r\n                    '</div>' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialPropietario\\\">Propietario</label>' +\r\n                        '<select id=\\\"materialPropietario\\\">' +\r\n                            '<option value=\\\"ENEL\\\">ENEL</option>' +\r\n                            '<option value=\\\"CONTRATISTA\\\">Contratista</option>' +\r\n                            '<option value=\\\"PROVEEDOR\\\">Proveedor</option>' +\r\n                        '</select>' +\r\n                    '</div>' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialAlmacen\\\">Almac\u00E9n</label>' +\r\n                        '<select id=\\\"materialAlmacen\\\">' +\r\n                            '<option value=\\\"Central\\\">Central</option>' +\r\n                            '<option value=\\\"Sitio\\\">Sitio</option>' +\r\n                            '<option value=\\\"Contratista\\\">Contratista</option>' +\r\n                        '</select>' +\r\n                    '</div>' +\r\n                    '<button type=\\\"button\\\" id=\\\"addMaterialBtn\\\" class=\\\"btn btn-secondary btn-small\\\">+</button>' +\r\n                '</div>' +\r\n                \r\n                '<div style=\\\"display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;\\\">' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialNumeroItem\\\">N\u00FAmero Item (Opcional)</label>' +\r\n                        '<input type=\\\"text\\\" id=\\\"materialNumeroItem\\\" placeholder=\\\"N\u00B0 Item\\\">' +\r\n                    '</div>' +\r\n                    '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 0;\\\">' +\r\n                        '<label for=\\\"materialNumeroSerie\\\">N\u00FAmero Serie (Opcional)</label>' +\r\n                        '<input type=\\\"text\\\" id=\\\"materialNumeroSerie\\\" placeholder=\\\"N\u00B0 Serie\\\">' +\r\n                    '</div>' +\r\n                '</div>' +\r\n                \r\n                '<div id=\\\"materialesLista\\\" style=\\\"max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; background: white;\\\">' +\r\n                    '<div style=\\\"padding: 20px; text-align: center; color: var(--text-secondary);\\\">No hay materiales agregados</div>' +\r\n                '</div>' +\r\n            '</div>' +\r\n            \r\n            '<!-- Observaciones de Cierre -->' +\r\n            '<div class=\\\"form-group\\\" style=\\\"margin-bottom: 24px;\\\">' +\r\n                '<label for=\\\"observacionesCierre\\\">Observaciones de Cierre</label>' +\r\n                '<textarea id=\\\"observacionesCierre\\\" rows=\\\"3\\\" placeholder=\\\"Observaciones sobre el cierre del permiso...\\\">Trabajo completado seg\u00FAn programaci\u00F3n</textarea>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\\\"display: flex; gap: 12px; justify-content: flex-end;\\\">' +\r\n                '<button id=\\\"cancelarCierreBtn\\\" class=\\\"btn btn-secondary btn-small\\\">CANCELAR</button>' +\r\n                '<button id=\\\"confirmarCierreBtn\\\" class=\\\"btn btn-danger btn-small\\\">CERRAR PERMISO</button>' +\r\n            '</div>' +\r\n        '</div>' +\r\n    '</div>' +\r\n\r\n    '<!-- MODAL DE EXPORTACI\u00D3N -->' +\r\n    '<div id=\"exportModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;\">' +\r\n        '<div style=\"background: white; border-radius: 12px; padding: 32px; max-width: 480px; width: 90%; margin: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);\">' +\r\n            '<div style=\"text-align: center; margin-bottom: 24px;\">' +\r\n                '<h3 style=\"margin-bottom: 12px; color: var(--primary-color); font-size: 24px; font-weight: 700;\">\uD83D\uDCC1 Exportar Permiso</h3>' +\r\n                '<p style=\"color: var(--text-secondary); font-size: 14px; margin: 0;\">' +\r\n                    'Permiso: <strong id=\"exportPermisoInfo\"></strong>' +\r\n                '</p>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"display: grid; gap: 16px; margin-bottom: 24px;\">' +\r\n                '<button id=\"exportExcelBtn\" class=\"btn\" style=\"display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; font-size: 16px;\">' +\r\n                    '<span style=\"font-size: 24px;\">\uD83D\uDCCA</span>' +\r\n                    '<div style=\"text-align: left;\">' +\r\n                        '<div style=\"font-weight: 600;\">Excel</div>' +\r\n                    '</div>' +\r\n                '</button>' +\r\n                \r\n                '<button id=\"exportPdfBtn\" class=\"btn btn-secondary\" style=\"display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; font-size: 16px;\">' +\r\n                    '<span style=\"font-size: 24px;\">\uD83D\uDCC4</span>' +\r\n                    '<div style=\"text-align: left;\">' +\r\n                        '<div style=\"font-weight: 600;\">PDF para Imprimir</div>' +\r\n                    '</div>' +\r\n                '</button>' +\r\n            '</div>' +\r\n            \r\n            '<div id=\"exportStatus\" style=\"display: none; text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px;\">' +\r\n                '<div style=\"display: inline-block; width: 20px; height: 20px; border: 2px solid var(--primary-color); border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;\"></div>' +\r\n                '<span id=\"exportStatusText\">Generando archivo...</span>' +\r\n            '</div>' +\r\n            \r\n            '<div style=\"text-align: center;\">' +\r\n                '<button id=\"cancelExportBtn\" class=\"btn btn-secondary btn-small\">Cancelar</button>' +\r\n            '</div>' +\r\n        '</div>' +\r\n    '</div>' +\r\n\r\n    '<!-- MODAL DE CAMBIO DE CONTRAE\u00D1A OBLIGATORIO -->' +\r\n    '<div id=\"changePasswordModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;\">' +\r\n        '<div style=\"background: white; border-radius: 8px; padding: 32px; max-width: 480px; width: 90%; margin: 20px;\">' +\r\n            '<h3 style=\"margin-bottom: 24px; color: var(--primary-color);\">Cambio de Contrase\u00F1a Obligatorio</h3>' +\r\n            \r\n            '<div id=\"passwordChangeReason\" class=\"warning\" style=\"background: rgba(243, 156, 18, 0.1); color: var(--warning-color); padding: 16px; border-radius: 6px; margin-bottom: 20px; border: 1px solid rgba(243, 156, 18, 0.2);\">' +\r\n                'Por seguridad, debes cambiar tu contrase\u00F1a.' +\r\n            '</div>' +\r\n            \r\n            '<div id=\"passwordRequirements\" class=\"info\" style=\"background: rgba(26, 31, 46, 0.05); padding: 16px; border-radius: 6px; margin-bottom: 20px; border: 1px solid rgba(26, 31, 46, 0.1); display: none;\">' +\r\n                '<!-- Los requisitos se insertan din\u00E1micamente -->' +\r\n            '</div>' +\r\n            \r\n            '<div class=\"form-group\">' +\r\n                '<label for=\"mandatoryNewPassword\">Nueva Contrase\u00F1a</label>' +\r\n                '<input type=\"password\" id=\"mandatoryNewPassword\" required placeholder=\"M\u00EDnimo 8 caracteres\">' +\r\n            '</div>' +\r\n            \r\n            '<div class=\"form-group\">' +\r\n                '<label for=\"mandatoryConfirmPassword\">Confirmar Nueva Contrase\u00F1a</label>' +\r\n                '<input type=\"password\" id=\"mandatoryConfirmPassword\" required placeholder=\"Repite la contrase\u00F1a\">' +\r\n            '</div>' +\r\n            \r\n            '<div id=\"changePasswordError\" class=\"error\" style=\"display: none; margin-bottom: 16px;\"></div>' +\r\n            \r\n            '<button id=\"submitPasswordChangeBtn\" class=\"btn\" style=\"width: 100%;\">Cambiar Contrase\u00F1a y Continuar</button>' +\r\n            \r\n            '<p style=\"margin-top: 16px; font-size: 12px; color: var(--text-secondary); text-align: center;\">' +\r\n                'No podr\u00E1s acceder al sistema hasta cambiar tu contrase\u00F1a' +\r\n            '</p>' +\r\n    '</div>' +\r\n  '</div>' +\r\n  \r\n  '<!-- MODAL PARA NUEVO/EDITAR USUARIO -->' +\r\n  '<div id=\"usuarioModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; overflow-y: auto;\">' +\r\n      '<div style=\"background: white; border-radius: 8px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px;\">' +\r\n          '<h3 id=\"usuarioModalTitle\" style=\"margin-bottom: 24px; color: var(--primary-color); font-size: 20px; font-weight: 600;\">Nuevo Usuario</h3>' +\r\n          \r\n          '<form id=\"usuarioForm\">' +\r\n              '<div class=\"grid-two\" style=\"gap: 16px; margin-bottom: 16px;\">' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label for=\"modalUsuario\">Usuario *</label>' +\r\n                      '<input type=\"text\" id=\"modalUsuario\" required placeholder=\"Nombre de usuario\">' +\r\n                  '</div>' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label for=\"modalEmail\">Email *</label>' +\r\n                      '<input type=\"email\" id=\"modalEmail\" required placeholder=\"email@empresa.com\">' +\r\n                  '</div>' +\r\n              '</div>' +\r\n              \r\n              '<div class=\"grid-two\" style=\"gap: 16px; margin-bottom: 16px;\">' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label for=\"modalPassword\">Contrase\u00F1a</label>' +\r\n                      '<input type=\"password\" id=\"modalPassword\" placeholder=\"Dejar vac\u00EDo para mantener actual\">' +\r\n                  '</div>' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label for=\"modalRol\">Rol *</label>' +\r\n                      '<select id=\"modalRol\" required>' +\r\n                          '<option value=\"\">Seleccionar rol...</option>' +\r\n                          '<option value=\"operador\">Operador</option>' +\r\n                          '<option value=\"supervisor\">Supervisor</option>' +\r\n                          '<option value=\"admin\">Admin</option>' +\r\n                      '</select>' +\r\n                  '</div>' +\r\n              '</div>' +\r\n              \r\n              '<div class=\"form-group\" style=\"margin-bottom: 16px;\">' +\r\n                  '<label for=\"modalEmpresa\">Empresa</label>' +\r\n                  '<input type=\"text\" id=\"modalEmpresa\" placeholder=\"Nombre de la empresa\">' +\r\n              '</div>' +\r\n              \r\n              '<div class=\"form-group\" style=\"margin-bottom: 16px;\">' +\r\n                  '<label for=\"modalParquesAutorizados\">Parques Autorizados</label>' +\r\n                  '<input type=\"text\" id=\"modalParquesAutorizados\" placeholder=\"Parques separados por comas\">' +\r\n              '</div>' +\r\n              \r\n              '<div class=\"grid-two\" style=\"gap: 16px; margin-bottom: 24px;\">' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label for=\"modalEstado\">Estado *</label>' +\r\n                      '<select id=\"modalEstado\" required>' +\r\n                          '<option value=\"Activo\">Activo</option>' +\r\n                          '<option value=\"Inactivo\">Inactivo</option>' +\r\n                      '</select>' +\r\n                  '</div>' +\r\n                  '<div class=\"form-group\">' +\r\n                      '<label style=\"display: flex; align-items: center; gap: 8px;\">' +\r\n                          '<input type=\"checkbox\" id=\"modalPasswordTemporal\">' +\r\n                          '<span>Contrase\u00F1a temporal (debe cambiarse)</span>' +\r\n                      '</label>' +\r\n                  '</div>' +\r\n              '</div>' +\r\n              \r\n              '<div id=\"usuarioError\" class=\"error\" style=\"display: none; margin-bottom: 16px;\"></div>' +\r\n              \r\n              '<div style=\"display: flex; gap: 12px; justify-content: flex-end;\">' +\r\n                  '<button type=\"button\" id=\"cancelarUsuarioBtn\" class=\"btn btn-secondary\">Cancelar</button>' +\r\n                  '<button type=\"submit\" id=\"guardarUsuarioBtn\" class=\"btn btn-primary\">Guardar Usuario</button>' +\r\n              '</div>' +\r\n          '</form>' +\r\n      '</div>' +\r\n  '</div>' +\r\n  \r\n  '<!-- MODAL DE CONFIRMACI\u00D3N PARA ELIMINAR USUARIO -->' +\r\n  '<div id=\"confirmarEliminarUsuarioModal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;\">' +\r\n      '<div style=\"background: white; border-radius: 8px; padding: 32px; max-width: 400px; width: 90%; margin: 20px; text-align: center;\">' +\r\n          '<h3 style=\"margin-bottom: 16px; color: var(--danger-color); font-size: 20px; font-weight: 600;\">Confirmar Eliminaci\u00F3n</h3>' +\r\n          '<p style=\"margin-bottom: 24px; color: var(--text-secondary);\">\u00BFEst\u00E1s seguro de que deseas eliminar este usuario?</p>' +\r\n          '<p id=\"usuarioEliminarInfo\" style=\"margin-bottom: 24px; font-weight: 500; color: var(--text-primary);\"></p>' +\r\n          '<div style=\"display: flex; gap: 12px; justify-content: center;\">' +\r\n              '<button id=\"cancelarEliminarUsuarioBtn\" class=\"btn btn-secondary\">Cancelar</button>' +\r\n              '<button id=\"confirmarEliminarUsuarioBtn\" class=\"btn btn-danger\">Eliminar Usuario</button>' +\r\n          '</div>' +\r\n      '</div>' +\r\n  '</div>' +\r\n  \r\n  '<script>' + getWebAppScript() + '</script>' +\r\n'</body>' +\r\n'</html>';\r\n}\r\n\r\nexport default getWebApp;\r\n", "// Configuration for security settings of the PT Wind application.\r\n// This module exports a constant containing rate limiting, session,\r\n// password, and crypto configuration parameters. These settings were\r\n// originally defined at the top of worker.js. Splitting them into\r\n// their own module makes the values easier to import throughout the\r\n// codebase without duplicating literals.\r\n\r\nexport const SECURITY_CONFIG = {\r\n  rateLimits: {\r\n    login: { windowMs: 900000, max: 1000, blockDuration: 3600 },\r\n    api: { windowMs: 60000, max: 100 },\r\n    heavy: { windowMs: 300000, max: 10 }\r\n  },\r\n  session: {\r\n    duration: 7200,\r\n    refreshThreshold: 1800,\r\n    maxSessions: 5\r\n  },\r\n  password: {\r\n    minLength: 8,\r\n    maxLength: 128,\r\n    requireUppercase: true,\r\n    requireLowercase: true,\r\n    requireNumbers: true,\r\n    maxAge: 90\r\n  },\r\n  crypto: {\r\n    iterations: 100000,\r\n    hashLength: 32,\r\n    saltLength: 32,\r\n    algorithm: 'SHA-256'\r\n  }\r\n};\r\n\r\nexport default SECURITY_CONFIG;\r\n", "/**\r\n * Custom error class for security-related errors thrown during input validation,\r\n * authentication and rate limiting. Mirrors the SecurityError class defined in worker.js.\r\n */\r\nexport class SecurityError extends Error {\r\n  constructor(message, status = 400) {\r\n    super(message);\r\n    this.name = 'SecurityError';\r\n    this.status = status;\r\n  }\r\n\r\n  toPublicJSON() {\r\n    return {\r\n      error: this.name,\r\n      message: this.message,\r\n      status: this.status\r\n    };\r\n  }\r\n}\r\n\r\nexport default SecurityError;\r\n", "/**\r\n * Utility functions for generating HTTP headers such as security and CORS.\r\n * Extracted from the monolithic worker.js.\r\n */\r\n\r\n/**\r\n * Returns a set of security-related HTTP headers to mitigate common web vulnerabilities.\r\n * @returns {Object} Headers object with security directives.\r\n */\r\nexport function getSecurityHeaders() {\r\n  return {\r\n    \"Content-Security-Policy\": [\r\n      \"default-src 'self'\",\r\n      \"script-src 'self' 'unsafe-inline'\",\r\n      \"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com\",  // \u2190 Permite Google Fonts CSS\r\n      \"font-src 'self' https://fonts.gstatic.com\",                      // \u2190 Permite Google Fonts archivos\r\n      \"img-src 'self' data:\",\r\n      \"manifest-src 'self' data:\",\r\n      \"connect-src 'self'\",\r\n    ].join(\"; \"),\r\n    \"X-Content-Type-Options\": \"nosniff\",\r\n    \"X-Frame-Options\": \"DENY\",\r\n    \"X-XSS-Protection\": \"1; mode=block\",\r\n    \"Referrer-Policy\": \"no-referrer\"\r\n  };\r\n}\r\n\r\n/**\r\n * Generates CORS headers based on the request origin and allowed origins list.\r\n * @param {string} origin - The Origin header from the request.\r\n * @param {string[]} allowedOrigins - Array of allowed origins.\r\n * @returns {Object} Headers object with appropriate CORS directives.\r\n */\r\nexport function getCorsHeaders(env, request) {\r\n  const reqOrigin = request.headers.get('Origin') || '';\r\n  let raw = env.ALLOWED_ORIGINS;\r\n\r\n  // Por defecto, rechazar todos los or\u00EDgenes si no est\u00E1 configurado\r\n  if (!raw) {\r\n    console.warn('ALLOWED_ORIGINS not configured - defaulting to restrictive CORS');\r\n    return {\r\n      'Access-Control-Allow-Origin': 'null',\r\n      'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\r\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n      'Access-Control-Allow-Credentials': 'false',\r\n    };\r\n  }\r\n\r\n  // Normaliza ALLOWED_ORIGINS a: '*' o Array<string>\r\n  let allowed;\r\n  try {\r\n    if (raw === '*') {\r\n      // Solo permitir '*' si est\u00E1 expl\u00EDcitamente configurado\r\n      allowed = '*';\r\n    } else if (typeof raw === 'string' && raw.trim().startsWith('[')) {\r\n      // JSON array, p. ej.: [\"https://a.com\",\"https://b.com\"]\r\n      allowed = JSON.parse(raw);\r\n    } else if (typeof raw === 'string') {\r\n      // coma-separado, p. ej.: https://a.com,https://b.com\r\n      allowed = raw.split(',').map(s => s.trim()).filter(Boolean);\r\n    } else {\r\n      // Si no es un formato v\u00E1lido, rechazar\r\n      allowed = [];\r\n    }\r\n  } catch {\r\n    // En caso de error de parsing, ser restrictivo\r\n    allowed = [];\r\n  }\r\n\r\n  const allowOrigin =\r\n    allowed === '*'\r\n      ? '*'\r\n      : (Array.isArray(allowed) && allowed.includes(reqOrigin)) ? reqOrigin : 'null';\r\n\r\n  return {\r\n    'Access-Control-Allow-Origin': allowOrigin,\r\n    'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n    'Access-Control-Allow-Credentials': allowed === '*' ? 'false' : 'true',\r\n  };\r\n}\r\n\r\nexport default {\r\n  getSecurityHeaders,\r\n  getCorsHeaders\r\n};\r\n", "/**\r\n * Rate limiting service using Cloudflare KV to track attempts per identifier and route type.\r\n * Based on the implementation in worker.js.\r\n */\r\nimport SECURITY_CONFIG from '../config/security.js';\r\nimport { SecurityError } from '../errors.js';\r\n\r\nexport class RateLimiter {\r\n  constructor(env) {\r\n    this.env = env;\r\n  }\r\n\r\n  async check(identifier, type = 'api') {\r\n    if (!this.env.RATE_LIMIT_KV) {\r\n      console.log('Rate limiting not configured (KV missing)');\r\n      return true;\r\n    }\r\n    const config = SECURITY_CONFIG.rateLimits[type];\r\n    if (!config) {\r\n      console.log('Rate limiting not configured (missing type)');\r\n      return true;\r\n    }\r\n    const key = `rl:${type}:${identifier}`;\r\n    const blockKey = `rl:block:${type}:${identifier}`;\r\n    const blocked = await this.env.RATE_LIMIT_KV.get(blockKey);\r\n    if (blocked) {\r\n      throw new SecurityError('Demasiados intentos. Intente m\u00E1s tarde.', 429);\r\n    }\r\n    const attempts = parseInt((await this.env.RATE_LIMIT_KV.get(key)) || '0');\r\n    if (attempts >= config.max) {\r\n      await this.env.RATE_LIMIT_KV.put(blockKey, 'true', {\r\n        expirationTtl: config.blockDuration\r\n      });\r\n      throw new SecurityError('L\u00EDmite de intentos excedido', 429);\r\n    }\r\n    await this.env.RATE_LIMIT_KV.put(key, (attempts + 1).toString(), {\r\n      expirationTtl: Math.floor(config.windowMs / 1000)\r\n    });\r\n    return true;\r\n  }\r\n\r\n  async reset(identifier, type = 'api') {\r\n    if (!this.env.RATE_LIMIT_KV) return;\r\n    const key = `rl:${type}:${identifier}`;\r\n    const blockKey = `rl:block:${type}:${identifier}`;\r\n    await this.env.RATE_LIMIT_KV.delete(key);\r\n    await this.env.RATE_LIMIT_KV.delete(blockKey);\r\n  }\r\n}\r\n\r\nexport default RateLimiter;\r\n", "// src/core/services/authService.js\r\n/**\r\n * Auth + hashing + JWT\r\n * Formatos soportados en verifyPassword():\r\n *  - pbkdf2:<iteraciones>:<saltHex>:<hashHex>\r\n *  - salt:hash (legacy PBKDF2 usando SECURITY_CONFIG.iterations)\r\n *  - base64(SHA-256(password))  (legacy)\r\n *  - HEX (64 = SHA-256, 40 = SHA-1) (legacy)\r\n *  - texto plano (igualdad directa)  (legacy)\r\n */\r\nimport SECURITY_CONFIG from '../config/security.js';\r\nimport SecurityError from '../errors.js';\r\n\r\nconst enc = new TextEncoder();\r\n\r\nconst toHex = (buf) =>\r\n  [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');\r\n\r\nconst fromHex = (hex) =>\r\n  new Uint8Array(hex.match(/.{1,2}/g).map(h => parseInt(h, 16)));\r\n\r\nconst timingSafeEqual = (a, b) => {\r\n  if (a.length !== b.length) return false;\r\n  let r = 0;\r\n  for (let i = 0; i < a.length; i++) r |= a.charCodeAt(i) ^ b.charCodeAt(i);\r\n  return r === 0;\r\n};\r\n\r\nconst isHex = (s) => /^[a-f0-9]+$/i.test(s);\r\nconst isBase64 = (s) => /^[A-Za-z0-9+/]+={0,2}$/.test(s) && s.length % 4 === 0;\r\n\r\nconst b64url = (s) => s.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\r\n\r\nexport default class AuthService {\r\n  constructor(env) {\r\n    this.env = env;\r\n    // JWT_SECRET debe estar configurado en Cloudflare\r\n    // Si no est\u00E1 configurado, lanzar error en lugar de generar uno aleatorio\r\n    if (!env.JWT_SECRET) {\r\n      throw new Error('JWT_SECRET no est\u00E1 configurado. Configure en Cloudflare: wrangler secret put JWT_SECRET');\r\n    }\r\n    this.SECRET = env.JWT_SECRET;\r\n  }\r\n\r\n  async hashPassword(password) {\r\n    const iterations = SECURITY_CONFIG.crypto.iterations; // p.ej. 100000\r\n    const hashLen    = SECURITY_CONFIG.crypto.hashLength; // bytes, p.ej. 32\r\n    const saltLen    = SECURITY_CONFIG.crypto.saltLength; // bytes\r\n\r\n    const salt = crypto.getRandomValues(new Uint8Array(saltLen));\r\n    const key = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveBits']);\r\n    const bits = await crypto.subtle.deriveBits(\r\n      { name: 'PBKDF2', hash: 'SHA-256', salt, iterations },\r\n      key,\r\n      hashLen * 8\r\n    );\r\n    return `pbkdf2:${iterations}:${toHex(salt)}:${toHex(bits)}`;\r\n  }\r\n\r\n  /**\r\n   * Verifica password contra m\u00FAltiples formatos legacy.\r\n   * Retorna objeto con { valid: boolean, needsUpdate: boolean }\r\n   */\r\n  async verifyPassword(plain, stored) {\r\n    if (plain == null || stored == null) return { valid: false, needsUpdate: false };\r\n\r\n    let valid = false;\r\n    let needsUpdate = false;\r\n\r\n    // 1) pbkdf2:<iter>:<saltHex>:<hashHex>  (formato actual, no necesita update)\r\n    if (stored.startsWith('pbkdf2:')) {\r\n      const parts = stored.split(':');\r\n      let iterations = SECURITY_CONFIG.crypto.iterations;\r\n      let saltHex, hashHex;\r\n      for (let i = 1; i < parts.length; i++) {\r\n        if (/^\\d+$/.test(parts[i])) { iterations = parseInt(parts[i], 10); continue; }\r\n        if (!saltHex) { saltHex = parts[i]; continue; }\r\n        if (!hashHex) { hashHex = parts[i]; break; }\r\n      }\r\n      if (!saltHex || !hashHex || !isHex(saltHex) || !isHex(hashHex)) {\r\n        return { valid: false, needsUpdate: false };\r\n      }\r\n\r\n      const key = await crypto.subtle.importKey('raw', enc.encode(plain), { name: 'PBKDF2' }, false, ['deriveBits']);\r\n      const bits = await crypto.subtle.deriveBits(\r\n        { name: 'PBKDF2', hash: 'SHA-256', salt: fromHex(saltHex), iterations },\r\n        key,\r\n        hashHex.length * 4\r\n      );\r\n      valid = timingSafeEqual(toHex(bits).toLowerCase(), hashHex.toLowerCase());\r\n      needsUpdate = false; // formato actual, no necesita actualizaci\u00F3n\r\n      return { valid, needsUpdate };\r\n    }\r\n\r\n    // 2) salt:hash  (legacy PBKDF2 con iteraciones de SECURITY_CONFIG)\r\n    if (stored.includes(':')) {\r\n      const [saltHex, hashHex] = stored.split(':');\r\n      if (isHex(saltHex) && isHex(hashHex)) {\r\n        const iterations = SECURITY_CONFIG.crypto.iterations;\r\n        const key = await crypto.subtle.importKey('raw', enc.encode(plain), { name: 'PBKDF2' }, false, ['deriveBits']);\r\n        const bits = await crypto.subtle.deriveBits(\r\n          { name: 'PBKDF2', hash: 'SHA-256', salt: fromHex(saltHex), iterations },\r\n          key,\r\n          hashHex.length * 4\r\n        );\r\n        valid = timingSafeEqual(toHex(bits).toLowerCase(), hashHex.toLowerCase());\r\n        needsUpdate = valid; // formato legacy, necesita actualizaci\u00F3n\r\n        return { valid, needsUpdate };\r\n      }\r\n      // si no es hex, cae a otros formatos abajo\r\n    }\r\n\r\n    // 3) HEX legacy: 64 => SHA-256, 40 => SHA-1\r\n    if (isHex(stored) && (stored.length === 64 || stored.length === 40)) {\r\n      const algo = stored.length === 64 ? 'SHA-256' : 'SHA-1';\r\n      const digest = await crypto.subtle.digest(algo, enc.encode(plain));\r\n      valid = timingSafeEqual(toHex(digest).toLowerCase(), stored.toLowerCase());\r\n      needsUpdate = valid; // formato legacy, necesita actualizaci\u00F3n\r\n      return { valid, needsUpdate };\r\n    }\r\n\r\n    // 4) base64(SHA-256(password)) - solo si es suficientemente largo para ser un hash real\r\n    if (isBase64(stored) && stored.length >= 32) {  // Base64 de SHA-256 ser\u00EDa ~44 chars\r\n      const digest = await crypto.subtle.digest('SHA-256', enc.encode(plain));\r\n      const b64 = btoa(String.fromCharCode(...new Uint8Array(digest)));\r\n      valid = timingSafeEqual(b64, stored);\r\n      needsUpdate = valid; // formato legacy, necesita actualizaci\u00F3n\r\n      return { valid, needsUpdate };\r\n    }\r\n\r\n    // 5) texto plano (\u00FAltimo recurso legacy)\r\n    valid = plain === stored;\r\n    needsUpdate = valid; // formato legacy inseguro, necesita actualizaci\u00F3n urgente\r\n    return { valid, needsUpdate };\r\n  }\r\n\r\n  // -------------------------- JWT ----------------------------------------\r\n\r\n  async createToken(payload) {\r\n    // Asegurar que el payload tenga el campo 'sub' para compatibilidad con verifyToken\r\n    const tokenPayload = {\r\n      ...payload,\r\n      sub: payload.id || payload.sub,  // Usar 'id' como 'sub' si no existe\r\n      iat: Math.floor(Date.now() / 1000),\r\n      exp: Math.floor(Date.now() / 1000) + (30 * 60) // Expira en 30 minutos por inactividad\r\n    };\r\n    \r\n    const headerB64 = b64url(btoa(String.fromCharCode(...enc.encode(JSON.stringify({ alg: 'HS256', typ: 'JWT' })))));\r\n    const payloadB64 = b64url(btoa(String.fromCharCode(...enc.encode(JSON.stringify(tokenPayload)))));\r\n    const unsigned = `${headerB64}.${payloadB64}`;\r\n\r\n    const key = await crypto.subtle.importKey('raw', enc.encode(this.SECRET), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);\r\n    const sigBuf = await crypto.subtle.sign('HMAC', key, enc.encode(unsigned));\r\n    const signature = b64url(btoa(String.fromCharCode(...new Uint8Array(sigBuf))));\r\n    return `${unsigned}.${signature}`;\r\n  }\r\n\r\n  async verifyToken(token) {\r\n    const [h, p, s] = token.split('.');\r\n    if (!h || !p || !s) throw new SecurityError('Token inv\u00E1lido', 401);\r\n\r\n    const unsigned = `${h}.${p}`;\r\n    const key = await crypto.subtle.importKey('raw', enc.encode(this.SECRET), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);\r\n    const sigBuf = await crypto.subtle.sign('HMAC', key, enc.encode(unsigned));\r\n    const expected = b64url(btoa(String.fromCharCode(...new Uint8Array(sigBuf))));\r\n    if (s !== expected) throw new SecurityError('Token inv\u00E1lido', 401);\r\n\r\n    const payload = JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/')));\r\n    \r\n    // Validar expiraci\u00F3n del token\r\n    if (payload.exp && payload.exp < Math.floor(Date.now() / 1000)) {\r\n      throw new SecurityError('Token expirado', 401);\r\n    }\r\n    \r\n    return payload;\r\n  }\r\n\r\n  decodeToken(token) {\r\n    const [, p] = token.split('.');\r\n    return JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/')));\r\n  }\r\n}\r\n", "/**\r\n * AuditLogger service to log actions and events to the D1 database.\r\n * This module is extracted from the monolithic worker.js.\r\n */\r\nexport default class AuditLogger {\r\n  constructor(env) {\r\n    this.env = env;\r\n  }\r\n\r\n  /**\r\n   * Log an event to the audit_log table.\r\n   * @param {Object} event Event details including userId, userEmail, action, resource, resourceId, ipAddress, userAgent, success, errorMessage, metadata.\r\n   */\r\n  async log(event = {}) {\r\n    // Construct log entry with defaults\r\n    const logEntry = {\r\n      id: crypto.randomUUID(),\r\n      timestamp: new Date().toISOString(),\r\n      user_id: event.userId || null,\r\n      user_email: event.userEmail || null,\r\n      action: event.action || null,\r\n      resource: event.resource || null,\r\n      resource_id: event.resourceId || null,\r\n      ip_address: event.ipAddress || null,\r\n      user_agent: event.userAgent || null,\r\n      success: event.success === true,\r\n      error_message: event.errorMessage || null,\r\n      metadata: event.metadata ? JSON.stringify(event.metadata) : null\r\n    };\r\n\r\n    // ensure table exists and insert log entry\r\n    const DB = this.env.DB_PERMISOS;\r\n    await DB.prepare(`CREATE TABLE IF NOT EXISTS audit_log (\r\n      id TEXT PRIMARY KEY,\r\n      timestamp TEXT NOT NULL,\r\n      user_id INTEGER,\r\n      user_email TEXT,\r\n      action TEXT NOT NULL,\r\n      resource TEXT,\r\n      resource_id TEXT,\r\n      ip_address TEXT,\r\n      user_agent TEXT,\r\n      success INTEGER NOT NULL,\r\n      error_message TEXT,\r\n      metadata TEXT\r\n    );`).run();\r\n\r\n    await DB.prepare(`INSERT INTO audit_log (\r\n      id, timestamp, user_id, user_email, action, resource, resource_id, ip_address, user_agent, success, error_message, metadata\r\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);`)\r\n    .bind(\r\n      logEntry.id,\r\n      logEntry.timestamp,\r\n      logEntry.user_id,\r\n      logEntry.user_email,\r\n      logEntry.action,\r\n      logEntry.resource,\r\n      logEntry.resource_id,\r\n      logEntry.ip_address,\r\n      logEntry.user_agent,\r\n      logEntry.success ? 1 : 0,\r\n      logEntry.error_message,\r\n      logEntry.metadata\r\n    )\r\n    .run();\r\n  }\r\n}\r\n", "/**\r\n * Utility functions to sanitize input strings and objects.\r\n * Derived from worker.js sanitization logic.\r\n */\r\nexport class InputSanitizer {\r\n  static sanitizeString(value) {\r\n    if (typeof value !== 'string') {\r\n      return value;\r\n    }\r\n    // Permitir letras (incluyendo Unicode/acentos), n\u00FAmeros, espacios y caracteres comunes\r\n    // Remover solo caracteres potencialmente peligrosos como <, >, &, \", ', `, etc.\r\n    return value.replace(/[<>'\"`;{}()]/g, '');\r\n  }\r\n\r\n  static sanitizeObject(obj) {\r\n    if (!obj || typeof obj !== 'object') {\r\n      return obj;\r\n    }\r\n    const sanitized = {};\r\n    for (const key of Object.keys(obj)) {\r\n      sanitized[key] = InputSanitizer.sanitizeString(obj[key]);\r\n    }\r\n    return sanitized;\r\n  }\r\n\r\n  // DEPRECATED: Use prepared statements instead\r\n  // This method is kept for backward compatibility but should not be used\r\n  static sanitizeForSQL(value) {\r\n    console.warn('sanitizeForSQL is deprecated. Use prepared statements instead.');\r\n    if (typeof value === 'string') {\r\n      return value.replace(/'/g, \"''\");\r\n    }\r\n    return value;\r\n  }\r\n}\r\n\r\nexport default InputSanitizer;\r\n", "/**\r\n * Date and time utility functions for converting to Chile timezone and formatting.\r\n * Chile uses UTC-4 (standard time) and UTC-3 (daylight saving time).\r\n */\r\n\r\n/**\r\n * Returns a Date object adjusted to Chile timezone.\r\n * Chile DST: Second Sunday in September to First Sunday in April (UTC-3)\r\n * Chile Standard: First Sunday in April to Second Sunday in September (UTC-4)\r\n * @param {number} offsetMinutes Number of minutes to add to the current time.\r\n * @returns {Date} Chile local date and time.\r\n */\r\nexport function getLocalDateTime(offsetMinutes = 0) {\r\n  const now = new Date();\r\n  \r\n  // Determinar si estamos en horario de verano chileno (DST)\r\n  const year = now.getUTCFullYear();\r\n  \r\n  // Segundo domingo de septiembre (inicio DST)\r\n  const septemberSecondSunday = getSecondSunday(year, 8); // Septiembre = mes 8\r\n  // Primer domingo de abril (fin DST)\r\n  const aprilFirstSunday = getFirstSunday(year, 3); // Abril = mes 3\r\n  \r\n  const currentTime = now.getTime();\r\n  const isDST = currentTime >= septemberSecondSunday.getTime() || currentTime < aprilFirstSunday.getTime();\r\n  \r\n  // UTC-3 durante DST, UTC-4 durante horario est\u00E1ndar\r\n  const chileOffsetMinutes = isDST ? -3 * 60 : -4 * 60;\r\n  \r\n  return new Date(now.getTime() + (chileOffsetMinutes + offsetMinutes) * 60000);\r\n}\r\n\r\n/**\r\n * Obtiene el segundo domingo del mes\r\n */\r\nfunction getSecondSunday(year, month) {\r\n  const date = new Date(Date.UTC(year, month, 1));\r\n  const firstSunday = 7 - date.getUTCDay();\r\n  return new Date(Date.UTC(year, month, firstSunday + 7));\r\n}\r\n\r\n/**\r\n * Obtiene el primer domingo del mes\r\n */\r\nfunction getFirstSunday(year, month) {\r\n  const date = new Date(Date.UTC(year, month, 1));\r\n  const firstSunday = 7 - date.getUTCDay();\r\n  return new Date(Date.UTC(year, month, firstSunday === 7 ? 7 : firstSunday));\r\n}\r\n\r\n/**\r\n * Formats a Date object into a string \"YYYY-MM-DD HH:MM:SS\".\r\n * @param {Date} date The date to format.\r\n * @returns {string} Formatted date/time string.\r\n */\r\nexport function formatLocalDateTime(date) {\r\n  const pad = (n) => String(n).padStart(2, '0');\r\n  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ` +\r\n         `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;\r\n}\r\n\r\nexport default {\r\n  getLocalDateTime,\r\n  formatLocalDateTime,\r\n};\r\n", "import { InputSanitizer } from '../utils/sanitizers.js';\r\nimport AuthService from '../services/authService.js';\r\nimport AuditLogger from '../services/auditLogger.js';\r\nimport { getLocalDateTime, formatLocalDateTime } from '../utils/time.js';\r\n\r\n// Funci\u00F3n de validaci\u00F3n de contrase\u00F1as seguras\r\nfunction validatePasswordStrength(password) {\r\n  const minLength = 8;\r\n  const hasUppercase = /[A-Z]/.test(password);\r\n  const hasLowercase = /[a-z]/.test(password);\r\n  const hasNumbers = /[0-9]/.test(password);\r\n  const hasSpecialChar = /[^a-zA-Z0-9]/.test(password);\r\n  \r\n  if (!password || password.length < minLength) {\r\n    return { \r\n      valid: false, \r\n      message: 'La contrase\u00F1a debe tener al menos 8 caracteres' \r\n    };\r\n  }\r\n  \r\n  if (!hasUppercase) {\r\n    return { \r\n      valid: false, \r\n      message: 'La contrase\u00F1a debe contener al menos una letra may\u00FAscula' \r\n    };\r\n  }\r\n  \r\n  if (!hasLowercase) {\r\n    return { \r\n      valid: false, \r\n      message: 'La contrase\u00F1a debe contener al menos una letra min\u00FAscula' \r\n    };\r\n  }\r\n  \r\n  if (!hasNumbers) {\r\n    return { \r\n      valid: false, \r\n      message: 'La contrase\u00F1a debe contener al menos un n\u00FAmero' \r\n    };\r\n  }\r\n  \r\n  if (!hasSpecialChar) {\r\n    return { \r\n      valid: false, \r\n      message: 'La contrase\u00F1a debe contener al menos un car\u00E1cter especial' \r\n    };\r\n  }\r\n  \r\n  return { valid: true };\r\n}\r\n\r\n// Headers de seguridad adicionales\r\nconst securityHeaders = {\r\n  'X-Content-Type-Options': 'nosniff',\r\n  'X-Frame-Options': 'DENY',\r\n  'X-XSS-Protection': '1; mode=block',\r\n  'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',\r\n  'Content-Security-Policy': \"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:;\"\r\n};\r\n\r\nexport async function handleLogin(request, corsHeaders, env, services) {\r\n  const { rateLimiter, authService, auditLogger } = services;\r\n  \r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n  }\r\n  \r\n  const clientIp = request.headers.get('CF-Connecting-IP') || 'unknown';\r\n  \r\n  try {\r\n    // Rate limiting para login\r\n    await rateLimiter.check(clientIp, 'login');\r\n    \r\n    // Parsear y sanitizar\r\n    const rawData = await request.json();\r\n    const { usuario, password } = InputSanitizer.sanitizeObject(rawData);\r\n    \r\n    if (!usuario || !password) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        message: 'Usuario y contrase\u00F1a son requeridos' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n      });\r\n    }\r\n    \r\n    // Buscar usuario en D1\r\n    const userResult = await env.DB_MASTER.prepare(`\r\n      SELECT * FROM usuarios \r\n      WHERE LOWER(email) = LOWER(?) OR LOWER(usuario) = LOWER(?)\r\n      LIMIT 1\r\n    `).bind(usuario, usuario).first();\r\n    \r\n    // Mensaje gen\u00E9rico para evitar enumerar usuarios\r\n    const genericLoginError = 'Usuario o contrase\u00F1a incorrectos';\r\n    \r\n    if (!userResult) {\r\n      await auditLogger.log({\r\n        action: 'LOGIN_FAILED',\r\n        resource: 'auth',\r\n        ip: clientIp,\r\n        userEmail: usuario,\r\n        success: false,\r\n        error: 'Usuario no encontrado' // Log interno mantiene el detalle\r\n      });\r\n      \r\n      // A\u00F1adir delay artificial para evitar timing attacks\r\n      await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));\r\n      \r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        message: genericLoginError // Mensaje gen\u00E9rico para el usuario\r\n      }), {\r\n        status: 401,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n      });\r\n    }\r\n    \r\n    // Verificar contrase\u00F1a\r\n    const verification = await authService.verifyPassword(password, userResult.password_hash);\r\n    \r\n    if (!verification.valid) {\r\n      await auditLogger.log({\r\n        action: 'LOGIN_FAILED',\r\n        resource: 'auth',\r\n        userId: userResult.id,\r\n        userEmail: userResult.email,\r\n        ip: clientIp,\r\n        success: false,\r\n        error: 'Contrase\u00F1a incorrecta' // Log interno mantiene el detalle\r\n      });\r\n      \r\n      // A\u00F1adir delay artificial para evitar timing attacks\r\n      await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));\r\n\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        message: genericLoginError // Mismo mensaje gen\u00E9rico\r\n      }), {\r\n        status: 401,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n      });\r\n    }\r\n\r\n\r\n    // Verificar si la contrase\u00F1a cumple con los nuevos requisitos de seguridad\r\n    const passwordStrengthCheck = validatePasswordStrength(password);\r\n    const requiresPasswordUpdate = !passwordStrengthCheck.valid || userResult.password_temporal === 1;\r\n    \r\n    // Actualizar hash si es necesario\r\n    if (verification.needsUpdate && passwordStrengthCheck.valid) {\r\n      try {\r\n        const newHash = await authService.hashPassword(password);\r\n        await env.DB_MASTER.prepare(`\r\n          UPDATE usuarios SET password_hash = ? WHERE id = ?\r\n        `).bind(newHash, userResult.id).run();\r\n      } catch (error) {\r\n        // Silently fail password hash update - non-critical operation\r\n      }\r\n    }\r\n    \r\n    // Actualizar \u00FAltimo login (D1 necesita string, no Date object)\r\n    const fechaLogin = formatLocalDateTime(getLocalDateTime());\r\n    await env.DB_MASTER.prepare(`\r\n      UPDATE usuarios SET ultimo_login = ? WHERE id = ?\r\n    `).bind(fechaLogin, userResult.id).run();\r\n    \r\n    // Determinar si es usuario Enel basado en el rol\r\n    const esEnel = userResult.rol === 'Supervisor Enel' || \r\n                  userResult.empresa?.toLowerCase().includes('enel') || \r\n                  userResult.email?.toLowerCase().includes('@enel.');\r\n    \r\n    // Parsear parques_autorizados como JSON\r\n    let parquesAutorizados = [];\r\n    if (userResult.parques_autorizados) {\r\n      try {\r\n        parquesAutorizados = JSON.parse(userResult.parques_autorizados);\r\n      } catch (error) {\r\n        console.error('Error parseando parques_autorizados:', error);\r\n        // Si no es JSON v\u00E1lido, intentar con split por si es formato antiguo\r\n        parquesAutorizados = userResult.parques_autorizados.split(',').map(p => p.trim());\r\n      }\r\n    }\r\n\r\n    const userData = {\r\n      id: userResult.id,\r\n      usuario: userResult.usuario,\r\n      email: userResult.email,\r\n      rol: userResult.rol,\r\n      empresa: userResult.empresa,\r\n      cargo: userResult.cargo,\r\n      rut: userResult.rut,\r\n      telefono: userResult.telefono,\r\n      esEnel: esEnel,\r\n      parques: parquesAutorizados,\r\n      puedeActualizarPersonal: userResult.puede_actualizar_personal === 1\r\n    };\r\n    \r\n    // Generar JWT\r\n    const token = await authService.createToken(userData);\r\n    \r\n    // Verificar si la contrase\u00F1a necesita ser cambiada (temporal o no cumple requisitos)\r\n    if (requiresPasswordUpdate) {\r\n        // Log del motivo del cambio requerido\r\n        await auditLogger.log({\r\n          action: 'PASSWORD_CHANGE_REQUIRED',\r\n          resource: 'auth',\r\n          userId: userData.id,\r\n          userEmail: userData.email,\r\n          ip: clientIp,\r\n          reason: !passwordStrengthCheck.valid ? 'weak_password' : 'temporary_password',\r\n          details: !passwordStrengthCheck.valid ? passwordStrengthCheck.message : 'Password marked as temporary'\r\n        });\r\n        \r\n        return new Response(JSON.stringify({ \r\n            success: true,\r\n            token,\r\n            user: userData,\r\n            requirePasswordChange: true,\r\n            changeReason: !passwordStrengthCheck.valid \r\n              ? 'Su contrase\u00F1a actual no cumple con los requisitos de seguridad. Por favor, cree una nueva contrase\u00F1a.'\r\n              : 'Debe cambiar su contrase\u00F1a temporal por una permanente.'\r\n        }), {\r\n            headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n        });\r\n    }\r\n    \r\n    // Log exitoso\r\n    await auditLogger.log({\r\n      action: 'LOGIN_SUCCESS',\r\n      resource: 'auth',\r\n      userId: userData.id,\r\n      userEmail: userData.email,\r\n      ip: clientIp,\r\n      success: true\r\n    });\r\n    \r\n    // Reset rate limit\r\n    await rateLimiter.reset(clientIp, 'login');\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      token,\r\n      user: userData\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      message: 'Error interno del servidor' \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleChangePassword(request, corsHeaders, env, services) {\r\n  const { authService, auditLogger } = services;\r\n  \r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const authHeader = request.headers.get('Authorization');\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n      return new Response(JSON.stringify({ \r\n        success: false,\r\n        error: 'No autorizado'\r\n      }), {\r\n        status: 401,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n      });\r\n    }\r\n    \r\n    const token = authHeader.substring(7);\r\n    const userToken = await authService.verifyToken(token);\r\n    \r\n    const { newPassword } = await request.json();\r\n    \r\n    // Validar fortaleza de contrase\u00F1a\r\n    const passwordValidation = validatePasswordStrength(newPassword);\r\n    if (!passwordValidation.valid) {\r\n      return new Response(JSON.stringify({ \r\n        success: false,\r\n        error: passwordValidation.message\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n      });\r\n    }\r\n    \r\n    // Hashear nueva contrase\u00F1a\r\n    const hashedPassword = await authService.hashPassword(newPassword);\r\n    \r\n    // Actualizar contrase\u00F1a y marcar como no temporal\r\n    await env.DB_MASTER.prepare(`\r\n      UPDATE usuarios \r\n      SET password_hash = ?,\r\n          password_temporal = 0\r\n      WHERE id = ?\r\n    `).bind(hashedPassword, userToken.sub).run();\r\n    \r\n    // Log\r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'PASSWORD_CHANGED',\r\n        resource: 'auth',\r\n        userId: userToken.sub,\r\n        userEmail: userToken.email,\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: true\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      message: 'Contrase\u00F1a actualizada exitosamente'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      success: false,\r\n      error: 'Error al cambiar la contrase\u00F1a'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders, ...securityHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default { handleLogin, handleChangePassword };", "import { InputSanitizer } from '../utils/sanitizers.js';\r\nimport AuditLogger from '../services/auditLogger.js';\r\n\r\n\r\nexport async function handleUsers(request, corsHeaders, env) {\r\n  try {\r\n    const result = await env.DB_MASTER.prepare(`\r\n      SELECT id, usuario, email, rol, empresa, parques_autorizados, \r\n             puede_actualizar_personal, ultimo_login, created_at\r\n      FROM usuarios\r\n      ORDER BY usuario ASC\r\n    `).all();\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: result.results || [],\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading users', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handlePersonal(request, corsHeaders, env) {\r\n  try {\r\n    // Ahora lee de usuarios unificada, no de personal_tecnico\r\n    const result = await env.DB_MASTER.prepare(`\r\n      SELECT id, usuario as nombre, email, empresa, cargo as rol, \r\n             rut, telefono, parques_autorizados, estado\r\n      FROM usuarios\r\n      WHERE rol IN ('Lead Technician', 'Technician', 'Supervisor Enel')\r\n      AND estado = 'Activo'\r\n      ORDER BY usuario ASC\r\n    `).all();\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: result.results || [],\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading personal', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handlePersonalByParque(request, corsHeaders, env, currentUser) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const parqueNombre = InputSanitizer.sanitizeString(url.searchParams.get('parque'));\r\n    \r\n    // Primero obtenemos todos los usuarios activos\r\n    let query = `SELECT id, usuario as nombre, email, empresa, \r\n                        cargo as rol, rut, telefono, parques_autorizados\r\n                 FROM usuarios \r\n                 WHERE estado = 'Activo'\r\n                 AND rol IN ('Lead Technician', 'Technician', 'Supervisor Enel', 'Enel Otro')\r\n                 ORDER BY usuario ASC`;\r\n    \r\n    const result = await env.DB_MASTER.prepare(query).all();\r\n    \r\n    // Aplicar filtro por empresa del usuario actual\r\n    let filteredResults = result.results || [];\r\n    \r\n    if (currentUser && filteredResults.length > 0) {\r\n      const usuarioEsEnel = currentUser.empresa && currentUser.empresa.toLowerCase().includes('enel');\r\n      \r\n      filteredResults = filteredResults.filter(user => {\r\n        const userEsEnel = user.rol === 'Supervisor Enel' || \r\n                          user.rol === 'Enel Otro' ||\r\n                          (user.empresa && user.empresa.toLowerCase().includes('enel'));\r\n        \r\n        // Si el usuario actual es de Enel, puede ver todo el personal\r\n        if (usuarioEsEnel) {\r\n          return true;\r\n        }\r\n        \r\n        // Si el usuario no es de Enel, solo puede ver:\r\n        // 1. Personal de Enel\r\n        // 2. Personal de su propia empresa\r\n        return userEsEnel || (user.empresa === currentUser.empresa);\r\n      });\r\n    }\r\n    \r\n    // Si hay un parque espec\u00EDfico, filtramos por parques autorizados\r\n    if (parqueNombre && filteredResults.length > 0) {\r\n      filteredResults = filteredResults.filter(user => {\r\n        // Los usuarios de Enel pueden trabajar en cualquier parque\r\n        const esEnel = user.rol === 'Supervisor Enel' || \r\n                      user.rol === 'Enel Otro' ||\r\n                      (user.empresa && user.empresa.toLowerCase().includes('enel'));\r\n        \r\n        if (esEnel) {\r\n          return true; // Incluir todos los usuarios de Enel\r\n        }\r\n        \r\n        // Para el resto del personal, verificar parques autorizados\r\n        if (!user.parques_autorizados) return false;\r\n        \r\n        try {\r\n          // Intentar parsear como JSON array\r\n          const parques = JSON.parse(user.parques_autorizados);\r\n          if (Array.isArray(parques)) {\r\n            return parques.some(p => {\r\n              const parqueNorm = p.toLowerCase().trim();\r\n              const busquedaNorm = parqueNombre.toLowerCase().trim();\r\n              return parqueNorm.includes(busquedaNorm) || busquedaNorm.includes(parqueNorm);\r\n            });\r\n          }\r\n        } catch (e) {\r\n          // Si no es JSON, intentar como texto separado por comas\r\n          const parques = user.parques_autorizados.split(',').map(p => p.trim());\r\n          return parques.some(p => {\r\n            const parqueNorm = p.toLowerCase().trim();\r\n            const busquedaNorm = parqueNombre.toLowerCase().trim();\r\n            return parqueNorm.includes(busquedaNorm) || busquedaNorm.includes(parqueNorm);\r\n          });\r\n        }\r\n        \r\n        return false;\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: filteredResults,\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    console.error('Error loading personal by parque:', error);\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading personal by parque', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleSupervisores(request, corsHeaders, env, currentUser) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const parqueNombre = InputSanitizer.sanitizeString(url.searchParams.get('parque'));\r\n    \r\n    // Obtener \u00FAnicamente supervisores Enel activos para el campo de Supervisor de Parque\r\n    const result = await env.DB_MASTER.prepare(`\r\n      SELECT id, usuario as nombre, email, cargo, telefono, rut, empresa,\r\n             parques_autorizados, estado, rol\r\n      FROM usuarios\r\n      WHERE rol = 'Supervisor Enel'\r\n      AND estado = 'Activo'\r\n      ORDER BY usuario ASC\r\n    `).all();\r\n    \r\n    let filteredResults = result.results || [];\r\n    \r\n    // Ya solo tenemos supervisores Enel, no necesitamos filtro adicional por empresa\r\n    \r\n    // Si se especifica un parque, filtrar supervisores Enel que lo tengan autorizado\r\n    if (parqueNombre && filteredResults.length > 0) {\r\n      filteredResults = filteredResults.filter(supervisor => {\r\n        // Todos son supervisores Enel, verificar que tengan este parque autorizado\r\n        if (!supervisor.parques_autorizados) return false;\r\n        \r\n        try {\r\n          // Intentar parsear como JSON array\r\n          const parques = JSON.parse(supervisor.parques_autorizados);\r\n          if (Array.isArray(parques)) {\r\n            return parques.some(p => {\r\n              const parqueNorm = p.toLowerCase().trim();\r\n              const busquedaNorm = parqueNombre.toLowerCase().trim();\r\n              return parqueNorm === busquedaNorm || \r\n                     parqueNorm.includes(busquedaNorm) || \r\n                     busquedaNorm.includes(parqueNorm);\r\n            });\r\n          }\r\n        } catch (e) {\r\n          // Si no es JSON, intentar como texto separado por comas\r\n          const parques = supervisor.parques_autorizados.split(',').map(p => p.trim());\r\n          return parques.some(p => {\r\n            const parqueNorm = p.toLowerCase().trim();\r\n            const busquedaNorm = parqueNombre.toLowerCase().trim();\r\n            return parqueNorm === busquedaNorm || \r\n                   parqueNorm.includes(busquedaNorm) || \r\n                   busquedaNorm.includes(parqueNorm);\r\n          });\r\n        }\r\n        \r\n        return false;\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: filteredResults,\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading supervisores', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default { handleUsers, handlePersonal, handlePersonalByParque, handleSupervisores };\r\n", "import { InputSanitizer } from '../utils/sanitizers.js';\r\n\r\nexport async function handleParques(request, corsHeaders, env) {\r\n  try {\r\n    const result = await env.DB_MASTER.prepare(`\r\n      SELECT * FROM parques_eolicos\r\n      ORDER BY nombre ASC\r\n    `).all();\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: result.results || [],\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading parques', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleAerogeneradores(request, corsHeaders, env) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const parqueNombre = InputSanitizer.sanitizeString(url.searchParams.get('parque'));\r\n    \r\n    // Usar la tabla Aerogeneradores del DB_PERMISOS con prepared statements\r\n    let query = 'SELECT Plant_Code, Plant_Name, WTG_Name FROM Aerogeneradores';\r\n    let params = [];\r\n    \r\n    if (parqueNombre) {\r\n      query += ' WHERE Plant_Name = ?';\r\n      params.push(parqueNombre);\r\n    }\r\n    \r\n    query += ' ORDER BY WTG_Name ASC';\r\n    \r\n    const result = await env.DB_PERMISOS.prepare(query).bind(...params).all();\r\n    \r\n    const adaptedResults = result.results?.map(row => ({\r\n      codigo: row.WTG_Name,\r\n      nombre: row.WTG_Name,\r\n      Plant_Code: row.Plant_Code,\r\n      Plant_Name: row.Plant_Name,\r\n      WTG_Name: row.WTG_Name\r\n    })) || [];\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: adaptedResults,\r\n      has_more: false,\r\n      total: adaptedResults.length\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading aerogeneradores'\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleActividades(request, corsHeaders, env) {\r\n  try {\r\n    const result = await env.DB_MASTER.prepare(`\r\n      SELECT * FROM actividades\r\n    `).all();\r\n    \r\n    // Definir el orden prioritario de las actividades rutinarias\r\n    const ordenPrioridad = [\r\n      'Tr\u00E1nsito al lugar de trabajo',\r\n      'Ingreso al aerogenerador', \r\n      'Uso de elevador',\r\n      'Trabajos en Ground o Foso',\r\n      'Trabajos en Secciones de Torre',\r\n      'Trabajos en Nacelle'\r\n    ];\r\n    \r\n    // Ordenar las actividades seg\u00FAn prioridad\r\n    const actividadesOrdenadas = (result.results || []).sort((a, b) => {\r\n      const indexA = ordenPrioridad.indexOf(a.nombre);\r\n      const indexB = ordenPrioridad.indexOf(b.nombre);\r\n      \r\n      // Si ambos est\u00E1n en la lista de prioridad, ordenar por \u00EDndice\r\n      if (indexA !== -1 && indexB !== -1) {\r\n        return indexA - indexB;\r\n      }\r\n      \r\n      // Si solo A est\u00E1 en prioridad, A va primero\r\n      if (indexA !== -1 && indexB === -1) {\r\n        return -1;\r\n      }\r\n      \r\n      // Si solo B est\u00E1 en prioridad, B va primero\r\n      if (indexA === -1 && indexB !== -1) {\r\n        return 1;\r\n      }\r\n      \r\n      // Si ninguno est\u00E1 en prioridad, ordenar alfab\u00E9ticamente\r\n      return a.nombre.localeCompare(b.nombre);\r\n    });\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: actividadesOrdenadas,\r\n      has_more: false\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading actividades', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default { handleParques, handleAerogeneradores, handleActividades };", "import { InputSanitizer } from '../utils/sanitizers.js';\r\n\r\nexport async function handleMatrizRiesgos(request, corsHeaders, env) {\r\n  try {\r\n    const url = new URL(request.url);\r\n    const actividades = InputSanitizer.sanitizeString(url.searchParams.get('actividades'));\r\n    \r\n    let query = `SELECT * FROM matriz_riesgos WHERE estado = 'Activo'`;\r\n    let params = [];\r\n    \r\n    if (actividades) {\r\n      const actividadesList = actividades.split(',').map(act => act.trim());\r\n      const placeholders = actividadesList.map(() => '?').join(',');\r\n      query += ` AND actividad IN (${placeholders})`;\r\n      params.push(...actividadesList);\r\n    }\r\n    \r\n    query += ` ORDER BY actividad ASC, codigo ASC`;\r\n    \r\n    const result = await env.DB_HSEQ.prepare(query).bind(...params).all();\r\n    \r\n    return new Response(JSON.stringify({\r\n      results: result.results || [],\r\n      has_more: false,\r\n      debug: {\r\n        totalResults: result.results?.length || 0,\r\n        requestedActivities: actividades ? actividades.split(',') : []\r\n      }\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    console.error('Error loading matriz riesgos:', error);\r\n    return new Response(JSON.stringify({ \r\n      error: 'Error loading matriz riesgos', \r\n      details: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default { handleMatrizRiesgos };\r\n", "export function generateTomaConocimientoPDF(data) {\r\n  // Mantener la funci\u00F3n original sin cambios\r\n  const fecha = new Date();\r\n  const fechaFormateada = fecha.toLocaleDateString('es-CL', { \r\n    weekday: 'long', \r\n    year: 'numeric', \r\n    month: 'long', \r\n    day: 'numeric',\r\n    timeZone: 'America/Santiago'\r\n  });\r\n  const horaFormateada = fecha.toLocaleTimeString('es-CL', { \r\n    hour: '2-digit', \r\n    minute: '2-digit',\r\n    timeZone: 'America/Santiago'\r\n  });\r\n\r\n  const personalRows = data.personal?.map((persona, index) => `\r\n  <tr>\r\n    <td style=\"text-align: center; padding: 8px; border: 1px solid #000;\">${index + 1}</td>\r\n    <td style=\"padding: 8px; border: 1px solid #000;\">${persona.nombre}</td>\r\n    <td style=\"padding: 8px; border: 1px solid #000;\">${persona.rut || 'Sin RUT'}</td>\r\n    <td style=\"padding: 8px; border: 1px solid #000;\">${persona.empresa || 'N/A'}</td>\r\n    <td style=\"padding: 8px; border: 1px solid #000; width: 100px;\"></td>\r\n  </tr>\r\n`).join('') || `\r\n    <tr>\r\n      <td style=\"text-align: center; padding: 8px; border: 1px solid #000;\">1</td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\">Sin personal asignado</td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\">-</td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\">-</td>\r\n      <td style=\"padding: 8px; border: 1px solid #000; width: 100px;\"></td>\r\n    </tr>\r\n  `;\r\n\r\n  const numFilasExistentes = data.personal?.length || 1;\r\n  const filasVacias = Math.max(0, 10 - numFilasExistentes);\r\n  const filasVaciasHTML = Array.from({ length: filasVacias }, (_, index) => `\r\n    <tr>\r\n      <td style=\"text-align: center; padding: 8px; border: 1px solid #000;\">${numFilasExistentes + index + 1}</td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\"></td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\"></td>\r\n      <td style=\"padding: 8px; border: 1px solid #000;\"></td>\r\n      <td style=\"padding: 8px; border: 1px solid #000; width: 100px;\"></td>\r\n    </tr>\r\n  `).join('');\r\n\r\n  return `\r\n<!DOCTYPE html>\r\n<html lang=\"es\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Registro Toma de Conocimiento - ${data.planta}</title>\r\n    <style>\r\n        @media print {\r\n            @page {\r\n                margin: 0.5in;\r\n                size: A4;\r\n            }\r\n            body {\r\n                margin: 0;\r\n                padding: 0;\r\n            }\r\n        }\r\n        \r\n        body {\r\n            font-family: Arial, sans-serif;\r\n            font-size: 11px;\r\n            line-height: 1.2;\r\n            margin: 0;\r\n            padding: 20px;\r\n            background: white;\r\n        }\r\n        \r\n        .header {\r\n            display: flex;\r\n            align-items: center;\r\n            margin-bottom: 20px;\r\n            border-bottom: 2px solid #000;\r\n            padding-bottom: 10px;\r\n        }\r\n        \r\n        .logo {\r\n          width: 120px;\r\n          height: 80px;\r\n          margin-right: 20px;\r\n          display: flex;\r\n          align-items: center;\r\n          justify-content: center;\r\n        }\r\n      \r\n        .logo img {\r\n          max-width: 100%;\r\n          max-height: 100%;\r\n          object-fit: contain;\r\n        }\r\n        \r\n        .header-info {\r\n            flex: 1;\r\n        }\r\n        \r\n        .title {\r\n            font-size: 16px;\r\n            font-weight: bold;\r\n            text-align: center;\r\n            margin-bottom: 10px;\r\n        }\r\n        \r\n        .subtitle {\r\n            font-size: 12px;\r\n            margin-bottom: 5px;\r\n        }\r\n        \r\n        .areas {\r\n            font-size: 10px;\r\n            font-style: italic;\r\n            color: #666;\r\n        }\r\n        \r\n        .info-section {\r\n            display: flex;\r\n            margin-bottom: 15px;\r\n            gap: 30px;\r\n        }\r\n        \r\n        .info-left, .info-right {\r\n            flex: 1;\r\n        }\r\n        \r\n        .info-row {\r\n            margin-bottom: 8px;\r\n            display: flex;\r\n            align-items: baseline;\r\n        }\r\n        \r\n        .info-label {\r\n            font-weight: bold;\r\n            margin-right: 10px;\r\n            min-width: 120px;\r\n        }\r\n        \r\n        .info-value {\r\n            border-bottom: 1px solid #000;\r\n            flex: 1;\r\n            padding-bottom: 2px;\r\n        }\r\n        \r\n        .description-section {\r\n            margin: 20px 0;\r\n        }\r\n        \r\n        .description-label {\r\n            font-weight: bold;\r\n            margin-bottom: 5px;\r\n        }\r\n        \r\n        .description-content {\r\n            border: 1px solid #000;\r\n            padding: 10px;\r\n            min-height: 40px;\r\n            background: #f9f9f9;\r\n        }\r\n        \r\n        .activities-section {\r\n            margin: 20px 0;\r\n        }\r\n        \r\n        .activities-row {\r\n            display: flex;\r\n            margin-bottom: 8px;\r\n            align-items: baseline;\r\n        }\r\n        \r\n        .activities-label {\r\n            font-weight: bold;\r\n            margin-right: 10px;\r\n            min-width: 200px;\r\n        }\r\n        \r\n        .activities-content {\r\n            border-bottom: 1px solid #000;\r\n            flex: 1;\r\n            padding-bottom: 2px;\r\n        }\r\n        \r\n        .table-section {\r\n            margin: 20px 0;\r\n        }\r\n        \r\n        .participants-table {\r\n            width: 100%;\r\n            border-collapse: collapse;\r\n            margin-top: 10px;\r\n        }\r\n        \r\n        .participants-table th {\r\n            background: #4CAF50;\r\n            color: white;\r\n            padding: 8px;\r\n            text-align: center;\r\n            font-weight: bold;\r\n            border: 1px solid #000;\r\n            font-size: 10px;\r\n        }\r\n        \r\n        .participants-table td {\r\n            padding: 8px;\r\n            border: 1px solid #000;\r\n            vertical-align: top;\r\n        }\r\n        \r\n        .print-button {\r\n            position: fixed;\r\n            top: 20px;\r\n            right: 20px;\r\n            background: #4CAF50;\r\n            color: white;\r\n            border: none;\r\n            padding: 10px 20px;\r\n            border-radius: 5px;\r\n            cursor: pointer;\r\n            font-size: 14px;\r\n            z-index: 1000;\r\n        }\r\n        \r\n        @media print {\r\n            .print-button {\r\n                display: none;\r\n            }\r\n        }\r\n        \r\n        .print-button:hover {\r\n            background: #45a049;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <button class=\"print-button\" onclick=\"window.print()\">\uD83D\uDDA8\uFE0F Imprimir PDF</button>\r\n    \r\n    <div class=\"header\">\r\n        <div class=\"logo\">\r\n        <!-- \uD83C\uDFA8 LOGO ENEL GREEN POWER - INSTRUCCIONES PARA CAMBIAR -->\r\n        <!-- Para reemplazar el logo: -->\r\n        <!-- 1. Convertir imagen nueva a base64: https://base64.guru/converter/encode/image -->\r\n        <!-- 2. Reemplazar SOLO el string despu\u00E9s de \"base64,\" en la l\u00EDnea de abajo -->\r\n        <!-- 3. Mantener el formato: data:image/[tipo];base64,[string-base64] -->\r\n        <!-- Logo actual: SVG embebido para garantizar disponibilidad -->\r\n        <img src=\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIzLjAuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsKCTwhRU5USVRZIG5zX2V4dGVuZCAiaHR0cDovL25zLmFkb2JlLmNvbS9FeHRlbnNpYmlsaXR5LzEuMC8iPgoJPCFFTlRJVFkgbnNfYWkgImh0dHA6Ly9ucy5hZG9iZS5jb20vQWRvYmVJbGx1c3RyYXRvci8xMC4wLyI+Cgk8IUVOVElUWSBuc19ncmFwaHMgImh0dHA6Ly9ucy5hZG9iZS5jb20vR3JhcGhzLzEuMC8iPgoJPCFFTlRJVFkgbnNfdmFycyAiaHR0cDovL25zLmFkb2JlLmNvbS9WYXJpYWJsZXMvMS4wLyI+Cgk8IUVOVElUWSBuc19pbXJlcCAiaHR0cDovL25zLmFkb2JlLmNvbS9JbWFnZVJlcGxhY2VtZW50LzEuMC8iPgoJPCFFTlRJVFkgbnNfc2Z3ICJodHRwOi8vbnMuYWRvYmUuY29tL1NhdmVGb3JXZWIvMS4wLyI+Cgk8IUVOVElUWSBuc19jdXN0b20gImh0dHA6Ly9ucy5hZG9iZS5jb20vR2VuZXJpY0N1c3RvbU5hbWVzcGFjZS8xLjAvIj4KCTwhRU5USVRZIG5zX2Fkb2JlX3hwYXRoICJodHRwOi8vbnMuYWRvYmUuY29tL1hQYXRoLzEuMC8iPgpdPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkVHUF9Mb2dvX1ByaW1hcnlfUkdCIiB4bWxuczp4PSImbnNfZXh0ZW5kOyIgeG1sbnM6aT0iJm5zX2FpOyIgeG1sbnM6Z3JhcGg9IiZuc19ncmFwaHM7IgoJIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMjgzLjUgMTQyLjEiCgkgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjgzLjUgMTQyLjEiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8bWV0YWRhdGE+Cgk8c2Z3ICB4bWxucz0iJm5zX3NmdzsiPgoJCTxzbGljZXM+PC9zbGljZXM+CgkJPHNsaWNlU291cmNlQm91bmRzICBib3R0b21MZWZ0T3JpZ2luPSJ0cnVlIiBoZWlnaHQ9IjE0Mi4xIiB3aWR0aD0iMjgzLjUiIHg9IjI2OTQuNiIgeT0iLTQxMzkuNSI+PC9zbGljZVNvdXJjZUJvdW5kcz4KCTwvc2Z3Pgo8L21ldGFkYXRhPgo8Zz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMjY2Ljg2MiIgeTE9IjQxLjI5NjkiIHgyPSIyNjYuODYyIiB5Mj0iNzYuNDU5NCI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM3M0I5NjQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cmVjdCB4PSIyNjEiIHk9IjQxIiBmaWxsPSJ1cmwoI1NWR0lEXzFfKSIgd2lkdGg9IjExLjciIGhlaWdodD0iMzUuNCIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8yXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyNzEuMjU5OCIgeTE9Ijg2LjgzNzUiIHgyPSIyODEuOTk0NiIgeTI9Ijk1LjY4OSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzczQjk2NCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM3M0I5NjQ7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzJfKSIgZD0iTTI3Mi43LDc2LjNjMCw4LjUsMy45LDEyLjEsMTAuNywxNi44bC02LjcsOS42Yy0xMC02LjYtMTUuOC0xNC0xNS44LTI2LjRIMjcyLjd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzNfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjEwMS41MDY1IiB5MT0iNDEuNDQ0MSIgeDI9IjEyOC40Nzc4IiB5Mj0iNDEuNDQ0MSI+CgkJPHN0b3AgIG9mZnNldD0iNC43MDIyNDFlLTAzIiBzdHlsZT0ic3RvcC1jb2xvcjojMDA4QzVBIi8+CgkJPHN0b3AgIG9mZnNldD0iMC45OTU3IiBzdHlsZT0ic3RvcC1jb2xvcjojMzJBOTU5Ii8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8zXykiIGQ9Ik0xMjcuNiwyNC4yYy0xMC4yLDAtMTkuNCw0LjEtMjYuMSwxMC43djIzLjhjMS44LTkuNCwxMC4xLTIyLjgsMjYuMS0yMi44YzAuMywwLDAuNiwwLDAuOSwwVjI0LjIKCQlDMTI4LjIsMjQuMiwxMjcuOSwyNC4yLDEyNy42LDI0LjJ6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzRfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE0NC4wNjczIiB5MT0iMzguMzY2IiB4Mj0iMTQ0LjA2NzMiIHkyPSI1OS4xMTYxIj4KCQk8c3RvcCAgb2Zmc2V0PSIxLjExMDQ1NmUtMDIiIHN0eWxlPSJzdG9wLWNvbG9yOiMzMkE5NTkiLz4KCQk8c3RvcCAgb2Zmc2V0PSIwLjE3MDEiIHN0eWxlPSJzdG9wLWNvbG9yOiM0MUIyNTkiLz4KCQk8c3RvcCAgb2Zmc2V0PSIwLjMzMyIgc3R5bGU9InN0b3AtY29sb3I6IzU1QkU1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM1NUJFNUE7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzRfKSIgZD0iTTE2MC4yLDYwLjVoLTExLjdsMC0zLjljMC0xMS42LTkuMi0yMC42LTIwLjUtMjAuN1YyNC4yYzE3LjgsMC4yLDMyLjIsMTQuNSwzMi4yLDMyLjVWNjAuNXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfNV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTUzLjc0MjgiIHkxPSI1NC41ODI2IiB4Mj0iMTU0LjMzOTciIHkyPSI2MC42NjM5Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojRTk0OTg2Ii8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0U5NDk4NjtzdG9wLW9wYWNpdHk6MCIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxsaW5lIGZpbGw9InVybCgjU1ZHSURfNV8pIiB4MT0iMTYwLjIiIHkxPSI2MC41IiB4Mj0iMTQ4LjUiIHkyPSI2MC41Ii8+Cgk8cmVjdCB4PSI4OS44IiB5PSIyNy40IiBmaWxsPSIjQzZDNkM2IiB3aWR0aD0iMTEuNyIgaGVpZ2h0PSI0MSIvPgoJPHJlY3QgeD0iMjYxIiBmaWxsPSIjQzZDNkM2IiB3aWR0aD0iMTEuNyIgaGVpZ2h0PSI0MSIvPgoJPHJlY3QgeD0iMTQ4LjUiIHk9IjYwLjUiIGZpbGw9IiNDNkM2QzYiIHdpZHRoPSIxMS43IiBoZWlnaHQ9IjQxIi8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzZfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjcxLjUyMyIgeTE9IjUzLjMzOTIiIHgyPSI2NC4xNjY0IiB5Mj0iNDAuNjk1MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMxRDk3NUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzZfKSIgZD0iTTY2LjEsNTYuN2gxMmMtMS40LTguMy01LjUtMTUuNi0xMS4yLTIxLjNsLTguMiw4LjRDNjIuMiw0Ny4zLDY0LjgsNTEuNyw2Ni4xLDU2Ljd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjYxLjIxODUiIHkxPSIzNy41MzgyIiB4Mj0iNDEuNzU0MyIgeTI9IjI5LjQ5MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzFEOTc1RCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzdfKSIgZD0iTTM5LjMsMzUuOWM3LjYsMCwxNC41LDMuMSwxOS41LDhsOC4zLTguM2MtNy4xLTcuMS0xNy0xMS41LTI3LjgtMTEuNWMtMC4xLDAtMC4yLDAtMC4zLDBMMzksMzUuOQoJCUMzOS4xLDM1LjksMzkuMiwzNS45LDM5LjMsMzUuOXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfOF8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTYuODgiIHkxPSIzNy44NjYyIiB4Mj0iMzYuNDk3NCIgeTI9IjI5LjUxMzUiPgoJCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiMzREE0NUYiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojMjg5QjVEIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF84XykiIGQ9Ik0zOS4zLDM1LjlWMjQuMmMtMTEsMC0yMC45LDQuNS0yOCwxMS43bDguNCw4LjJDMjQuNiwzOS4xLDMxLjYsMzUuOSwzOS4zLDM1Ljl6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzlfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUuNDEwNCIgeTE9IjYwLjcyMzUiIHgyPSIxMy40NTY2IiB5Mj0iNDEuNDEyNiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzUwQUI2MCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMzREE0NUYiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzlfKSIgZD0iTTExLjcsNjMuNWMwLTcuNiwzLjEtMTQuNSw4LjEtMTkuNWwtOC4zLTguM0M0LjQsNDIuOCwwLDUyLjYsMCw2My41YzAsMC4xLDAsMC4yLDAsMC4zbDExLjctMC4xCgkJQzExLjcsNjMuNiwxMS43LDYzLjUsMTEuNyw2My41eiIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xMF8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iNS4zNTE0IiB5MT0iNjYuMzE5IiB4Mj0iMTMuNzA0MiIgeTI9Ijg1Ljc4MzIiPgoJCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MEFCNjAiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojNjdCNDYyIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMF8pIiBkPSJNMTEuNyw2My41SDBjMCwxMSw0LjUsMjAuOSwxMS43LDI4bDguMi04LjRDMTQuOSw3OC4xLDExLjcsNzEuMiwxMS43LDYzLjV6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzExXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxNS41MzYzIiB5MT0iODguNzAwMyIgeDI9IjM4LjMyMjkiIHkyPSI5OC4wMjIxIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNjdCNDYyIi8+CgkJPHN0b3AgIG9mZnNldD0iMC45NjIzIiBzdHlsZT0ic3RvcC1jb2xvcjojOTJDODg2Ii8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMV8pIiBkPSJNMzkuMyw5MWMtNy42LDAtMTQuNS0zLjEtMTkuNS04LjFsLTguMyw4LjNjNy4xLDcuMSwxNi45LDExLjUsMjcuOCwxMS41YzAuMSwwLDAuMiwwLDAuMywwCgkJTDM5LjUsOTFDMzkuNCw5MSwzOS40LDkxLDM5LjMsOTF6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzEyXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIzOS4yNTg4IiB5MT0iMTA2LjQ5MTEiIHgyPSI2Mi4zNDI2IiB5Mj0iODEuMDUxNyI+CgkJPHN0b3AgIG9mZnNldD0iMC4zMjkiIHN0eWxlPSJzdG9wLWNvbG9yOiM5MkM4ODYiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojOTJDODg2O3N0b3Atb3BhY2l0eTowIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMl8pIiBkPSJNNjEuMSw4MC4yYy01LDYuNi0xMywxMC44LTIxLjksMTAuOHYxMS43YzEyLjcsMCwyNC02LDMxLjItMTUuNEw2MS4xLDgwLjJ6Ii8+Cgk8cmVjdCB4PSIzNyIgeT0iNTYuNyIgZmlsbD0iI0M2QzZDNiIgd2lkdGg9IjQxIiBoZWlnaHQ9IjExLjciLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTNfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjI0Mi43NDExIiB5MT0iNTMuMzM5MiIgeDI9IjIzNS4zODQ2IiB5Mj0iNDAuNjk1MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMxRDk3NUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzEzXykiIGQ9Ik0yMzcuMyw1Ni43aDEyYy0xLjQtOC4zLTUuNS0xNS42LTExLjItMjEuM2wtOC4yLDguNEMyMzMuNCw0Ny4zLDIzNiw1MS43LDIzNy4zLDU2Ljd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE0XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyMzIuNDM2NyIgeTE9IjM3LjUzODIiIHgyPSIyMTIuOTcyNSIgeTI9IjI5LjQ5MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzFEOTc1RCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE0XykiIGQ9Ik0yMTAuNSwzNS45YzcuNiwwLDE0LjUsMy4xLDE5LjUsOGw4LjMtOC4zYy03LjEtNy4xLTE3LTExLjUtMjcuOC0xMS41Yy0wLjEsMC0wLjIsMC0wLjMsMAoJCWwwLjEsMTEuN0MyMTAuMywzNS45LDIxMC40LDM1LjksMjEwLjUsMzUuOXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTVfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE4OC4wOTgxIiB5MT0iMzcuODY2MiIgeDI9IjIwNy43MTU2IiB5Mj0iMjkuNTEzNSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzNEQTQ1RiIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE1XykiIGQ9Ik0yMTAuNSwzNS45VjI0LjJjLTExLDAtMjAuOSw0LjUtMjgsMTEuN2w4LjQsOC4yQzE5NS44LDM5LjEsMjAyLjgsMzUuOSwyMTAuNSwzNS45eiIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xNl8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTc2LjYyODYiIHkxPSI2MC43MjM1IiB4Mj0iMTg0LjY3NDgiIHkyPSI0MS40MTI2Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNTBBQjYwIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6IzNEQTQ1RiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMTZfKSIgZD0iTTE4Mi45LDYzLjVjMC03LjYsMy4xLTE0LjUsOC4xLTE5LjVsLTguMy04LjNjLTcuMSw3LjEtMTEuNSwxNi45LTExLjUsMjcuOGMwLDAuMSwwLDAuMiwwLDAuMwoJCWwxMS43LTAuMUMxODIuOSw2My42LDE4Mi45LDYzLjUsMTgyLjksNjMuNXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE3Ni41Njk2IiB5MT0iNjYuMzE5IiB4Mj0iMTg0LjkyMjMiIHkyPSI4NS43ODMyIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNTBBQjYwIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6IzY3QjQ2MiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMTdfKSIgZD0iTTE4Mi45LDYzLjVoLTExLjdjMCwxMSw0LjUsMjAuOSwxMS43LDI4bDguMi04LjRDMTg2LjEsNzguMSwxODIuOSw3MS4yLDE4Mi45LDYzLjV6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE4XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxODYuNzU0NCIgeTE9Ijg4LjcwMDMiIHgyPSIyMDkuNTQxIiB5Mj0iOTguMDIyMSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzY3QjQ2MiIvPgoJCTxzdG9wICBvZmZzZXQ9IjAuOTYyMyIgc3R5bGU9InN0b3AtY29sb3I6IzkyQzg4NiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMThfKSIgZD0iTTIxMC41LDkxYy03LjYsMC0xNC41LTMuMS0xOS41LTguMWwtOC4zLDguM2M3LjEsNy4xLDE2LjksMTEuNSwyNy44LDExLjVjMC4xLDAsMC4yLDAsMC4zLDAKCQlMMjEwLjcsOTFDMjEwLjcsOTEsMjEwLjYsOTEsMjEwLjUsOTF6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE5XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyMTAuNDc2OSIgeTE9IjEwNi40OTExIiB4Mj0iMjMzLjU2MDgiIHkyPSI4MS4wNTE3Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwLjMyOSIgc3R5bGU9InN0b3AtY29sb3I6IzkyQzg4NiIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM5MkM4ODY7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE5XykiIGQ9Ik0yMzIuNCw4MC4yYy01LDYuNi0xMywxMC44LTIxLjksMTAuOHYxMS43YzEyLjcsMCwyNC02LDMxLjItMTUuNEwyMzIuNCw4MC4yeiIvPgoJPHJlY3QgeD0iMjA4LjIiIHk9IjU2LjciIGZpbGw9IiNDNkM2QzYiIHdpZHRoPSI0MSIgaGVpZ2h0PSIxMS43Ii8+Cgk8Zz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMTUzLjIsMTMzLjJ2Ny45Yy0yLDAuOC0zLjksMS02LDFjLTQuNiwwLTcuMi0zLjYtNy4yLTguN2MwLTQuMywyLjMtOC43LDcuMi04LjdjMi44LDAsNS42LDEuNSw1LjksNC41CgkJCWgtMS43Yy0wLjMtMi4xLTIuMi0zLjEtNC4yLTMuMWMtNCwwLTUuNSwzLjktNS41LDcuM2MwLDQuMywxLjgsNy4zLDYuMyw3LjNjMS4zLDAsMi41LTAuMywzLjctMC43di01LjRoLTQuMnYtMS40SDE1My4yeiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0xNTguNiwxNDEuOGgtMS40di05YzAtMC45LTAuMS0xLjgtMC4xLTIuNmgxLjRsMC4xLDEuN2gwYzAuNC0xLjIsMS41LTIsMi42LTIuMWMwLjUsMCwwLjksMCwxLjQsMHYxLjMKCQkJYy0wLjMsMC0wLjYtMC4xLTAuOS0wLjFjLTIuMSwwLTMuMiwxLjUtMy4yLDMuN1YxNDEuOHoiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMTY1LjcsMTM2LjNjMCwyLjUsMS4yLDQuNiw0LDQuNmMxLjcsMCwzLTEuMiwzLjQtMi44aDEuNWMtMC43LDIuOC0yLjUsNC4xLTUuMyw0LjFjLTMuNSwwLTUuMS0zLTUuMS02LjIKCQkJYzAtMy4yLDEuNy02LjIsNS4yLTYuMmMzLjksMCw1LjMsMi45LDUuMyw2LjVIMTY1Ljd6IE0xNzMuMiwxMzVjLTAuMi0yLjMtMS40LTQtMy44LTRjLTIuMywwLTMuNSwxLjktMy43LDRIMTczLjJ6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTE3OC42LDEzNi4zYzAsMi41LDEuMiw0LjYsNCw0LjZjMS43LDAsMy0xLjIsMy40LTIuOGgxLjVjLTAuNywyLjgtMi41LDQuMS01LjMsNC4xYy0zLjUsMC01LjEtMy01LjEtNi4yCgkJCWMwLTMuMiwxLjctNi4yLDUuMi02LjJjMy45LDAsNS4zLDIuOSw1LjMsNi41SDE3OC42eiBNMTg2LjEsMTM1Yy0wLjItMi4zLTEuNC00LTMuOC00Yy0yLjMsMC0zLjUsMS45LTMuNyw0SDE4Ni4xeiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0xOTIuMSwxNDEuOGgtMS40di05YzAtMC45LTAuMS0xLjgtMC4xLTIuNmgxLjRsMC4xLDEuN2wwLDBjMC44LTEuNCwyLjEtMi4xLDMuNi0yLjEKCQkJYzMuOCwwLDQuMSwzLjQsNC4xLDQuN3Y3LjNoLTEuNHYtNy41YzAtMi0xLjItMy4yLTMuMS0zLjJjLTIuMywwLTMuMywxLjktMy4zLDRWMTQxLjh6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTIxMC42LDE0MS44VjEyNWg0LjJjMy4yLTAuMSw2LjksMC43LDYuOSw0LjdjMCw0LTMuNiw0LjgtNi45LDQuN2gtMi43djcuM0gyMTAuNnogTTIxMi4xLDEzMy4xaDMuNwoJCQljMi4zLDAsNC4zLTAuNyw0LjMtMy4zYzAtMi42LTItMy4zLTQuMy0zLjNoLTMuN1YxMzMuMXoiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMjMzLjEsMTM1LjljMCwzLjEtMS43LDYuMi01LjQsNi4yYy0zLjcsMC01LjQtMy4xLTUuNC02LjJzMS43LTYuMiw1LjQtNi4yCgkJCUMyMzEuNCwxMjkuOCwyMzMuMSwxMzIuOSwyMzMuMSwxMzUuOXogTTIyNy43LDEzMWMtMi44LDAtMy45LDIuNy0zLjksNC45czEuMSw0LjksMy45LDQuOWMyLjgsMCwzLjktMi43LDMuOS00LjkKCQkJUzIzMC41LDEzMSwyMjcuNywxMzF6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTIzOSwxMzkuOUwyMzksMTM5LjlsMy42LTkuOGgxLjZsMy40LDkuN2gwbDMuNC05LjdoMS41bC00LjMsMTEuN0gyNDdsLTMuNi0xMC4xaDBsLTMuNiwxMC4xaC0xLjQKCQkJbC00LjMtMTEuN2gxLjVMMjM5LDEzOS45eiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0yNTUuMiwxMzYuM2MwLDIuNSwxLjIsNC42LDQsNC42YzEuNiwwLDMtMS4yLDMuNC0yLjhoMS41Yy0wLjcsMi44LTIuNSw0LjEtNS4zLDQuMWMtMy41LDAtNS4xLTMtNS4xLTYuMgoJCQljMC0zLjIsMS43LTYuMiw1LjItNi4yYzMuOSwwLDUuMywyLjksNS4zLDYuNUgyNTUuMnogTTI2Mi43LDEzNWMtMC4yLTIuMy0xLjQtNC0zLjgtNGMtMi4zLDAtMy41LDEuOS0zLjcsNEgyNjIuN3oiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMjY4LjcsMTQxLjhoLTEuNHYtOWMwLTAuOS0wLjEtMS44LTAuMS0yLjZoMS40bDAuMSwxLjdoMGMwLjQtMS4yLDEuNS0yLDIuNi0yLjFjMC41LDAsMC45LDAsMS40LDB2MS4zCgkJCWMtMC4zLDAtMC42LTAuMS0wLjktMC4xYy0yLjEsMC0zLjIsMS41LTMuMiwzLjdWMTQxLjh6Ii8+Cgk8L2c+CjwvZz4KPC9zdmc+Cg==\" alt=\"Enel Green Power\">\r\n        </div>\r\n        <div class=\"header-info\">\r\n            <div class=\"title\">REGISTRO TOMA DE CONOCIMIENTO PT WIND</div>\r\n            <div class=\"subtitle\">\u00C1reas de Aplicaci\u00F3n</div>\r\n            <div class=\"areas\">\r\n                Per\u00EDmetro, Chile y Pa\u00EDses Andinos<br>\r\n                Funci\u00F3n: Health, Safety, Environment and Quality<br>\r\n                Business Line: Renewable Energies\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"info-section\">\r\n        <div class=\"info-left\">\r\n            <div class=\"info-row\">\r\n                <span class=\"info-label\">NOMBRE JEFE DE FAENA:</span>\r\n                <span class=\"info-value\">${data.jefeFaena || 'No asignado'}</span>\r\n            </div>\r\n        </div>\r\n        <div class=\"info-right\">\r\n            <div class=\"info-row\">\r\n                <span class=\"info-label\">Firma:</span>\r\n                <span class=\"info-value\"></span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"info-section\">\r\n        <div class=\"info-left\">\r\n            <div class=\"info-row\">\r\n                <span class=\"info-label\">Lugar:</span>\r\n                <span class=\"info-value\">${data.planta || ''}_${data.aerogenerador || ''}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"info-section\">\r\n        <div class=\"info-left\">\r\n            <div class=\"info-row\">\r\n                <span class=\"info-label\">Fecha:</span>\r\n                <span class=\"info-value\">${fechaFormateada}</span>\r\n            </div>\r\n        </div>\r\n        <div class=\"info-right\">\r\n            <div class=\"info-row\">\r\n                <span class=\"info-label\">Horario:</span>\r\n                <span class=\"info-value\">${horaFormateada}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"description-section\">\r\n        <div class=\"description-label\">Descripci\u00F3n de trabajo (s)</div>\r\n        <div class=\"description-content\">\r\n            ${data.descripcion || 'Sin descripci\u00F3n'}\r\n            <br><br>\r\n            <strong>Tipo de Mantenimiento:</strong> ${data.tipoMantenimiento || 'No especificado'}\r\n            ${data.tipoMantenimientoOtros ? ' - ' + data.tipoMantenimientoOtros : ''}\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"activities-section\">\r\n        <div class=\"activities-row\">\r\n            <span class=\"activities-label\">Actividades Rutinarias asociadas:</span>\r\n            <span class=\"activities-content\">${data.actividadesRutinarias?.join(' - ') || 'Ninguna'}</span>\r\n        </div>\r\n        <div class=\"activities-row\">\r\n            <span class=\"activities-label\">Actividades Extraordinarias asociadas:</span>\r\n            <span class=\"activities-content\">Ninguna</span>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"table-section\">\r\n        <table class=\"participants-table\">\r\n            <thead>\r\n                <tr>\r\n                    <th>N\u00B0</th>\r\n                    <th>NOMBRE DEL PARTICIPANTE</th>\r\n                    <th>RUT/C\u00C9DULA</th>\r\n                    <th>EMPRESA</th>\r\n                    <th>FIRMA</th>\r\n                </tr>\r\n            </thead>\r\n            <tbody>\r\n                ${personalRows}\r\n                ${filasVaciasHTML}\r\n            </tbody>\r\n        </table>\r\n    </div>\r\n    \r\n    <script>\r\n        setTimeout(() => {\r\n            if (confirm('\u00BFDesea imprimir el documento PDF ahora?')) {\r\n                window.print();\r\n            }\r\n        }, 2000);\r\n    </script>\r\n</body>\r\n</html>\r\n  `;\r\n}\r\n\r\nexport default generateTomaConocimientoPDF;\r\n\r\n", "import AuditLogger from '../services/auditLogger.js';\r\nimport { getLocalDateTime, formatLocalDateTime } from '../utils/time.js';\r\nimport { InputSanitizer } from '../utils/sanitizers.js';\r\nimport generateTomaConocimientoPDF from './pdf.js';\r\n\r\nexport async function handlePermisos(request, corsHeaders, env, currentUser, services) {\r\n  const { auditLogger } = services;\r\n  \r\n  if (request.method === 'POST' || request.method === 'PUT') {\r\n    const rawData = await request.json();\r\n    const permisoData = InputSanitizer.sanitizeObject(rawData);\r\n    \r\n    if (!permisoData.planta || !permisoData.descripcion || !permisoData.jefeFaena) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Faltan campos obligatorios'\r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    try {\r\n      // Si es PUT (edici\u00F3n), manejar actualizaci\u00F3n\r\n      if (request.method === 'PUT') {\r\n        return await handleUpdatePermiso(permisoData, env, currentUser, services, corsHeaders);\r\n      }\r\n      \r\n      // TEMPORAL: Comentar validaci\u00F3n para debugging\r\n      /*\r\n      const esEnel = currentUser?.esEnel || false;\r\n      const parquesAutorizados = currentUser?.parques || [];\r\n      \r\n      if (!esEnel && !parquesAutorizados.includes(permisoData.planta)) {\r\n        return new Response(JSON.stringify({ \r\n          success: false, \r\n          error: 'No tiene autorizaci\u00F3n para crear permisos en esta planta'\r\n        }), {\r\n          status: 403,\r\n          headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n        });\r\n      }\r\n      */\r\n      \r\n      // Obtener n\u00FAmero correlativo\r\n      let numeroCorrelativo = 1;\r\n      \r\n      const lastPermiso = await env.DB_PERMISOS.prepare(`\r\n        SELECT COALESCE(MAX(CAST(numero_correlativo AS INTEGER)), 0) as ultimo_numero \r\n        FROM permisos_trabajo \r\n        WHERE planta_nombre = ?\r\n      `).bind(permisoData.planta).first();\r\n       \r\n      numeroCorrelativo = (lastPermiso?.ultimo_numero || 0) + 1;\r\n      \r\n      const codigoParque = permisoData.codigoParque || \r\n                          permisoData.planta.replace(/\\s+/g, '').substring(0, 3).toUpperCase();\r\n      const numeroPT = `PT-${codigoParque}-${numeroCorrelativo.toString().padStart(4, '0')}`;\r\n      \r\n      // Insertar permiso\r\n      const insertPermiso = await env.DB_PERMISOS.prepare(`\r\n        INSERT INTO permisos_trabajo (\r\n          numero_pt, numero_correlativo, planta_id, planta_nombre, \r\n          aerogenerador_id, aerogenerador_nombre, descripcion, \r\n          jefe_faena_id, jefe_faena_nombre, supervisor_parque_id, \r\n          supervisor_parque_nombre, tipo_mantenimiento, tipo_mantenimiento_otros,\r\n          usuario_creador, usuario_creador_id, observaciones, estado,\r\n          fecha_inicio, fecha_creacion, created_at\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `).bind(\r\n        numeroPT,\r\n        numeroCorrelativo.toString(),\r\n        permisoData.plantaId || 'unknown',\r\n        permisoData.planta,\r\n        permisoData.aerogeneradorCodigo || null,\r\n        permisoData.aerogenerador || null,\r\n        permisoData.descripcion,\r\n        permisoData.jefeFaenaId || 'unknown',\r\n        permisoData.jefeFaena,\r\n        permisoData.supervisorParqueId || null,\r\n        permisoData.supervisorParque || null,\r\n        permisoData.tipoMantenimiento || 'PREVENTIVO',\r\n        permisoData.tipoMantenimientoOtros || null,\r\n        permisoData.usuarioCreador || currentUser?.email || 'unknown',\r\n        parseInt(currentUser?.id) || 'unknown',\r\n        permisoData.observaciones || null,\r\n        'CREADO',\r\n        permisoData.fechaInicio || formatLocalDateTime(getLocalDateTime()),\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        formatLocalDateTime(getLocalDateTime())\r\n      ).run();\r\n      \r\n      const permisoId = insertPermiso.meta.last_row_id;\r\n      \r\n      // Insertar personal - ahora usando usuario.id\r\n      if (permisoData.personal && permisoData.personal.length > 0) {\r\n        for (const persona of permisoData.personal) {\r\n          await env.DB_PERMISOS.prepare(`\r\n            INSERT INTO permiso_personal (\r\n              permiso_id, personal_id, personal_nombre, \r\n              personal_empresa, personal_rol, created_at\r\n            ) VALUES (?, ?, ?, ?, ?, ?)\r\n          `).bind(\r\n            permisoId, \r\n            parseInt(persona.id), // Ahora es el usuario.id directamente\r\n            persona.nombre || 'Sin nombre', \r\n            persona.empresa || 'Sin empresa', \r\n            persona.rol || 'Sin rol',\r\n            formatLocalDateTime(getLocalDateTime())\r\n          ).run();\r\n        }\r\n      }\r\n      \r\n      // Insertar actividades\r\n      if (permisoData.actividades && permisoData.actividades.length > 0) {\r\n        for (const actividad of permisoData.actividades) {\r\n          await env.DB_PERMISOS.prepare(`\r\n            INSERT INTO permiso_actividades (\r\n              permiso_id, actividad_id, actividad_nombre, \r\n              tipo_actividad, created_at\r\n            ) VALUES (?, ?, ?, ?, ?)\r\n          `).bind(\r\n            permisoId, \r\n            actividad.id || 'unknown', \r\n            actividad.nombre || 'Sin nombre', \r\n            actividad.tipo || 'RUTINARIA',\r\n            formatLocalDateTime(getLocalDateTime())\r\n          ).run();\r\n        }\r\n      }\r\n      \r\n      // Insertar matriz de riesgos\r\n      if (permisoData.matrizRiesgos && permisoData.matrizRiesgos.length > 0) {\r\n        for (const riesgo of permisoData.matrizRiesgos) {\r\n          await env.DB_PERMISOS.prepare(`\r\n            INSERT INTO permiso_matriz_riesgos (\r\n              permiso_id, actividad, peligro, riesgo, \r\n              medidas_preventivas, codigo_matriz, created_at\r\n            ) VALUES (?, ?, ?, ?, ?, ?, ?)\r\n          `).bind(\r\n            permisoId, \r\n            riesgo.actividad || 'Sin actividad', \r\n            riesgo.peligro || 'Sin peligro', \r\n            riesgo.riesgo || 'Sin riesgo', \r\n            riesgo.medidas || 'Sin medidas', \r\n            riesgo.codigo || null,\r\n            formatLocalDateTime(getLocalDateTime())\r\n          ).run();\r\n        }\r\n      }\r\n      \r\n      // Log auditor\u00EDa\r\n      if (auditLogger) {\r\n        await auditLogger.log({\r\n          action: 'CREATE_PERMISO',\r\n          resource: 'permisos',\r\n          resourceId: permisoId.toString(),\r\n          userId: currentUser?.sub || 'anonymous',\r\n          userEmail: currentUser?.email || permisoData.usuarioCreador,\r\n          ip: request.headers.get('CF-Connecting-IP'),\r\n          success: true,\r\n          metadata: { numeroPT, planta: permisoData.planta }\r\n        });\r\n      }\r\n      \r\n      return new Response(JSON.stringify({ \r\n        success: true, \r\n        id: permisoId, \r\n        numeroPT: numeroPT,\r\n        numeroCorrelativo: numeroCorrelativo,\r\n        message: 'Permiso guardado exitosamente'\r\n      }), {\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('Error creando permiso:', error);\r\n      \r\n      if (auditLogger) {\r\n        await auditLogger.log({\r\n          action: 'CREATE_PERMISO_FAILED',\r\n          resource: 'permisos',\r\n          userId: currentUser?.sub || 'anonymous',\r\n          userEmail: currentUser?.email || permisoData.usuarioCreador,\r\n          ip: request.headers.get('CF-Connecting-IP'),\r\n          success: false,\r\n          error: error.message\r\n        });\r\n      }\r\n      \r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: `Error al guardar el permiso: ${error.message}`\r\n      }), {\r\n        status: 500,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n  }\r\n  \r\n  // GET permisos\r\n  try {\r\n    // Primero obtenemos los permisos con informaci\u00F3n b\u00E1sica\r\n    const permisosResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT \r\n        p.*,\r\n        pc.fecha_inicio_trabajos,\r\n        pc.fecha_fin_trabajos,\r\n        pc.fecha_parada_turbina,\r\n        pc.fecha_puesta_marcha_turbina,\r\n        pc.observaciones_cierre,\r\n        pc.usuario_cierre,\r\n        pc.fecha_cierre,\r\n        pc.usuario_aprobador_cierre_id,\r\n        pc.usuario_aprobador_cierre_nombre,\r\n        pc.fecha_aprobacion_cierre,\r\n        pc.estado_aprobacion_cierre,\r\n        pc.motivo_rechazo,\r\n        GROUP_CONCAT(DISTINCT pp.personal_nombre || ' (' || pp.personal_empresa || ')') as personal_asignado,\r\n        GROUP_CONCAT(DISTINCT pp.personal_id) as personal_ids\r\n      FROM permisos_trabajo p\r\n      LEFT JOIN permiso_cierre pc ON p.id = pc.permiso_id\r\n      LEFT JOIN permiso_personal pp ON p.id = pp.permiso_id\r\n      GROUP BY p.id\r\n      ORDER BY p.fecha_creacion DESC\r\n      LIMIT 100\r\n    `).all();\r\n    \r\n    const permisos = permisosResult.results || [];\r\n    \r\n    // Para cada permiso, obtener actividades y materiales\r\n    for (let permiso of permisos) {\r\n      // Obtener actividades (usando nombres de columnas correctos seg\u00FAn la estructura real)\r\n      const actividadesResult = await env.DB_PERMISOS.prepare(`\r\n        SELECT actividad_nombre, tipo_actividad\r\n        FROM permiso_actividades\r\n        WHERE permiso_id = ?\r\n      `).bind(permiso.id).all();\r\n      \r\n      permiso.actividades_detalle = actividadesResult.results || [];\r\n      \r\n      // Obtener materiales (usando estructura correcta de la tabla)\r\n      try {\r\n        const materialesResult = await env.DB_PERMISOS.prepare(`\r\n          SELECT descripcion as material_nombre, cantidad as material_cantidad, \r\n                 propietario as material_propietario, almacen as material_almacen,\r\n                 numero_item, numero_serie, observaciones_material\r\n          FROM permiso_materiales\r\n          WHERE permiso_id = ?\r\n          ORDER BY descripcion ASC\r\n        `).bind(permiso.id).all();\r\n        \r\n        permiso.materiales_detalle = materialesResult.results || [];\r\n      } catch (e) {\r\n        console.error('Error cargando materiales para permiso', permiso.id, ':', e);\r\n        permiso.materiales_detalle = [];\r\n      }\r\n      \r\n      // Obtener matriz de riesgos\r\n      try {\r\n        const matrizResult = await env.DB_PERMISOS.prepare(`\r\n          SELECT riesgo_descripcion, medida_control\r\n          FROM permiso_matriz_riesgos\r\n          WHERE permiso_id = ?\r\n        `).bind(permiso.id).all();\r\n        \r\n        permiso.matriz_riesgos_detalle = matrizResult.results || [];\r\n      } catch (e) {\r\n        permiso.matriz_riesgos_detalle = [];\r\n      }\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      permisos: permisos\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error consultando permisos:', error);\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: error.message \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleAprobarPermiso(request, corsHeaders, env, currentUser, services) {\r\n  const { auditLogger } = services;\r\n  \r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const rawData = await request.json();\r\n    const { permisoId, usuarioAprobador } = InputSanitizer.sanitizeObject(rawData);\r\n    \r\n    if (!permisoId || !usuarioAprobador) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Datos requeridos faltantes' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    const result = await env.DB_PERMISOS.prepare(`\r\n      UPDATE permisos_trabajo \r\n      SET \r\n        estado = 'ACTIVO',\r\n        usuario_aprobador = ?,\r\n        usuario_aprobador_apertura_id = ?,\r\n        usuario_aprobador_apertura_nombre = ?,\r\n        fecha_aprobacion = ?\r\n      WHERE id = ? AND estado = 'CREADO'\r\n    `).bind(\r\n      usuarioAprobador,\r\n      currentUser?.sub || 'unknown',\r\n      currentUser?.email || usuarioAprobador,\r\n      formatLocalDateTime(getLocalDateTime()),\r\n      permisoId\r\n    ).run();\r\n    \r\n    if (result.changes === 0) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Permiso no encontrado o ya procesado' \r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'APPROVE_PERMISO',\r\n        resource: 'permisos',\r\n        resourceId: permisoId.toString(),\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || usuarioAprobador,\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: true\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true, \r\n      message: 'Permiso aprobado exitosamente'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error aprobando permiso:', error);\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'APPROVE_PERMISO_FAILED',\r\n        resource: 'permisos',\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || 'unknown',\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: false,\r\n        error: error.message\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: `Error al aprobar el permiso: ${error.message}` \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleCerrarPermiso(request, corsHeaders, env, currentUser, services) {\r\n  const { auditLogger } = services;\r\n  \r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const rawData = await request.json();\r\n    const cierreData = InputSanitizer.sanitizeObject(rawData);\r\n    \r\n    const { \r\n      permisoId, \r\n      usuarioCierre, \r\n      fechaFinTrabajos,\r\n      materiales = []\r\n    } = cierreData;\r\n    \r\n    if (!permisoId || !usuarioCierre || !fechaFinTrabajos) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Datos requeridos faltantes' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Actualizar estado del permiso\r\n    await env.DB_PERMISOS.prepare(`\r\n      UPDATE permisos_trabajo \r\n      SET \r\n        estado = 'CERRADO_PENDIENTE_APROBACION',\r\n        observaciones = ?\r\n      WHERE id = ? AND estado IN ('ACTIVO', 'CIERRE_RECHAZADO')\r\n    `).bind(\r\n      cierreData.observacionesCierre || 'Trabajo completado',\r\n      permisoId\r\n    ).run();\r\n    \r\n    // Verificar si ya existe registro de cierre (para l\u00F3gica UPSERT)\r\n    const existingCierre = await env.DB_PERMISOS.prepare(`\r\n      SELECT id FROM permiso_cierre WHERE permiso_id = ?\r\n    `).bind(permisoId).first();\r\n\r\n    if (existingCierre) {\r\n      // REINTENTO: Actualizar registro existente\r\n      await env.DB_PERMISOS.prepare(`\r\n        UPDATE permiso_cierre SET\r\n          fecha_inicio_trabajos = ?,\r\n          fecha_fin_trabajos = ?,\r\n          fecha_parada_turbina = ?,\r\n          fecha_puesta_marcha_turbina = ?,\r\n          observaciones_cierre = ?,\r\n          usuario_cierre = ?,\r\n          fecha_cierre = ?,\r\n          estado_aprobacion_cierre = 'PENDIENTE',\r\n          updated_at = CURRENT_TIMESTAMP\r\n        WHERE permiso_id = ?\r\n      `).bind(\r\n        cierreData.fechaInicioTrabajos || null,\r\n        fechaFinTrabajos,\r\n        cierreData.fechaParadaTurbina || null,\r\n        cierreData.fechaPuestaMarcha || null,\r\n        cierreData.observacionesCierre || 'Trabajo completado',\r\n        usuarioCierre,\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        permisoId\r\n      ).run();\r\n    } else {\r\n      // PRIMER INTENTO: Insertar nuevo registro de cierre\r\n      await env.DB_PERMISOS.prepare(`\r\n        INSERT INTO permiso_cierre (\r\n          permiso_id, \r\n          fecha_inicio_trabajos, \r\n          fecha_fin_trabajos,\r\n          fecha_parada_turbina,\r\n          fecha_puesta_marcha_turbina,\r\n          observaciones_cierre,\r\n          usuario_cierre,\r\n          fecha_cierre,\r\n          estado_aprobacion_cierre\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n      `).bind(\r\n        permisoId,\r\n        cierreData.fechaInicioTrabajos || null,\r\n        fechaFinTrabajos,\r\n        cierreData.fechaParadaTurbina || null,\r\n        cierreData.fechaPuestaMarcha || null,\r\n        cierreData.observacionesCierre || 'Trabajo completado',\r\n        usuarioCierre,\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        'PENDIENTE'\r\n      ).run();\r\n    }\r\n    \r\n    // Insertar materiales si los hay\r\n    if (materiales && materiales.length > 0) {\r\n      for (const material of materiales) {\r\n        await env.DB_PERMISOS.prepare(`\r\n          INSERT INTO permiso_materiales (\r\n            permiso_id, cantidad, descripcion, propietario,\r\n            almacen, fecha_uso, numero_item, numero_serie,\r\n            observaciones_material, fecha_registro\r\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n          permisoId,\r\n          material.cantidad || 1,\r\n          material.descripcion || 'Material sin descripci\u00F3n',\r\n          material.propietario || 'No especificado',\r\n          material.almacen || 'Central',\r\n          formatLocalDateTime(getLocalDateTime()),\r\n          material.numeroItem || null,\r\n          material.numeroSerie || null,\r\n          material.observaciones || null,\r\n          formatLocalDateTime(getLocalDateTime())\r\n        ).run();\r\n      }\r\n    }\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'CLOSE_PERMISO',\r\n        resource: 'permisos',\r\n        resourceId: permisoId.toString(),\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || usuarioCierre,\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: true,\r\n        metadata: { materialesCount: materiales.length }\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true, \r\n      message: 'Permiso cerrado exitosamente',\r\n      materialesCount: materiales.length\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error cerrando permiso:', error);\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'CLOSE_PERMISO_FAILED',\r\n        resource: 'permisos',\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || 'unknown',\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: false,\r\n        error: error.message\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: `Error al cerrar el permiso: ${error.message}`\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleObtenerDetalleAprobacion(request, corsHeaders, env, currentUser, services) {\r\n  if (request.method !== 'GET') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n\r\n  const { InputSanitizer } = services;\r\n  const url = new URL(request.url);\r\n  const permisoId = url.searchParams.get('id');\r\n\r\n  if (!permisoId) {\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: 'ID del permiso requerido' \r\n    }), {\r\n      status: 400,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Obtener datos completos del permiso para aprobaci\u00F3n\r\n    const permiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT \r\n        p.*,\r\n        pc.fecha_inicio_trabajos,\r\n        pc.fecha_fin_trabajos,\r\n        pc.fecha_parada_turbina,\r\n        pc.fecha_puesta_marcha_turbina,\r\n        pc.observaciones_cierre,\r\n        pc.usuario_cierre,\r\n        pc.fecha_cierre,\r\n        pc.estado_aprobacion_cierre,\r\n        pc.motivo_rechazo,\r\n        GROUP_CONCAT(DISTINCT pp.personal_nombre || ' (' || pp.personal_empresa || ')') as personal_asignado,\r\n        GROUP_CONCAT(DISTINCT pa.actividad_nombre) as actividades_realizadas\r\n      FROM permisos_trabajo p\r\n      LEFT JOIN permiso_cierre pc ON p.id = pc.permiso_id\r\n      LEFT JOIN permiso_personal pp ON p.id = pp.permiso_id\r\n      LEFT JOIN permiso_actividades pa ON p.id = pa.permiso_id\r\n      WHERE p.id = ?\r\n      GROUP BY p.id\r\n    `).bind(permisoId).first();\r\n\r\n    if (!permiso) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Permiso no encontrado' \r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n\r\n    // Obtener materiales utilizados\r\n    const materiales = await env.DB_PERMISOS.prepare(`\r\n      SELECT * FROM permiso_materiales \r\n      WHERE permiso_id = ?\r\n      ORDER BY fecha_registro DESC\r\n    `).bind(permisoId).all();\r\n\r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      permiso: permiso,\r\n      materiales: materiales.results || []\r\n    }), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error obteniendo detalle para aprobaci\u00F3n:', error);\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: 'Error al obtener detalles del permiso' \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleAprobarCierrePermiso(request, corsHeaders, env, currentUser, services) {\r\n  const { InputSanitizer, auditLogger } = services;\r\n  \r\n  // Verificar que el usuario tenga permisos de aprobaci\u00F3n\r\n  const userRole = currentUser?.rol || 'user';\r\n  if (!['Admin', 'Supervisor'].includes(userRole)) {\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: 'No tienes permisos para aprobar cierres' \r\n    }), {\r\n      status: 403,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const rawData = await request.json();\r\n    const { permisoId, observaciones, accion } = InputSanitizer.sanitizeObject(rawData);\r\n    \r\n    if (!permisoId || !accion) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'ID del permiso y acci\u00F3n requeridos' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Verificar que el permiso existe y est\u00E1 cerrado pendiente de aprobaci\u00F3n\r\n    const permiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT p.id, p.estado, pc.id as cierre_id, pc.estado_aprobacion_cierre\r\n      FROM permisos_trabajo p\r\n      LEFT JOIN permiso_cierre pc ON p.id = pc.permiso_id\r\n      WHERE p.id = ?\r\n    `).bind(permisoId).first();\r\n    \r\n    if (!permiso || !permiso.cierre_id) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Permiso no encontrado o no est\u00E1 cerrado' \r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    if (permiso.estado_aprobacion_cierre === 'APROBADO') {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'El cierre ya fue aprobado' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    if (accion === 'aprobar') {\r\n      // Aprobar el cierre\r\n      await env.DB_PERMISOS.prepare(`\r\n        UPDATE permiso_cierre \r\n        SET \r\n          usuario_aprobador_cierre_id = ?,\r\n          usuario_aprobador_cierre_nombre = ?,\r\n          fecha_aprobacion_cierre = ?,\r\n          estado_aprobacion_cierre = 'APROBADO',\r\n          observaciones_aprobacion = ?,\r\n          updated_at = ?\r\n        WHERE permiso_id = ?\r\n      `).bind(\r\n        currentUser?.sub || 'unknown',\r\n        currentUser?.email || currentUser?.name || 'Sistema',\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        observaciones || null,\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        permisoId\r\n      ).run();\r\n      \r\n      // Cambiar estado del permiso a CERRADO final\r\n      await env.DB_PERMISOS.prepare(`\r\n        UPDATE permisos_trabajo \r\n        SET estado = 'CERRADO'\r\n        WHERE id = ?\r\n      `).bind(permisoId).run();\r\n      \r\n    } else if (accion === 'rechazar') {\r\n      // Rechazar el cierre\r\n      await env.DB_PERMISOS.prepare(`\r\n        UPDATE permiso_cierre \r\n        SET \r\n          usuario_aprobador_cierre_id = ?,\r\n          usuario_aprobador_cierre_nombre = ?,\r\n          fecha_rechazo = ?,\r\n          estado_aprobacion_cierre = 'RECHAZADO',\r\n          motivo_rechazo = ?,\r\n          updated_at = ?\r\n        WHERE permiso_id = ?\r\n      `).bind(\r\n        currentUser?.sub || 'unknown',\r\n        currentUser?.email || currentUser?.name || 'Sistema',\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        observaciones || null,\r\n        formatLocalDateTime(getLocalDateTime()),\r\n        permisoId\r\n      ).run();\r\n      \r\n      // Cambiar estado del permiso a CIERRE_RECHAZADO\r\n      await env.DB_PERMISOS.prepare(`\r\n        UPDATE permisos_trabajo \r\n        SET estado = 'CIERRE_RECHAZADO'\r\n        WHERE id = ?\r\n      `).bind(permisoId).run();\r\n      \r\n    } else {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Acci\u00F3n no v\u00E1lida' \r\n      }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Registrar en auditor\u00EDa\r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'APPROVE_CIERRE_PERMISO',\r\n        resource: 'permisos',\r\n        resourceId: permisoId.toString(),\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || 'unknown',\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        details: { observaciones },\r\n        success: true\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true,\r\n      message: accion === 'aprobar' ? 'Cierre aprobado exitosamente' : 'Cierre rechazado, permiso marcado como cierre rechazado'\r\n    }), {\r\n      status: 200,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error aprobando cierre:', error);\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'APPROVE_CIERRE_PERMISO_FAILED',\r\n        resource: 'permisos',\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email || 'unknown',\r\n        ip: request.headers.get('CF-Connecting-IP'),\r\n        success: false,\r\n        error: error.message\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: `Error al aprobar cierre: ${error.message}`\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleGenerateRegister(request, corsHeaders, env) {\r\n  if (request.method !== 'POST') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  const rawData = await request.json();\r\n  const data = InputSanitizer.sanitizeObject(rawData);\r\n  const htmlContent = generateTomaConocimientoPDF(data);\r\n  \r\n  return new Response(htmlContent, {\r\n    headers: {\r\n      'Content-Type': 'text/html; charset=utf-8',\r\n      'Content-Disposition': `inline; filename=\"TomaConocimiento_${data.planta}_${formatLocalDateTime(getLocalDateTime()).split(' ')[0].replace(/-/g, '')}.html\"`,\r\n      ...corsHeaders\r\n    }\r\n  });\r\n}\r\n\r\nexport async function handleHealth(request, corsHeaders, env) {\r\n  try {\r\n    const checks = {\r\n      db_master: false,\r\n      db_hseq: false,\r\n      db_permisos: false\r\n    };\r\n    \r\n    // Check DB_MASTER\r\n    if (env.DB_MASTER) {\r\n      try {\r\n        const test = await env.DB_MASTER.prepare('SELECT COUNT(*) as count FROM usuarios').first();\r\n        checks.db_master = true;\r\n        checks.usuarios_count = test?.count || 0;\r\n      } catch (error) {\r\n        checks.db_master_error = error.message;\r\n      }\r\n    }\r\n    \r\n    // Check DB_HSEQ\r\n    if (env.DB_HSEQ) {\r\n      try {\r\n        const test = await env.DB_HSEQ.prepare('SELECT COUNT(*) as count FROM matriz_riesgos').first();\r\n        checks.db_hseq = true;\r\n        checks.matriz_count = test?.count || 0;\r\n      } catch (error) {\r\n        checks.db_hseq_error = error.message;\r\n      }\r\n    }\r\n    \r\n    // Check DB_PERMISOS\r\n    if (env.DB_PERMISOS) {\r\n      try {\r\n        const test = await env.DB_PERMISOS.prepare('SELECT COUNT(*) as count FROM permisos_trabajo').first();\r\n        checks.db_permisos = true;\r\n        checks.permisos_count = test?.count || 0;\r\n      } catch (error) {\r\n        checks.db_permisos_error = error.message;\r\n      }\r\n    }\r\n    \r\n    return new Response(JSON.stringify({\r\n      status: 'OK',\r\n      databases: checks,\r\n      localTime: formatLocalDateTime(getLocalDateTime()),\r\n      message: 'Sistema operativo con D1 Database'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({\r\n      status: 'ERROR',\r\n      error: error.message,\r\n      timestamp: formatLocalDateTime(getLocalDateTime())\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\n// Funci\u00F3n para manejar la actualizaci\u00F3n de permisos\r\nasync function handleUpdatePermiso(permisoData, env, currentUser, services, corsHeaders) {\r\n  const { auditLogger } = services;\r\n  \r\n  console.log('BACKEND - Recibiendo edici\u00F3n permiso, ID:', permisoData.permisoId, 'Datos:', JSON.stringify(permisoData, null, 2));\r\n  \r\n  if (!permisoData.permisoId) {\r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: 'ID del permiso requerido para actualizaci\u00F3n'\r\n    }), {\r\n      status: 400,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n\r\n  try {\r\n    // Verificar que el permiso existe y est\u00E1 en estado CREADO\r\n    const existingPermiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT * FROM permisos_trabajo WHERE id = ? AND estado = 'CREADO'\r\n    `).bind(permisoData.permisoId).first();\r\n\r\n    if (!existingPermiso) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Permiso no encontrado o no se puede editar (debe estar en estado CREADO)'\r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n\r\n    // Verificar que el usuario actual es el creador\r\n    const esCreador = parseInt(currentUser.id) === parseInt(existingPermiso.usuario_creador_id);\r\n    const esEnel = currentUser.esEnel || currentUser.rol === 'Supervisor Enel';\r\n    \r\n    if (!esCreador && !esEnel) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Solo el creador del permiso puede editarlo'\r\n      }), {\r\n        status: 403,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n\r\n    // Actualizar el permiso principal\r\n    await env.DB_PERMISOS.prepare(`\r\n      UPDATE permisos_trabajo SET \r\n        planta_id = ?, planta_nombre = ?, aerogenerador_id = ?, \r\n        aerogenerador_nombre = ?, descripcion = ?, jefe_faena_id = ?, \r\n        jefe_faena_nombre = ?, supervisor_parque_id = ?, supervisor_parque_nombre = ?, \r\n        tipo_mantenimiento = ?, tipo_mantenimiento_otros = ?,\r\n        updated_at = ?\r\n      WHERE id = ?\r\n    `).bind(\r\n      permisoData.plantaId || 'unknown',\r\n      permisoData.planta,\r\n      permisoData.aerogeneradorCodigo || null,\r\n      permisoData.aerogenerador || null,\r\n      permisoData.descripcion,\r\n      permisoData.jefeFaenaId || 'unknown',\r\n      permisoData.jefeFaena,\r\n      permisoData.supervisorParqueId || null,\r\n      permisoData.supervisorParque || null,\r\n      permisoData.tipoMantenimiento || 'PREVENTIVO',\r\n      permisoData.tipoMantenimientoOtros || null,\r\n      formatLocalDateTime(getLocalDateTime()),\r\n      permisoData.permisoId\r\n    ).run();\r\n\r\n    // Eliminar registros existentes relacionados\r\n    await env.DB_PERMISOS.prepare(`DELETE FROM permiso_personal WHERE permiso_id = ?`).bind(permisoData.permisoId).run();\r\n    await env.DB_PERMISOS.prepare(`DELETE FROM permiso_actividades WHERE permiso_id = ?`).bind(permisoData.permisoId).run();\r\n    await env.DB_PERMISOS.prepare(`DELETE FROM permiso_matriz_riesgos WHERE permiso_id = ?`).bind(permisoData.permisoId).run();\r\n\r\n    // Re-insertar personal actualizado\r\n    if (permisoData.personal && permisoData.personal.length > 0) {\r\n      for (const persona of permisoData.personal) {\r\n        await env.DB_PERMISOS.prepare(`\r\n          INSERT INTO permiso_personal (\r\n            permiso_id, personal_id, personal_nombre, \r\n            personal_empresa, personal_rol, created_at\r\n          ) VALUES (?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n          permisoData.permisoId, \r\n          parseInt(persona.id),\r\n          persona.nombre || 'Sin nombre', \r\n          persona.empresa || 'Sin empresa', \r\n          persona.rol || 'Sin rol',\r\n          formatLocalDateTime(getLocalDateTime())\r\n        ).run();\r\n      }\r\n    }\r\n\r\n    // Re-insertar actividades actualizadas\r\n    if (permisoData.actividades && permisoData.actividades.length > 0) {\r\n      for (const actividad of permisoData.actividades) {\r\n        await env.DB_PERMISOS.prepare(`\r\n          INSERT INTO permiso_actividades (\r\n            permiso_id, actividad_id, actividad_nombre, \r\n            tipo_actividad, created_at\r\n          ) VALUES (?, ?, ?, ?, ?)\r\n        `).bind(\r\n          permisoData.permisoId, \r\n          actividad.id || 'unknown', \r\n          actividad.nombre || 'Sin nombre', \r\n          actividad.tipo || 'RUTINARIA',\r\n          formatLocalDateTime(getLocalDateTime())\r\n        ).run();\r\n      }\r\n    }\r\n\r\n    // Re-insertar matriz de riesgos actualizada\r\n    if (permisoData.matrizRiesgos && permisoData.matrizRiesgos.length > 0) {\r\n      for (const riesgo of permisoData.matrizRiesgos) {\r\n        await env.DB_PERMISOS.prepare(`\r\n          INSERT INTO permiso_matriz_riesgos (\r\n            permiso_id, actividad, peligro, riesgo, \r\n            medidas_preventivas, codigo_matriz, created_at\r\n          ) VALUES (?, ?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n          permisoData.permisoId, \r\n          riesgo.actividad || 'Sin actividad', \r\n          riesgo.peligro || 'Sin peligro', \r\n          riesgo.riesgo || 'Sin riesgo', \r\n          riesgo.medidas || 'Sin medidas', \r\n          riesgo.codigo || null,\r\n          formatLocalDateTime(getLocalDateTime())\r\n        ).run();\r\n      }\r\n    }\r\n\r\n    // Log auditor\u00EDa\r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'UPDATE_PERMISO',\r\n        resource: 'permisos',\r\n        resourceId: permisoData.permisoId.toString(),\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email,\r\n        ip: null,\r\n        success: true,\r\n        metadata: { numeroPT: existingPermiso.numero_pt, planta: permisoData.planta }\r\n      });\r\n    }\r\n\r\n    return new Response(JSON.stringify({ \r\n      success: true, \r\n      id: permisoData.permisoId, \r\n      numeroPT: existingPermiso.numero_pt,\r\n      message: 'Permiso actualizado exitosamente'\r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error actualizando permiso:', error);\r\n    \r\n    if (auditLogger) {\r\n      await auditLogger.log({\r\n        action: 'UPDATE_PERMISO_FAILED',\r\n        resource: 'permisos',\r\n        resourceId: permisoData.permisoId?.toString(),\r\n        userId: currentUser?.sub || 'anonymous',\r\n        userEmail: currentUser?.email,\r\n        ip: null,\r\n        success: false,\r\n        error: error.message\r\n      });\r\n    }\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: false, \r\n      error: `Error al actualizar el permiso: ${error.message}`\r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handlePermisoDetalle(request, corsHeaders, env, currentUser, services) {\r\n  if (request.method !== 'GET') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  // Verificar que el usuario est\u00E9 autenticado\r\n  if (!currentUser || !currentUser.sub) {\r\n    return new Response(JSON.stringify({ error: 'Usuario no autorizado' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const url = new URL(request.url);\r\n    const permisoId = url.searchParams.get('id');\r\n    \r\n    if (!permisoId) {\r\n      return new Response(JSON.stringify({ error: 'ID del permiso requerido' }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener datos completos del permiso\r\n    const permiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT * FROM permisos_trabajo WHERE id = ?\r\n    `).bind(permisoId).first();\r\n    \r\n    if (!permiso) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'Permiso no encontrado' \r\n      }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Verificar que el usuario actual sea el creador o tenga permisos\r\n    const esCreador = parseInt(currentUser.id) === parseInt(permiso.usuario_creador_id);\r\n    const esEnel = currentUser.esEnel || currentUser.rol === 'Supervisor Enel';\r\n    \r\n    if (!esCreador && !esEnel) {\r\n      return new Response(JSON.stringify({ \r\n        success: false, \r\n        error: 'No tienes permisos para ver este permiso' \r\n      }), {\r\n        status: 403,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener actividades del permiso\r\n    const actividadesResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT actividad_id FROM permiso_actividades WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    const actividades_ids = (actividadesResult.results || []).map(a => a.actividad_id).join(',');\r\n    \r\n    // Obtener personal del permiso\r\n    const personalResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT personal_id FROM permiso_personal WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    const personal_ids = (personalResult.results || []).map(p => p.personal_id).join(',');\r\n    \r\n    // Agregar los IDs al objeto permiso\r\n    permiso.actividades_ids = actividades_ids;\r\n    permiso.personal_ids = personal_ids;\r\n    \r\n    return new Response(JSON.stringify({ \r\n      success: true, \r\n      permiso: permiso \r\n    }), {\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error obteniendo detalle permiso:', error);\r\n    return new Response(JSON.stringify({ \r\n      success: false,\r\n      error: 'Error interno del servidor' \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleExportarPermisoExcel(request, corsHeaders, env, currentUser, services) {\r\n  if (request.method !== 'GET') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  // Verificar que el usuario est\u00E9 autenticado\r\n  if (!currentUser || !currentUser.sub) {\r\n    return new Response(JSON.stringify({ error: 'Usuario no autorizado' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const url = new URL(request.url);\r\n    const permisoId = url.searchParams.get('id');\r\n    \r\n    if (!permisoId) {\r\n      return new Response(JSON.stringify({ error: 'ID del permiso requerido' }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener datos completos del permiso\r\n    const permiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT \r\n        p.*,\r\n        pc.fecha_inicio_trabajos,\r\n        pc.fecha_fin_trabajos,\r\n        pc.fecha_parada_turbina,\r\n        pc.fecha_puesta_marcha_turbina,\r\n        pc.observaciones_cierre,\r\n        pc.usuario_cierre,\r\n        pc.fecha_cierre,\r\n        pc.usuario_aprobador_cierre_id,\r\n        pc.usuario_aprobador_cierre_nombre,\r\n        pc.fecha_aprobacion_cierre,\r\n        pc.estado_aprobacion_cierre\r\n      FROM permisos_trabajo p\r\n      LEFT JOIN permiso_cierre pc ON p.id = pc.permiso_id\r\n      WHERE p.id = ?\r\n    `).bind(permisoId).first();\r\n    \r\n    if (!permiso) {\r\n      return new Response(JSON.stringify({ error: 'Permiso no encontrado' }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener personal\r\n    const personalResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT personal_nombre, personal_empresa, personal_rol\r\n      FROM permiso_personal\r\n      WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    // Obtener actividades\r\n    const actividadesResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT actividad_nombre, tipo_actividad\r\n      FROM permiso_actividades\r\n      WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    // Obtener materiales\r\n    const materialesResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT descripcion, cantidad, propietario, almacen, numero_item, numero_serie\r\n      FROM permiso_materiales\r\n      WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    // Obtener matriz de riesgos\r\n    const riesgosResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT actividad, peligro, riesgo, medidas_preventivas, codigo_matriz\r\n      FROM permiso_matriz_riesgos\r\n      WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    // Generar CSV con formato UTF-8 BOM para Excel\r\n    const BOM = '\\uFEFF';\r\n    let csvContent = BOM;\r\n    \r\n    // Secci\u00F3n: Informaci\u00F3n General\r\n    csvContent += '=== INFORMACI\u00D3N GENERAL ===\\n';\r\n    csvContent += 'Campo,Valor\\n';\r\n    csvContent += `\"N\u00FAmero PT\",\"${permiso.numero_pt || ''}\"\\n`;\r\n    csvContent += `\"Planta\",\"${permiso.planta_nombre || ''}\"\\n`;\r\n    csvContent += `\"Aerogenerador\",\"${permiso.aerogenerador_nombre || ''}\"\\n`;\r\n    csvContent += `\"Estado\",\"${permiso.estado || ''}\"\\n`;\r\n    csvContent += `\"Fecha Creaci\u00F3n\",\"${permiso.fecha_creacion || ''}\"\\n`;\r\n    csvContent += `\"Jefe de Faena\",\"${permiso.jefe_faena_nombre || ''}\"\\n`;\r\n    csvContent += `\"Supervisor Parque\",\"${permiso.supervisor_parque_nombre || ''}\"\\n`;\r\n    csvContent += `\"Tipo Mantenimiento\",\"${permiso.tipo_mantenimiento || ''}\"\\n`;\r\n    csvContent += `\"Descripci\u00F3n\",\"${(permiso.descripcion || '').replace(/\"/g, '\"\"')}\"\\n`;\r\n    csvContent += `\"Observaciones de Cierre\",\"${(permiso.observaciones_cierre || '').replace(/\"/g, '\"\"')}\"\\n`;\r\n    csvContent += `\"Usuario Cierre\",\"${permiso.usuario_cierre || ''}\"\\n`;\r\n    csvContent += `\"Fecha Cierre\",\"${permiso.fecha_cierre || ''}\"\\n`;\r\n    csvContent += `\"Aprobador Apertura\",\"${permiso.usuario_aprobador_apertura_nombre || permiso.usuario_aprobador || ''}\"\r\n`;\r\n    csvContent += `\"Fecha Aprobaci\u00F3n Apertura\",\"${permiso.fecha_aprobacion || ''}\"\r\n`;\r\n    csvContent += `\"Aprobador Cierre\",\"${permiso.usuario_aprobador_cierre_nombre || ''}\"\r\n`;\r\n    csvContent += `\"Fecha Aprobaci\u00F3n Cierre\",\"${permiso.fecha_aprobacion_cierre || ''}\"\r\n`;\r\n    csvContent += `\"Estado Aprobaci\u00F3n Cierre\",\"${permiso.estado_aprobacion_cierre || 'PENDIENTE'}\"\r\n`;\r\n    csvContent += '\\n';\r\n    \r\n    // Secci\u00F3n: Tiempos (con horarios formato Chile)\r\n    csvContent += '=== TIEMPOS ===\\n';\r\n    csvContent += 'Evento,Fecha/Hora (Hora Chile)\\n';\r\n    csvContent += `\"Creaci\u00F3n Permiso\",\"${permiso.fecha_creacion || ''}\"\r\n`;\r\n    csvContent += `\"Aprobaci\u00F3n Apertura\",\"${permiso.fecha_aprobacion || ''}\"\r\n`;\r\n    csvContent += `\"Inicio Trabajos\",\"${permiso.fecha_inicio_trabajos || ''}\"\\n`;\r\n    csvContent += `\"Fin Trabajos\",\"${permiso.fecha_fin_trabajos || ''}\"\\n`;\r\n    csvContent += `\"Parada Turbina\",\"${permiso.fecha_parada_turbina || ''}\"\\n`;\r\n    csvContent += `\"Puesta en Marcha\",\"${permiso.fecha_puesta_marcha_turbina || ''}\"\\n`;\r\n    csvContent += `\"Cierre Permiso\",\"${permiso.fecha_cierre || ''}\"\\n`;\r\n    csvContent += `\"Aprobaci\u00F3n Cierre\",\"${permiso.fecha_aprobacion_cierre || ''}\"\\n`;\r\n    csvContent += '\\n';\r\n    \r\n    // Secci\u00F3n: Personal Asignado\r\n    csvContent += '=== PERSONAL ASIGNADO ===\\n';\r\n    csvContent += 'Nombre,Empresa,Rol\\n';\r\n    (personalResult.results || []).forEach(p => {\r\n      csvContent += `\"${p.personal_nombre}\",\"${p.personal_empresa}\",\"${p.personal_rol}\"\\n`;\r\n    });\r\n    csvContent += '\\n';\r\n    \r\n    // Secci\u00F3n: Actividades\r\n    csvContent += '=== ACTIVIDADES ===\\n';\r\n    csvContent += 'Actividad,Tipo\\n';\r\n    (actividadesResult.results || []).forEach(a => {\r\n      csvContent += `\"${a.actividad_nombre}\",\"${a.tipo_actividad}\"\\n`;\r\n    });\r\n    csvContent += '\\n';\r\n    \r\n    // Secci\u00F3n: Materiales\r\n    csvContent += '=== MATERIALES ===\\n';\r\n    csvContent += 'Descripci\u00F3n,Cantidad,Propietario,Almac\u00E9n,N\u00B0 Item,N\u00B0 Serie\\n';\r\n    (materialesResult.results || []).forEach(m => {\r\n      csvContent += `\"${m.descripcion}\",\"${m.cantidad}\",\"${m.propietario}\",\"${m.almacen}\",\"${m.numero_item || ''}\",\"${m.numero_serie || ''}\"\\n`;\r\n    });\r\n    csvContent += '\\n';\r\n    \r\n    // Secci\u00F3n: Matriz de Riesgos\r\n    csvContent += '=== MATRIZ DE RIESGOS ===\\n';\r\n    csvContent += 'Actividad,Peligro,Riesgo,Medidas Preventivas,C\u00F3digo Matriz\\n';\r\n    (riesgosResult.results || []).forEach(r => {\r\n      csvContent += `\"${(r.actividad || '').replace(/\"/g, '\"\"')}\",\"${(r.peligro || '').replace(/\"/g, '\"\"')}\",\"${(r.riesgo || '').replace(/\"/g, '\"\"')}\",\"${(r.medidas_preventivas || '').replace(/\"/g, '\"\"')}\",\"${r.codigo_matriz || ''}\"\\n`;\r\n    });\r\n    \r\n    // Generar nombre de archivo con formato solicitado\r\n    const fechaActual = new Date().toISOString().split('T')[0].replace(/-/g, '');\r\n    const filename = `${permiso.numero_pt}_${fechaActual}.csv`;\r\n    \r\n    return new Response(csvContent, {\r\n      headers: {\r\n        'Content-Type': 'text/csv; charset=utf-8',\r\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\r\n        ...corsHeaders\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error exportando Excel:', error);\r\n    return new Response(JSON.stringify({ error: error.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport async function handleExportarPermisoPdf(request, corsHeaders, env, currentUser, services) {\r\n  if (request.method !== 'GET') {\r\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\r\n      status: 405,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  // Verificar que el usuario est\u00E9 autenticado\r\n  if (!currentUser || !currentUser.sub) {\r\n    return new Response(JSON.stringify({ error: 'Usuario no autorizado' }), {\r\n      status: 401,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n  \r\n  try {\r\n    const url = new URL(request.url);\r\n    const permisoId = url.searchParams.get('id');\r\n    \r\n    if (!permisoId) {\r\n      return new Response(JSON.stringify({ error: 'ID del permiso requerido' }), {\r\n        status: 400,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener datos completos del permiso\r\n    const permiso = await env.DB_PERMISOS.prepare(`\r\n      SELECT \r\n        p.*,\r\n        pc.fecha_inicio_trabajos,\r\n        pc.fecha_fin_trabajos,\r\n        pc.fecha_parada_turbina,\r\n        pc.fecha_puesta_marcha_turbina,\r\n        pc.observaciones_cierre,\r\n        pc.usuario_cierre,\r\n        pc.fecha_cierre,\r\n        pc.usuario_aprobador_cierre_id,\r\n        pc.usuario_aprobador_cierre_nombre,\r\n        pc.fecha_aprobacion_cierre,\r\n        pc.estado_aprobacion_cierre\r\n      FROM permisos_trabajo p\r\n      LEFT JOIN permiso_cierre pc ON p.id = pc.permiso_id\r\n      WHERE p.id = ?\r\n    `).bind(permisoId).first();\r\n    \r\n    if (!permiso) {\r\n      return new Response(JSON.stringify({ error: 'Permiso no encontrado' }), {\r\n        status: 404,\r\n        headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n      });\r\n    }\r\n    \r\n    // Obtener datos relacionados\r\n    const personalResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT personal_nombre, personal_empresa, personal_rol\r\n      FROM permiso_personal WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    const actividadesResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT actividad_nombre, tipo_actividad\r\n      FROM permiso_actividades WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    const materialesResult = await env.DB_PERMISOS.prepare(`\r\n      SELECT descripcion, cantidad, propietario, almacen\r\n      FROM permiso_materiales WHERE permiso_id = ?\r\n    `).bind(permisoId).all();\r\n    \r\n    // Obtener matriz de riesgos completa para las actividades del permiso\r\n    let matrizRiesgosCompleta = [];\r\n    if (actividadesResult.results && actividadesResult.results.length > 0) {\r\n      const actividades = actividadesResult.results.map(a => a.actividad_nombre);\r\n      const placeholders = actividades.map(() => '?').join(',');\r\n      const matrizResult = await env.DB_HSEQ.prepare(`\r\n        SELECT codigo, actividad, peligro, riesgo, medidas_preventivas\r\n        FROM matriz_riesgos \r\n        WHERE estado = 'Activo' AND actividad IN (${placeholders})\r\n        ORDER BY actividad ASC, codigo ASC\r\n      `).bind(...actividades).all();\r\n      matrizRiesgosCompleta = matrizResult.results || [];\r\n    }\r\n    \r\n    // Generar HTML para PDF\r\n    const htmlContent = `\r\n<!DOCTYPE html>\r\n<html lang=\"es\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Permiso de Trabajo ${permiso.numero_pt} - Exportaci\u00F3n</title>\r\n    <style>\r\n        @media print {\r\n            @page {\r\n                margin: 0.5in;\r\n                size: A4;\r\n            }\r\n            body {\r\n                margin: 0;\r\n                padding: 0;\r\n            }\r\n            .print-button {\r\n                display: none !important;\r\n            }\r\n        }\r\n        \r\n        * { \r\n            margin: 0; \r\n            padding: 0; \r\n            box-sizing: border-box; \r\n        }\r\n        \r\n        body { \r\n            font-family: Arial, sans-serif; \r\n            font-size: 11px; \r\n            line-height: 1.4; \r\n            color: #333; \r\n            margin: 0;\r\n            padding: 20px;\r\n            background: white;\r\n        }\r\n        \r\n        .header { \r\n            display: flex;\r\n            align-items: center;\r\n            margin-bottom: 20px;\r\n            border-bottom: 2px solid #000;\r\n            padding-bottom: 10px;\r\n        }\r\n        \r\n        .logo {\r\n            width: 120px;\r\n            height: 80px;\r\n            margin-right: 20px;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n        }\r\n        \r\n        .logo img {\r\n            max-width: 100%;\r\n            max-height: 100%;\r\n            object-fit: contain;\r\n        }\r\n        \r\n        .header-info {\r\n            flex: 1;\r\n        }\r\n        \r\n        .title { \r\n            color: #0066cc; \r\n            font-size: 18px; \r\n            font-weight: bold;\r\n            text-align: center;\r\n            margin-bottom: 5px;\r\n        }\r\n        \r\n        .subtitle { \r\n            color: #666; \r\n            font-size: 14px; \r\n            margin-top: 5px;\r\n            text-align: center;\r\n        }\r\n        \r\n        .section { \r\n            margin-bottom: 25px; \r\n        }\r\n        \r\n        .section-title { \r\n            background: #4CAF50; \r\n            color: white; \r\n            padding: 8px 12px; \r\n            font-weight: bold; \r\n            margin-bottom: 10px; \r\n        }\r\n        \r\n        .info-grid { \r\n            display: grid; \r\n            grid-template-columns: 1fr 1fr; \r\n            gap: 20px; \r\n        }\r\n        \r\n        .info-item { \r\n            margin-bottom: 8px; \r\n        }\r\n        \r\n        .info-label { \r\n            font-weight: bold; \r\n            color: #0066cc; \r\n        }\r\n        \r\n        .info-value { \r\n            margin-left: 10px; \r\n        }\r\n        \r\n        .table { \r\n            width: 100%; \r\n            border-collapse: collapse; \r\n            margin-top: 10px; \r\n        }\r\n        \r\n        .table th { \r\n            background: #4CAF50; \r\n            color: white;\r\n            padding: 8px; \r\n            border: 1px solid #000; \r\n            font-weight: bold;\r\n            text-align: center;\r\n            font-size: 10px;\r\n        }\r\n        \r\n        .table td { \r\n            padding: 8px; \r\n            border: 1px solid #000; \r\n        }\r\n        \r\n        .footer { \r\n            margin-top: 40px; \r\n            text-align: center; \r\n            font-size: 10px; \r\n            color: #666;\r\n            border-top: 1px solid #ccc;\r\n            padding-top: 10px;\r\n        }\r\n        \r\n        .print-button {\r\n            position: fixed;\r\n            top: 20px;\r\n            right: 20px;\r\n            background: #4CAF50;\r\n            color: white;\r\n            border: none;\r\n            padding: 10px 20px;\r\n            border-radius: 5px;\r\n            cursor: pointer;\r\n            font-size: 14px;\r\n            z-index: 1000;\r\n        }\r\n        \r\n        .print-button:hover {\r\n            background: #45a049;\r\n        }\r\n        \r\n        .description-content {\r\n            border: 1px solid #000;\r\n            padding: 10px;\r\n            min-height: 40px;\r\n            background: #f9f9f9;\r\n            margin-top: 5px;\r\n        }\r\n        \r\n        .observaciones-box {\r\n            padding: 15px;\r\n            background: #f9f9f9;\r\n            border: 1px solid #ddd;\r\n            margin-top: 10px;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <button class=\"print-button\" onclick=\"window.print()\">\uD83D\uDDA8\uFE0F Imprimir PDF</button>\r\n    \r\n    <div class=\"header\">\r\n        <div class=\"logo\">\r\n            <!-- AQU\u00CD VA EL LOGO SVG DE ENEL -->\r\n            <!-- Copiar el mismo src=\"data:image/svg+xml;base64,...\" del archivo generateTomaConocimientoPDF -->\r\n            <img src=\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDIzLjAuMSwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiIFsKCTwhRU5USVRZIG5zX2V4dGVuZCAiaHR0cDovL25zLmFkb2JlLmNvbS9FeHRlbnNpYmlsaXR5LzEuMC8iPgoJPCFFTlRJVFkgbnNfYWkgImh0dHA6Ly9ucy5hZG9iZS5jb20vQWRvYmVJbGx1c3RyYXRvci8xMC4wLyI+Cgk8IUVOVElUWSBuc19ncmFwaHMgImh0dHA6Ly9ucy5hZG9iZS5jb20vR3JhcGhzLzEuMC8iPgoJPCFFTlRJVFkgbnNfdmFycyAiaHR0cDovL25zLmFkb2JlLmNvbS9WYXJpYWJsZXMvMS4wLyI+Cgk8IUVOVElUWSBuc19pbXJlcCAiaHR0cDovL25zLmFkb2JlLmNvbS9JbWFnZVJlcGxhY2VtZW50LzEuMC8iPgoJPCFFTlRJVFkgbnNfc2Z3ICJodHRwOi8vbnMuYWRvYmUuY29tL1NhdmVGb3JXZWIvMS4wLyI+Cgk8IUVOVElUWSBuc19jdXN0b20gImh0dHA6Ly9ucy5hZG9iZS5jb20vR2VuZXJpY0N1c3RvbU5hbWVzcGFjZS8xLjAvIj4KCTwhRU5USVRZIG5zX2Fkb2JlX3hwYXRoICJodHRwOi8vbnMuYWRvYmUuY29tL1hQYXRoLzEuMC8iPgpdPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IkVHUF9Mb2dvX1ByaW1hcnlfUkdCIiB4bWxuczp4PSImbnNfZXh0ZW5kOyIgeG1sbnM6aT0iJm5zX2FpOyIgeG1sbnM6Z3JhcGg9IiZuc19ncmFwaHM7IgoJIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMjgzLjUgMTQyLjEiCgkgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjgzLjUgMTQyLjEiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8bWV0YWRhdGE+Cgk8c2Z3ICB4bWxucz0iJm5zX3NmdzsiPgoJCTxzbGljZXM+PC9zbGljZXM+CgkJPHNsaWNlU291cmNlQm91bmRzICBib3R0b21MZWZ0T3JpZ2luPSJ0cnVlIiBoZWlnaHQ9IjE0Mi4xIiB3aWR0aD0iMjgzLjUiIHg9IjI2OTQuNiIgeT0iLTQxMzkuNSI+PC9zbGljZVNvdXJjZUJvdW5kcz4KCTwvc2Z3Pgo8L21ldGFkYXRhPgo8Zz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMjY2Ljg2MiIgeTE9IjQxLjI5NjkiIHgyPSIyNjYuODYyIiB5Mj0iNzYuNDU5NCI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM3M0I5NjQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cmVjdCB4PSIyNjEiIHk9IjQxIiBmaWxsPSJ1cmwoI1NWR0lEXzFfKSIgd2lkdGg9IjExLjciIGhlaWdodD0iMzUuNCIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8yXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyNzEuMjU5OCIgeTE9Ijg2LjgzNzUiIHgyPSIyODEuOTk0NiIgeTI9Ijk1LjY4OSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzczQjk2NCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM3M0I5NjQ7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzJfKSIgZD0iTTI3Mi43LDc2LjNjMCw4LjUsMy45LDEyLjEsMTAuNywxNi44bC02LjcsOS42Yy0xMC02LjYtMTUuOC0xNC0xNS44LTI2LjRIMjcyLjd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzNfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjEwMS41MDY1IiB5MT0iNDEuNDQ0MSIgeDI9IjEyOC40Nzc4IiB5Mj0iNDEuNDQ0MSI+CgkJPHN0b3AgIG9mZnNldD0iNC43MDIyNDFlLTAzIiBzdHlsZT0ic3RvcC1jb2xvcjojMDA4QzVBIi8+CgkJPHN0b3AgIG9mZnNldD0iMC45OTU3IiBzdHlsZT0ic3RvcC1jb2xvcjojMzJBOTU5Ii8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8zXykiIGQ9Ik0xMjcuNiwyNC4yYy0xMC4yLDAtMTkuNCw0LjEtMjYuMSwxMC43djIzLjhjMS44LTkuNCwxMC4xLTIyLjgsMjYuMS0yMi44YzAuMywwLDAuNiwwLDAuOSwwVjI0LjIKCQlDMTI4LjIsMjQuMiwxMjcuOSwyNC4yLDEyNy42LDI0LjJ6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzRfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE0NC4wNjczIiB5MT0iMzguMzY2IiB4Mj0iMTQ0LjA2NzMiIHkyPSI1OS4xMTYxIj4KCQk8c3RvcCAgb2Zmc2V0PSIxLjExMDQ1NmUtMDIiIHN0eWxlPSJzdG9wLWNvbG9yOiMzMkE5NTkiLz4KCQk8c3RvcCAgb2Zmc2V0PSIwLjE3MDEiIHN0eWxlPSJzdG9wLWNvbG9yOiM0MUIyNTkiLz4KCQk8c3RvcCAgb2Zmc2V0PSIwLjMzMyIgc3R5bGU9InN0b3AtY29sb3I6IzU1QkU1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM1NUJFNUE7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzRfKSIgZD0iTTE2MC4yLDYwLjVoLTExLjdsMC0zLjljMC0xMS42LTkuMi0yMC42LTIwLjUtMjAuN1YyNC4yYzE3LjgsMC4yLDMyLjIsMTQuNSwzMi4yLDMyLjVWNjAuNXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfNV8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTUzLjc0MjgiIHkxPSI1NC41ODI2IiB4Mj0iMTU0LjMzOTciIHkyPSI2MC42NjM5Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojRTk0OTg2Ii8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6I0U5NDk4NjtzdG9wLW9wYWNpdHk6MCIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxsaW5lIGZpbGw9InVybCgjU1ZHSURfNV8pIiB4MT0iMTYwLjIiIHkxPSI2MC41IiB4Mj0iMTQ4LjUiIHkyPSI2MC41Ii8+Cgk8cmVjdCB4PSI4OS44IiB5PSIyNy40IiBmaWxsPSIjQzZDNkM2IiB3aWR0aD0iMTEuNyIgaGVpZ2h0PSI0MSIvPgoJPHJlY3QgeD0iMjYxIiBmaWxsPSIjQzZDNkM2IiB3aWR0aD0iMTEuNyIgaGVpZ2h0PSI0MSIvPgoJPHJlY3QgeD0iMTQ4LjUiIHk9IjYwLjUiIGZpbGw9IiNDNkM2QzYiIHdpZHRoPSIxMS43IiBoZWlnaHQ9IjQxIi8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzZfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjcxLjUyMyIgeTE9IjUzLjMzOTIiIHgyPSI2NC4xNjY0IiB5Mj0iNDAuNjk1MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMxRDk3NUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzZfKSIgZD0iTTY2LjEsNTYuN2gxMmMtMS40LTguMy01LjUtMTUuNi0xMS4yLTIxLjNsLTguMiw4LjRDNjIuMiw0Ny4zLDY0LjgsNTEuNyw2Ni4xLDU2Ljd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjYxLjIxODUiIHkxPSIzNy41MzgyIiB4Mj0iNDEuNzU0MyIgeTI9IjI5LjQ5MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzFEOTc1RCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzdfKSIgZD0iTTM5LjMsMzUuOWM3LjYsMCwxNC41LDMuMSwxOS41LDhsOC4zLTguM2MtNy4xLTcuMS0xNy0xMS41LTI3LjgtMTEuNWMtMC4xLDAtMC4yLDAtMC4zLDBMMzksMzUuOQoJCUMzOS4xLDM1LjksMzkuMiwzNS45LDM5LjMsMzUuOXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfOF8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTYuODgiIHkxPSIzNy44NjYyIiB4Mj0iMzYuNDk3NCIgeTI9IjI5LjUxMzUiPgoJCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiMzREE0NUYiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojMjg5QjVEIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF84XykiIGQ9Ik0zOS4zLDM1LjlWMjQuMmMtMTEsMC0yMC45LDQuNS0yOCwxMS43bDguNCw4LjJDMjQuNiwzOS4xLDMxLjYsMzUuOSwzOS4zLDM1Ljl6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzlfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjUuNDEwNCIgeTE9IjYwLjcyMzUiIHgyPSIxMy40NTY2IiB5Mj0iNDEuNDEyNiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzUwQUI2MCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMzREE0NUYiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzlfKSIgZD0iTTExLjcsNjMuNWMwLTcuNiwzLjEtMTQuNSw4LjEtMTkuNWwtOC4zLTguM0M0LjQsNDIuOCwwLDUyLjYsMCw2My41YzAsMC4xLDAsMC4yLDAsMC4zbDExLjctMC4xCgkJQzExLjcsNjMuNiwxMS43LDYzLjUsMTEuNyw2My41eiIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xMF8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iNS4zNTE0IiB5MT0iNjYuMzE5IiB4Mj0iMTMuNzA0MiIgeTI9Ijg1Ljc4MzIiPgoJCTxzdG9wICBvZmZzZXQ9IjAiIHN0eWxlPSJzdG9wLWNvbG9yOiM1MEFCNjAiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojNjdCNDYyIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMF8pIiBkPSJNMTEuNyw2My41SDBjMCwxMSw0LjUsMjAuOSwxMS43LDI4bDguMi04LjRDMTQuOSw3OC4xLDExLjcsNzEuMiwxMS43LDYzLjV6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzExXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxNS41MzYzIiB5MT0iODguNzAwMyIgeDI9IjM4LjMyMjkiIHkyPSI5OC4wMjIxIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNjdCNDYyIi8+CgkJPHN0b3AgIG9mZnNldD0iMC45NjIzIiBzdHlsZT0ic3RvcC1jb2xvcjojOTJDODg2Ii8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMV8pIiBkPSJNMzkuMyw5MWMtNy42LDAtMTQuNS0zLjEtMTkuNS04LjFsLTguMyw4LjNjNy4xLDcuMSwxNi45LDExLjUsMjcuOCwxMS41YzAuMSwwLDAuMiwwLDAuMywwCgkJTDM5LjUsOTFDMzkuNCw5MSwzOS40LDkxLDM5LjMsOTF6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzEyXyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIzOS4yNTg4IiB5MT0iMTA2LjQ5MTEiIHgyPSI2Mi4zNDI2IiB5Mj0iODEuMDUxNyI+CgkJPHN0b3AgIG9mZnNldD0iMC4zMjkiIHN0eWxlPSJzdG9wLWNvbG9yOiM5MkM4ODYiLz4KCQk8c3RvcCAgb2Zmc2V0PSIxIiBzdHlsZT0ic3RvcC1jb2xvcjojOTJDODg2O3N0b3Atb3BhY2l0eTowIi8+Cgk8L2xpbmVhckdyYWRpZW50PgoJPHBhdGggZmlsbD0idXJsKCNTVkdJRF8xMl8pIiBkPSJNNjEuMSw4MC4yYy01LDYuNi0xMywxMC44LTIxLjksMTAuOHYxMS43YzEyLjcsMCwyNC02LDMxLjItMTUuNEw2MS4xLDgwLjJ6Ii8+Cgk8cmVjdCB4PSIzNyIgeT0iNTYuNyIgZmlsbD0iI0M2QzZDNiIgd2lkdGg9IjQxIiBoZWlnaHQ9IjExLjciLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTNfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjI0Mi43NDExIiB5MT0iNTMuMzM5MiIgeDI9IjIzNS4zODQ2IiB5Mj0iNDAuNjk1MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzAwOEM1QSIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMxRDk3NUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzEzXykiIGQ9Ik0yMzcuMyw1Ni43aDEyYy0xLjQtOC4zLTUuNS0xNS42LTExLjItMjEuM2wtOC4yLDguNEMyMzMuNCw0Ny4zLDIzNiw1MS43LDIzNy4zLDU2Ljd6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE0XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyMzIuNDM2NyIgeTE9IjM3LjUzODIiIHgyPSIyMTIuOTcyNSIgeTI9IjI5LjQ5MiI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzFEOTc1RCIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE0XykiIGQ9Ik0yMTAuNSwzNS45YzcuNiwwLDE0LjUsMy4xLDE5LjUsOGw4LjMtOC4zYy03LjEtNy4xLTE3LTExLjUtMjcuOC0xMS41Yy0wLjEsMC0wLjIsMC0wLjMsMAoJCWwwLjEsMTEuN0MyMTAuMywzNS45LDIxMC40LDM1LjksMjEwLjUsMzUuOXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTVfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE4OC4wOTgxIiB5MT0iMzcuODY2MiIgeDI9IjIwNy43MTU2IiB5Mj0iMjkuNTEzNSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzNEQTQ1RiIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiMyODlCNUQiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE1XykiIGQ9Ik0yMTAuNSwzNS45VjI0LjJjLTExLDAtMjAuOSw0LjUtMjgsMTEuN2w4LjQsOC4yQzE5NS44LDM5LjEsMjAyLjgsMzUuOSwyMTAuNSwzNS45eiIvPgoJPGxpbmVhckdyYWRpZW50IGlkPSJTVkdJRF8xNl8iIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB4MT0iMTc2LjYyODYiIHkxPSI2MC43MjM1IiB4Mj0iMTg0LjY3NDgiIHkyPSI0MS40MTI2Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNTBBQjYwIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6IzNEQTQ1RiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMTZfKSIgZD0iTTE4Mi45LDYzLjVjMC03LjYsMy4xLTE0LjUsOC4xLTE5LjVsLTguMy04LjNjLTcuMSw3LjEtMTEuNSwxNi45LTExLjUsMjcuOGMwLDAuMSwwLDAuMiwwLDAuMwoJCWwxMS43LTAuMUMxODIuOSw2My42LDE4Mi45LDYzLjUsMTgyLjksNjMuNXoiLz4KCTxsaW5lYXJHcmFkaWVudCBpZD0iU1ZHSURfMTdfIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjE3Ni41Njk2IiB5MT0iNjYuMzE5IiB4Mj0iMTg0LjkyMjMiIHkyPSI4NS43ODMyIj4KCQk8c3RvcCAgb2Zmc2V0PSIwIiBzdHlsZT0ic3RvcC1jb2xvcjojNTBBQjYwIi8+CgkJPHN0b3AgIG9mZnNldD0iMSIgc3R5bGU9InN0b3AtY29sb3I6IzY3QjQ2MiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMTdfKSIgZD0iTTE4Mi45LDYzLjVoLTExLjdjMCwxMSw0LjUsMjAuOSwxMS43LDI4bDguMi04LjRDMTg2LjEsNzguMSwxODIuOSw3MS4yLDE4Mi45LDYzLjV6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE4XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIxODYuNzU0NCIgeTE9Ijg4LjcwMDMiIHgyPSIyMDkuNTQxIiB5Mj0iOTguMDIyMSI+CgkJPHN0b3AgIG9mZnNldD0iMCIgc3R5bGU9InN0b3AtY29sb3I6IzY3QjQ2MiIvPgoJCTxzdG9wICBvZmZzZXQ9IjAuOTYyMyIgc3R5bGU9InN0b3AtY29sb3I6IzkyQzg4NiIvPgoJPC9saW5lYXJHcmFkaWVudD4KCTxwYXRoIGZpbGw9InVybCgjU1ZHSURfMThfKSIgZD0iTTIxMC41LDkxYy03LjYsMC0xNC41LTMuMS0xOS41LTguMWwtOC4zLDguM2M3LjEsNy4xLDE2LjksMTEuNSwyNy44LDExLjVjMC4xLDAsMC4yLDAsMC4zLDAKCQlMMjEwLjcsOTFDMjEwLjcsOTEsMjEwLjYsOTEsMjEwLjUsOTF6Ii8+Cgk8bGluZWFyR3JhZGllbnQgaWQ9IlNWR0lEXzE5XyIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIHgxPSIyMTAuNDc2OSIgeTE9IjEwNi40OTExIiB4Mj0iMjMzLjU2MDgiIHkyPSI4MS4wNTE3Ij4KCQk8c3RvcCAgb2Zmc2V0PSIwLjMyOSIgc3R5bGU9InN0b3AtY29sb3I6IzkyQzg4NiIvPgoJCTxzdG9wICBvZmZzZXQ9IjEiIHN0eWxlPSJzdG9wLWNvbG9yOiM5MkM4ODY7c3RvcC1vcGFjaXR5OjAiLz4KCTwvbGluZWFyR3JhZGllbnQ+Cgk8cGF0aCBmaWxsPSJ1cmwoI1NWR0lEXzE5XykiIGQ9Ik0yMzIuNCw4MC4yYy01LDYuNi0xMywxMC44LTIxLjksMTAuOHYxMS43YzEyLjcsMCwyNC02LDMxLjItMTUuNEwyMzIuNCw4MC4yeiIvPgoJPHJlY3QgeD0iMjA4LjIiIHk9IjU2LjciIGZpbGw9IiNDNkM2QzYiIHdpZHRoPSI0MSIgaGVpZ2h0PSIxMS43Ii8+Cgk8Zz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMTUzLjIsMTMzLjJ2Ny45Yy0yLDAuOC0zLjksMS02LDFjLTQuNiwwLTcuMi0zLjYtNy4yLTguN2MwLTQuMywyLjMtOC43LDcuMi04LjdjMi44LDAsNS42LDEuNSw1LjksNC41CgkJCWgtMS43Yy0wLjMtMi4xLTIuMi0zLjEtNC4yLTMuMWMtNCwwLTUuNSwzLjktNS41LDcuM2MwLDQuMywxLjgsNy4zLDYuMyw3LjNjMS4zLDAsMi41LTAuMywzLjctMC43di01LjRoLTQuMnYtMS40SDE1My4yeiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0xNTguNiwxNDEuOGgtMS40di05YzAtMC45LTAuMS0xLjgtMC4xLTIuNmgxLjRsMC4xLDEuN2gwYzAuNC0xLjIsMS41LTIsMi42LTIuMWMwLjUsMCwwLjksMCwxLjQsMHYxLjMKCQkJYy0wLjMsMC0wLjYtMC4xLTAuOS0wLjFjLTIuMSwwLTMuMiwxLjUtMy4yLDMuN1YxNDEuOHoiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMTY1LjcsMTM2LjNjMCwyLjUsMS4yLDQuNiw0LDQuNmMxLjcsMCwzLTEuMiwzLjQtMi44aDEuNWMtMC43LDIuOC0yLjUsNC4xLTUuMyw0LjFjLTMuNSwwLTUuMS0zLTUuMS02LjIKCQkJYzAtMy4yLDEuNy02LjIsNS4yLTYuMmMzLjksMCw1LjMsMi45LDUuMyw2LjVIMTY1Ljd6IE0xNzMuMiwxMzVjLTAuMi0yLjMtMS40LTQtMy44LTRjLTIuMywwLTMuNSwxLjktMy43LDRIMTczLjJ6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTE3OC42LDEzNi4zYzAsMi41LDEuMiw0LjYsNCw0LjZjMS43LDAsMy0xLjIsMy40LTIuOGgxLjVjLTAuNywyLjgtMi41LDQuMS01LjMsNC4xYy0zLjUsMC01LjEtMy01LjEtNi4yCgkJCWMwLTMuMiwxLjctNi4yLDUuMi02LjJjMy45LDAsNS4zLDIuOSw1LjMsNi41SDE3OC42eiBNMTg2LjEsMTM1Yy0wLjItMi4zLTEuNC00LTMuOC00Yy0yLjMsMC0zLjUsMS45LTMuNyw0SDE4Ni4xeiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0xOTIuMSwxNDEuOGgtMS40di05YzAtMC45LTAuMS0xLjgtMC4xLTIuNmgxLjRsMC4xLDEuN2wwLDBjMC44LTEuNCwyLjEtMi4xLDMuNi0yLjEKCQkJYzMuOCwwLDQuMSwzLjQsNC4xLDQuN3Y3LjNoLTEuNHYtNy41YzAtMi0xLjItMy4yLTMuMS0zLjJjLTIuMywwLTMuMywxLjktMy4zLDRWMTQxLjh6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTIxMC42LDE0MS44VjEyNWg0LjJjMy4yLTAuMSw2LjksMC43LDYuOSw0LjdjMCw0LTMuNiw0LjgtNi45LDQuN2gtMi43djcuM0gyMTAuNnogTTIxMi4xLDEzMy4xaDMuNwoJCQljMi4zLDAsNC4zLTAuNyw0LjMtMy4zYzAtMi42LTItMy4zLTQuMy0zLjNoLTMuN1YxMzMuMXoiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMjMzLjEsMTM1LjljMCwzLjEtMS43LDYuMi01LjQsNi4yYy0zLjcsMC01LjQtMy4xLTUuNC02LjJzMS43LTYuMiw1LjQtNi4yCgkJCUMyMzEuNCwxMjkuOCwyMzMuMSwxMzIuOSwyMzMuMSwxMzUuOXogTTIyNy43LDEzMWMtMi44LDAtMy45LDIuNy0zLjksNC45czEuMSw0LjksMy45LDQuOWMyLjgsMCwzLjktMi43LDMuOS00LjkKCQkJUzIzMC41LDEzMSwyMjcuNywxMzF6Ii8+CgkJPHBhdGggZmlsbD0iIzAwOEM1QSIgZD0iTTIzOSwxMzkuOUwyMzksMTM5LjlsMy42LTkuOGgxLjZsMy40LDkuN2gwbDMuNC05LjdoMS41bC00LjMsMTEuN0gyNDdsLTMuNi0xMC4xaDBsLTMuNiwxMC4xaC0xLjQKCQkJbC00LjMtMTEuN2gxLjVMMjM5LDEzOS45eiIvPgoJCTxwYXRoIGZpbGw9IiMwMDhDNUEiIGQ9Ik0yNTUuMiwxMzYuM2MwLDIuNSwxLjIsNC42LDQsNC42YzEuNiwwLDMtMS4yLDMuNC0yLjhoMS41Yy0wLjcsMi44LTIuNSw0LjEtNS4zLDQuMWMtMy41LDAtNS4xLTMtNS4xLTYuMgoJCQljMC0zLjIsMS43LTYuMiw1LjItNi4yYzMuOSwwLDUuMywyLjksNS4zLDYuNUgyNTUuMnogTTI2Mi43LDEzNWMtMC4yLTIuMy0xLjQtNC0zLjgtNGMtMi4zLDAtMy41LDEuOS0zLjcsNEgyNjIuN3oiLz4KCQk8cGF0aCBmaWxsPSIjMDA4QzVBIiBkPSJNMjY4LjcsMTQxLjhoLTEuNHYtOWMwLTAuOS0wLjEtMS44LTAuMS0yLjZoMS40bDAuMSwxLjdoMGMwLjQtMS4yLDEuNS0yLDIuNi0yLjFjMC41LDAsMC45LDAsMS40LDB2MS4zCgkJCWMtMC4zLDAtMC42LTAuMS0wLjktMC4xYy0yLjEsMC0zLjIsMS41LTMuMiwzLjdWMTQxLjh6Ii8+Cgk8L2c+CjwvZz4KPC9zdmc+Cg==\" alt=\"Enel Green Power\">\r\n        </div>\r\n        <div class=\"header-info\">\r\n            <div class=\"title\">REPORTE DE PERMISO DE TRABAJO</div>\r\n            <div class=\"subtitle\">${permiso.numero_pt} - ${permiso.planta_nombre}</div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">INFORMACI\u00D3N GENERAL</div>\r\n        <div class=\"info-grid\">\r\n            <div>\r\n                <div class=\"info-item\"><span class=\"info-label\">N\u00FAmero PT:</span><span class=\"info-value\">${permiso.numero_pt || ''}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Planta:</span><span class=\"info-value\">${permiso.planta_nombre || ''}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Aerogenerador:</span><span class=\"info-value\">${permiso.aerogenerador_nombre || 'N/A'}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Estado:</span><span class=\"info-value\">${permiso.estado || ''}</span></div>\r\n            </div>\r\n            <div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Jefe de Faena:</span><span class=\"info-value\">${permiso.jefe_faena_nombre || ''}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Supervisor Responsable:</span><span class=\"info-value\">${permiso.supervisor_parque_nombre || 'N/A'}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Tipo:</span><span class=\"info-value\">${permiso.tipo_mantenimiento || ''}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Fecha Creaci\u00F3n:</span><span class=\"info-value\">${permiso.fecha_creacion || ''}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Aprobador Apertura:</span><span class=\"info-value\">${permiso.usuario_aprobador_apertura_nombre || permiso.usuario_aprobador || 'No aprobado'}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Aprobador Cierre:</span><span class=\"info-value\">${permiso.usuario_aprobador_cierre_nombre || 'No aprobado'}</span></div>\r\n                <div class=\"info-item\"><span class=\"info-label\">Estado Aprobaci\u00F3n Cierre:</span><span class=\"info-value\">${permiso.estado_aprobacion_cierre || 'PENDIENTE'}</span></div>\r\n            </div>\r\n        </div>\r\n        <div class=\"info-item\" style=\"margin-top: 15px;\">\r\n            <span class=\"info-label\">Descripci\u00F3n:</span>\r\n            <div class=\"description-content\">\r\n                ${permiso.descripcion || 'Sin descripci\u00F3n'}\r\n            </div>\r\n        </div>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">TIEMPOS DE TRABAJO (Hora Chile)</div>\r\n        <table class=\"table\">\r\n            <tr><th>Evento</th><th>Fecha y Hora</th></tr>\r\n            <tr><td>Creaci\u00F3n Permiso</td><td>${permiso.fecha_creacion || 'No registrado'}</td></tr>\r\n            <tr><td>Aprobaci\u00F3n Apertura</td><td>${permiso.fecha_aprobacion || 'No aprobado'}</td></tr>\r\n            <tr><td>Inicio de Trabajos</td><td>${permiso.fecha_inicio_trabajos || 'No registrado'}</td></tr>\r\n            <tr><td>Fin de Trabajos</td><td>${permiso.fecha_fin_trabajos || 'No registrado'}</td></tr>\r\n            <tr><td>Parada Turbina</td><td>${permiso.fecha_parada_turbina || 'No aplica'}</td></tr>\r\n            <tr><td>Puesta en Marcha</td><td>${permiso.fecha_puesta_marcha_turbina || 'No aplica'}</td></tr>\r\n            <tr><td>Cierre Permiso</td><td>${permiso.fecha_cierre || 'No cerrado'}</td></tr>\r\n            <tr><td>Aprobaci\u00F3n Cierre</td><td>${permiso.fecha_aprobacion_cierre || 'No aprobado'}</td></tr>\r\n        </table>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">PERSONAL ASIGNADO</div>\r\n        <table class=\"table\">\r\n            <tr><th>Nombre</th><th>Empresa</th><th>Rol</th></tr>\r\n            ${(personalResult.results || []).map(p => \r\n              `<tr><td>${p.personal_nombre}</td><td>${p.personal_empresa}</td><td>${p.personal_rol}</td></tr>`\r\n            ).join('')}\r\n            ${(personalResult.results || []).length === 0 ? '<tr><td colspan=\"3\" style=\"text-align: center;\">No hay personal registrado</td></tr>' : ''}\r\n        </table>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">ACTIVIDADES REALIZADAS</div>\r\n        <table class=\"table\">\r\n            <tr><th>Actividad</th><th>Tipo</th></tr>\r\n            ${(actividadesResult.results || []).map(a => \r\n              `<tr><td>${a.actividad_nombre}</td><td>${a.tipo_actividad}</td></tr>`\r\n            ).join('')}\r\n            ${(actividadesResult.results || []).length === 0 ? '<tr><td colspan=\"2\" style=\"text-align: center;\">No hay actividades registradas</td></tr>' : ''}\r\n        </table>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">MATERIALES UTILIZADOS</div>\r\n        <table class=\"table\">\r\n            <tr><th>Descripci\u00F3n</th><th>Cantidad</th><th>Propietario</th><th>Almac\u00E9n</th></tr>\r\n            ${(materialesResult.results || []).map(m => \r\n              `<tr><td>${m.descripcion}</td><td>${m.cantidad}</td><td>${m.propietario}</td><td>${m.almacen}</td></tr>`\r\n            ).join('')}\r\n            ${(materialesResult.results || []).length === 0 ? '<tr><td colspan=\"4\" style=\"text-align: center;\">No hay materiales registrados</td></tr>' : ''}\r\n        </table>\r\n    </div>\r\n    \r\n    <div class=\"section\">\r\n        <div class=\"section-title\">MATRIZ DE RIESGOS</div>\r\n        <table class=\"table\">\r\n            <tr><th style=\"width: 10%;\">C\u00F3digo</th><th style=\"width: 20%;\">Actividad</th><th style=\"width: 20%;\">Peligro</th><th style=\"width: 20%;\">Riesgo</th><th style=\"width: 30%;\">Medidas Preventivas</th></tr>\r\n            ${matrizRiesgosCompleta.map(m => \r\n              `<tr>\r\n                <td style=\"text-align: center;\">${m.codigo || 'N/A'}</td>\r\n                <td>${m.actividad}</td>\r\n                <td>${m.peligro}</td>\r\n                <td>${m.riesgo}</td>\r\n                <td>${m.medidas_preventivas}</td>\r\n              </tr>`\r\n            ).join('')}\r\n            ${matrizRiesgosCompleta.length === 0 ? '<tr><td colspan=\"5\" style=\"text-align: center;\">No hay matriz de riesgos disponible para las actividades seleccionadas</td></tr>' : ''}\r\n        </table>\r\n    </div>\r\n    \r\n    ${permiso.observaciones_cierre ? `\r\n    <div class=\"section\">\r\n        <div class=\"section-title\">OBSERVACIONES DE CIERRE</div>\r\n        <div class=\"observaciones-box\">\r\n            ${permiso.observaciones_cierre}\r\n        </div>\r\n    </div>\r\n    ` : ''}\r\n    \r\n    <div class=\"footer\">\r\n        <p>Documento generado el ${new Date().toLocaleString('es-CL', { timeZone: 'America/Santiago' })} - PT Wind - Sistema de Gesti\u00F3n de Permisos de Trabajo</p>\r\n        <p>\u00A9 Enel Green Power - Todos los derechos reservados</p>\r\n    </div>\r\n    \r\n    <script>\r\n        // Auto-imprimir despu\u00E9s de 2 segundos\r\n        setTimeout(() => {\r\n            if (confirm('\u00BFDesea imprimir el documento PDF ahora?')) {\r\n                window.print();\r\n            }\r\n        }, 2000);\r\n    </script>\r\n</body>\r\n</html>\r\n    `;\r\n    \r\n    // IMPORTANTE: Cambiar el Content-Type a text/html\r\n    return new Response(htmlContent, {\r\n      headers: {\r\n        'Content-Type': 'text/html; charset=utf-8',\r\n        'Content-Disposition': `inline; filename=\"PT_${permiso.numero_pt}_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.html\"`,\r\n        ...corsHeaders\r\n      }\r\n    });\r\n    \r\n  } catch (error) {\r\n    console.error('Error exportando PDF:', error);\r\n    return new Response(JSON.stringify({ error: error.message }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default {\r\n  handlePermisos,\r\n  handleAprobarPermiso,\r\n  handleCerrarPermiso,\r\n  handleAprobarCierrePermiso,\r\n  handleGenerateRegister,\r\n  handleHealth,\r\n  handleExportarPermisoExcel,\r\n  handleExportarPermisoPdf\r\n};\r\n\r\n", "// src/core/routes/api.js\r\nimport { handleLogin, handleChangePassword } from '../handlers/auth.js';\r\nimport {\r\n  handleUsers, handlePersonal, handlePersonalByParque, handleSupervisores,\r\n} from '../handlers/users.js';\r\nimport { handleParques, handleAerogeneradores, handleActividades } from '../handlers/catalog.js';\r\nimport { handleMatrizRiesgos } from '../handlers/matrix.js';\r\nimport {\r\n  handlePermisos, handlePermisoDetalle, handleAprobarPermiso, handleCerrarPermiso, handleObtenerDetalleAprobacion, handleAprobarCierrePermiso,\r\n  handleGenerateRegister, handleHealth, handleExportarPermisoExcel, handleExportarPermisoPdf,\r\n} from '../handlers/permits.js';\r\nimport generateTomaConocimientoPDF from '../handlers/pdf.js';\r\n\r\nexport async function handleApiRequest(request, corsHeaders, env, services) {\r\n  const { rateLimiter, authService, auditLogger } = services;\r\n  const url = new URL(request.url);\r\n  const endpoint = url.pathname.replace('/api/', '');\r\n  \r\n  try {\r\n    // Endpoints p\u00FAblicos que no requieren autenticaci\u00F3n\r\n    const publicEndpoints = ['login', 'health'];\r\n    let currentUser = null;\r\n    \r\n    // Verificar autenticaci\u00F3n para endpoints protegidos\r\n    if (!publicEndpoints.includes(endpoint)) {\r\n      const authHeader = request.headers.get('Authorization');\r\n      \r\n      if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n        return new Response(JSON.stringify({ \r\n          success: false,\r\n          error: 'No autorizado - Token requerido'\r\n        }), {\r\n          status: 401,\r\n          headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n        });\r\n      }\r\n      \r\n      const token = authHeader.substring(7);\r\n      try {\r\n        currentUser = await authService.verifyToken(token);\r\n        \r\n        // Verificar que el token tenga la estructura esperada\r\n        if (!currentUser || !currentUser.sub) {\r\n          throw new Error('Token inv\u00E1lido - estructura incorrecta');\r\n        }\r\n      } catch (error) {\r\n        return new Response(JSON.stringify({ \r\n          success: false,\r\n          error: 'Token inv\u00E1lido o expirado'\r\n        }), {\r\n          status: 401,\r\n          headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n        });\r\n      }\r\n    }\r\n    \r\n    switch (endpoint) {\r\n      case 'login':\r\n        return await handleLogin(request, corsHeaders, env, services);\r\n      case 'change-password':\r\n        return await handleChangePassword(request, corsHeaders, env, services);\r\n      case 'users':\r\n        return await handleUsers(request, corsHeaders, env);\r\n      case 'personal':\r\n        return await handlePersonal(request, corsHeaders, env);\r\n      case 'personal-by-parque':\r\n        return await handlePersonalByParque(request, corsHeaders, env, currentUser);\r\n      case 'supervisores':\r\n        return await handleSupervisores(request, corsHeaders, env, currentUser);\r\n      case 'parques':\r\n        return await handleParques(request, corsHeaders, env);\r\n      case 'aerogeneradores':\r\n        return await handleAerogeneradores(request, corsHeaders, env);\r\n      case 'matriz-riesgos':\r\n        return await handleMatrizRiesgos(request, corsHeaders, env);\r\n      case 'actividades':\r\n        return await handleActividades(request, corsHeaders, env);\r\n      case 'permisos':\r\n        return await handlePermisos(request, corsHeaders, env, currentUser, services);\r\n      case 'permiso-detalle':\r\n        return await handlePermisoDetalle(request, corsHeaders, env, currentUser, services);\r\n      case 'cerrar-permiso':\r\n        return await handleCerrarPermiso(request, corsHeaders, env, currentUser, services);\r\n      case 'aprobar-permiso':\r\n        return await handleAprobarPermiso(request, corsHeaders, env, currentUser, services);\r\n      case 'detalle-aprobacion':\r\n        return await handleObtenerDetalleAprobacion(request, corsHeaders, env, currentUser, services);\r\n      case 'aprobar-cierre-permiso':\r\n        return await handleAprobarCierrePermiso(request, corsHeaders, env, currentUser, services);\r\n      case 'generate-register':\r\n        return await handleGenerateRegister(request, corsHeaders, env);\r\n      case 'exportar-permiso-excel':\r\n        return await handleExportarPermisoExcel(request, corsHeaders, env, currentUser, services);\r\n      case 'exportar-permiso-pdf':\r\n        return await handleExportarPermisoPdf(request, corsHeaders, env, currentUser, services);\r\n      case 'health':\r\n        return await handleHealth(request, corsHeaders, env);\r\n      default:\r\n        return new Response(JSON.stringify({ error: 'Endpoint not found' }), {\r\n          status: 404,\r\n          headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n        });\r\n    }\r\n  } catch (error) {\r\n    return new Response(JSON.stringify({ \r\n      error: error.message,\r\n      endpoint: endpoint \r\n    }), {\r\n      status: 500,\r\n      headers: { 'Content-Type': 'application/json', ...corsHeaders }\r\n    });\r\n  }\r\n}\r\n\r\nexport default handleApiRequest;\r\n", "// src/index.js\r\nimport getStyles from './core/webapp/styles.js';\r\nimport getWebApp from './core/webapp/template.js';\r\nimport getWebAppScript from './core/webapp/script.js';\r\n\r\nimport SECURITY_CONFIG from './core/config/security.js';\r\nimport SecurityError from './core/errors.js';\r\n\r\nimport { getSecurityHeaders, getCorsHeaders } from './core/utils/headers.js';\r\n\r\nimport RateLimiter from './core/services/rateLimiter.js';\r\nimport AuthService from './core/services/authService.js';\r\nimport AuditLogger from './core/services/auditLogger.js';\r\nimport InputSanitizer from './core/utils/sanitizers.js';\r\n\r\n//import initializeDatabase from './core/db/init.js';\r\nimport handleApiRequest from './core/routes/api.js';\r\n\r\nexport default {\r\n  async fetch(request, env, ctx) {\r\n    // Asegura que existan las tablas (idempotente: usa IF NOT EXISTS)\r\n    //await initializeDatabase(env);\r\n\r\n    const corsHeaders = getCorsHeaders(env, request);\r\n    const secHeaders = getSecurityHeaders();\r\n\r\n    // Responder preflight CORS\r\n    if (request.method === 'OPTIONS') {\r\n      return new Response(null, { status: 204, headers: { ...corsHeaders } });\r\n    }\r\n\r\n    // Instancias compartidas\r\n    const rateLimiter = new RateLimiter(env);\r\n    const authService = new AuthService(env);\r\n    const auditLogger = new AuditLogger(env);\r\n\r\n    // Normalizamos nombres y dejamos alias para compatibilidad\r\n    const services = {\r\n      rateLimiter,\r\n      authService,\r\n      auditLogger,\r\n      InputSanitizer,\r\n      // alias (por si alg\u00FAn handler espera 'auth'/'audit')\r\n      auth: authService,\r\n      audit: auditLogger,\r\n      security: SECURITY_CONFIG,\r\n    };\r\n\r\n    try {\r\n      const url = new URL(request.url);\r\n      const { pathname } = url;\r\n\r\n      // WebApp\r\n      if (request.method === 'GET' && pathname === '/') {\r\n        return new Response(getWebApp(), {\r\n          headers: { 'content-type': 'text/html; charset=utf-8', ...secHeaders, ...corsHeaders },\r\n        });\r\n      }\r\n      if (request.method === 'GET' && pathname === '/styles.css') {\r\n        return new Response(getStyles(), {\r\n          headers: { 'content-type': 'text/css; charset=utf-8', ...secHeaders, ...corsHeaders },\r\n        });\r\n      }\r\n      if (request.method === 'GET' && pathname === '/app.js') {\r\n        return new Response(getWebAppScript(), {\r\n          headers: { 'content-type': 'application/javascript; charset=utf-8', ...secHeaders, ...corsHeaders },\r\n        });\r\n      }\r\n\r\n      // API\r\n      if (pathname.startsWith('/api/')) {\r\n        const resp = await handleApiRequest(request, corsHeaders, env, services);\r\n\r\n        // Garantiza CORS + security headers en cualquier respuesta del router\r\n        const merged = new Headers(resp.headers);\r\n        for (const [k, v] of Object.entries(corsHeaders)) merged.set(k, v);\r\n        for (const [k, v] of Object.entries(secHeaders)) merged.set(k, v);\r\n\r\n        // Nota: resp.body puede ser un ReadableStream; se reenv\u00EDa tal cual\r\n        return new Response(resp.body, { status: resp.status, headers: merged });\r\n      }\r\n\r\n      // 404\r\n      return new Response(JSON.stringify({ error: 'Not Found' }), {\r\n        status: 404,\r\n        headers: { 'content-type': 'application/json; charset=utf-8', ...secHeaders, ...corsHeaders },\r\n      });\r\n    } catch (err) {\r\n      const status = err instanceof SecurityError ? 403 : 500;\r\n      return new Response(JSON.stringify({ error: err?.message || 'Internal Error' }), {\r\n        status,\r\n        headers: { 'content-type': 'application/json; charset=utf-8', ...secHeaders, ...corsHeaders },\r\n      });\r\n    }\r\n  },\r\n};\r\n", "import type { Middleware } from \"./common\";\r\n\r\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\r\n\ttry {\r\n\t\treturn await middlewareCtx.next(request, env);\r\n\t} finally {\r\n\t\ttry {\r\n\t\t\tif (request.body !== null && !request.bodyUsed) {\r\n\t\t\t\tconst reader = request.body.getReader();\r\n\t\t\t\twhile (!(await reader.read()).done) {}\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\r\n\t\t}\r\n\t}\r\n};\r\n\r\nexport default drainBody;\r\n", "import type { Middleware } from \"./common\";\r\n\r\ninterface JsonError {\r\n\tmessage?: string;\r\n\tname?: string;\r\n\tstack?: string;\r\n\tcause?: JsonError;\r\n}\r\n\r\nfunction reduceError(e: any): JsonError {\r\n\treturn {\r\n\t\tname: e?.name,\r\n\t\tmessage: e?.message ?? String(e),\r\n\t\tstack: e?.stack,\r\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\r\n\t};\r\n}\r\n\r\n// See comment in `bundle.ts` for details on why this is needed\r\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\r\n\ttry {\r\n\t\treturn await middlewareCtx.next(request, env);\r\n\t} catch (e: any) {\r\n\t\tconst error = reduceError(e);\r\n\t\treturn Response.json(error, {\r\n\t\t\tstatus: 500,\r\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\r\n\t\t});\r\n\t}\r\n};\r\n\r\nexport default jsonError;\r\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\src\\\\index.js\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\src\\\\index.js\";\n\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\r\n// TODO: allow dispatching more events?\r\nexport type Dispatcher = (\r\n\ttype: \"scheduled\",\r\n\tinit: { cron?: string }\r\n) => Awaitable<void>;\r\n\r\nexport type IncomingRequest = Request<\r\n\tunknown,\r\n\tIncomingRequestCfProperties<unknown>\r\n>;\r\n\r\nexport interface MiddlewareContext {\r\n\tdispatch: Dispatcher;\r\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\r\n}\r\n\r\nexport type Middleware = (\r\n\trequest: IncomingRequest,\r\n\tenv: any,\r\n\tctx: ExecutionContext,\r\n\tmiddlewareCtx: MiddlewareContext\r\n) => Awaitable<Response>;\r\n\r\nconst __facade_middleware__: Middleware[] = [];\r\n\r\n// The register functions allow for the insertion of one or many middleware,\r\n// We register internal middleware first in the stack, but have no way of controlling\r\n// the order that addMiddleware is run in service workers so need an internal function.\r\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\r\n\t__facade_middleware__.push(...args.flat());\r\n}\r\nexport function __facade_registerInternal__(\r\n\t...args: (Middleware | Middleware[])[]\r\n) {\r\n\t__facade_middleware__.unshift(...args.flat());\r\n}\r\n\r\nfunction __facade_invokeChain__(\r\n\trequest: IncomingRequest,\r\n\tenv: any,\r\n\tctx: ExecutionContext,\r\n\tdispatch: Dispatcher,\r\n\tmiddlewareChain: Middleware[]\r\n): Awaitable<Response> {\r\n\tconst [head, ...tail] = middlewareChain;\r\n\tconst middlewareCtx: MiddlewareContext = {\r\n\t\tdispatch,\r\n\t\tnext(newRequest, newEnv) {\r\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\r\n\t\t},\r\n\t};\r\n\treturn head(request, env, ctx, middlewareCtx);\r\n}\r\n\r\nexport function __facade_invoke__(\r\n\trequest: IncomingRequest,\r\n\tenv: any,\r\n\tctx: ExecutionContext,\r\n\tdispatch: Dispatcher,\r\n\tfinalMiddleware: Middleware\r\n): Awaitable<Response> {\r\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\r\n\t\t...__facade_middleware__,\r\n\t\tfinalMiddleware,\r\n\t]);\r\n}\r\n", "// This loads all middlewares exposed on the middleware object and then starts\r\n// the invocation chain. The big idea is that we can add these to the middleware\r\n// export dynamically through wrangler, or we can potentially let users directly\r\n// add them as a sort of \"plugin\" system.\r\n\r\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\.wrangler\\\\tmp\\\\bundle-wIpu4e\\\\middleware-insertion-facade.js\";\r\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\r\nimport type { WorkerEntrypointConstructor } from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\.wrangler\\\\tmp\\\\bundle-wIpu4e\\\\middleware-insertion-facade.js\";\r\n\r\n// Preserve all the exports from the worker\r\nexport * from \"C:\\\\Users\\\\CL163284391\\\\Documents\\\\GitHub_Projects\\\\ptwind\\\\PERMISO_TRABAJO_WTG\\\\.wrangler\\\\tmp\\\\bundle-wIpu4e\\\\middleware-insertion-facade.js\";\r\n\r\nclass __Facade_ScheduledController__ implements ScheduledController {\r\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\r\n\r\n\tconstructor(\r\n\t\treadonly scheduledTime: number,\r\n\t\treadonly cron: string,\r\n\t\tnoRetry: ScheduledController[\"noRetry\"]\r\n\t) {\r\n\t\tthis.#noRetry = noRetry;\r\n\t}\r\n\r\n\tnoRetry() {\r\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\r\n\t\t\tthrow new TypeError(\"Illegal invocation\");\r\n\t\t}\r\n\t\t// Need to call native method immediately in case uncaught error thrown\r\n\t\tthis.#noRetry();\r\n\t}\r\n}\r\n\r\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\r\n\t// If we don't have any middleware defined, just return the handler as is\r\n\tif (\r\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\r\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\r\n\t) {\r\n\t\treturn worker;\r\n\t}\r\n\t// Otherwise, register all middleware once\r\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\r\n\t\t__facade_register__(middleware);\r\n\t}\r\n\r\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\r\n\t\trequest,\r\n\t\tenv,\r\n\t\tctx\r\n\t) {\r\n\t\tif (worker.fetch === undefined) {\r\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\r\n\t\t}\r\n\t\treturn worker.fetch(request, env, ctx);\r\n\t};\r\n\r\n\treturn {\r\n\t\t...worker,\r\n\t\tfetch(request, env, ctx) {\r\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\r\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\r\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\r\n\t\t\t\t\t\tDate.now(),\r\n\t\t\t\t\t\tinit.cron ?? \"\",\r\n\t\t\t\t\t\t() => {}\r\n\t\t\t\t\t);\r\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction wrapWorkerEntrypoint(\r\n\tklass: WorkerEntrypointConstructor\r\n): WorkerEntrypointConstructor {\r\n\t// If we don't have any middleware defined, just return the handler as is\r\n\tif (\r\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\r\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\r\n\t) {\r\n\t\treturn klass;\r\n\t}\r\n\t// Otherwise, register all middleware once\r\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\r\n\t\t__facade_register__(middleware);\r\n\t}\r\n\r\n\t// `extend`ing `klass` here so other RPC methods remain callable\r\n\treturn class extends klass {\r\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\r\n\t\t\trequest,\r\n\t\t\tenv,\r\n\t\t\tctx\r\n\t\t) => {\r\n\t\t\tthis.env = env;\r\n\t\t\tthis.ctx = ctx;\r\n\t\t\tif (super.fetch === undefined) {\r\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\r\n\t\t\t}\r\n\t\t\treturn super.fetch(request);\r\n\t\t};\r\n\r\n\t\t#dispatcher: Dispatcher = (type, init) => {\r\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\r\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\r\n\t\t\t\t\tDate.now(),\r\n\t\t\t\t\tinit.cron ?? \"\",\r\n\t\t\t\t\t() => {}\r\n\t\t\t\t);\r\n\t\t\t\treturn super.scheduled(controller);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\r\n\t\t\treturn __facade_invoke__(\r\n\t\t\t\trequest,\r\n\t\t\t\tthis.env,\r\n\t\t\t\tthis.ctx,\r\n\t\t\t\tthis.#dispatcher,\r\n\t\t\t\tthis.#fetchDispatcher\r\n\t\t\t);\r\n\t\t}\r\n\t};\r\n}\r\n\r\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\r\nif (typeof ENTRY === \"object\") {\r\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\r\n} else if (typeof ENTRY === \"function\") {\r\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\r\n}\r\nexport default WRAPPED_ENTRY;\r\n"],
  "mappings": ";;;;AAAA,IAAM,OAAO,oBAAI,IAAI;AAErB,SAAS,SAAS,SAAS,MAAM;AAChC,QAAM,MACL,mBAAmB,MAChB,UACA,IAAI;AAAA,KACH,OAAO,YAAY,WACjB,IAAI,QAAQ,SAAS,IAAI,IACzB,SACD;AAAA,EACH;AACH,MAAI,IAAI,QAAQ,IAAI,SAAS,SAAS,IAAI,aAAa,UAAU;AAChE,QAAI,CAAC,KAAK,IAAI,IAAI,SAAS,CAAC,GAAG;AAC9B,WAAK,IAAI,IAAI,SAAS,CAAC;AACvB,cAAQ;AAAA,QACP;AAAA,KACO,IAAI,SAAS;AAAA;AAAA,MACrB;AAAA,IACD;AAAA,EACD;AACD;AAnBS;AAqBT,WAAW,QAAQ,IAAI,MAAM,WAAW,OAAO;AAAA,EAC9C,MAAM,QAAQ,SAAS,UAAU;AAChC,UAAM,CAAC,SAAS,IAAI,IAAI;AACxB,aAAS,SAAS,IAAI;AACtB,WAAO,QAAQ,MAAM,QAAQ,SAAS,QAAQ;AAAA,EAC/C;AACD,CAAC;;;AC7BD,SAAS,0BAA0B,OAAO,MAAM;AAC/C,QAAM,UAAU,IAAI,QAAQ,OAAO,IAAI;AACvC,UAAQ,QAAQ,OAAO,kBAAkB;AACzC,SAAO;AACR;AAJS;AAMT,WAAW,QAAQ,IAAI,MAAM,WAAW,OAAO;AAAA,EAC9C,MAAM,QAAQ,SAAS,UAAU;AAChC,WAAO,QAAQ,MAAM,QAAQ,SAAS;AAAA,MACrC,0BAA0B,MAAM,MAAM,QAAQ;AAAA,IAC/C,CAAC;AAAA,EACF;AACD,CAAC;;;ACLM,SAAS,YAAY;AAC1B,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAm9CT;AAp9CgB;AAs9ChB,IAAO,iBAAQ;;;ACx9CR,SAAS,kBAAkB;AAChC,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA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",
  "names": ["InputSanitizer"]
}
